<!DOCTYPE html> 
<html lang="ua">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NUAM Albums</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" crossorigin="anonymous"></script>
  <style>
    @font-face {
      font-family: 'CustomFont';
      src: url('https://static.wixstatic.com/ufonts/c77f36_8e332f6e48954416a7131ece2e2fab0f/woff2/file.woff2') format('woff2');
    }

    html,
    body {
      font-family: 'CustomFont', Arial, sans-serif;
      background-color: #282626;
      margin: 0;
      padding: 0;
    }

    h1 {
      margin-top: 20px;
      color: #f3f3f3;
    }

    h4 {
      text-align: center;
      margin-top: 20px;
      color: #f3f3f3;
    }

    body::-webkit-scrollbar {
      width: 10px;
    }
    body::-webkit-scrollbar-track {
      background: #282626;
    }
    body::-webkit-scrollbar-thumb {
      background-color: #383838;
      border-radius: 7px;
      border: 2px solid #282626;
    }

    body::-webkit-scrollbar-button {
      display: none;
    }

    body.no-scroll {
      position: fixed;
      width: 100%;
      overflow-y: scroll;
    }

    #loading-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #282626;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 1;
  transition: opacity 0.6s ease;
}

#loading-screen.hidden {
  opacity: 0;
  pointer-events: none;
}

    #loading-screen img {
  max-width: 50%;
  margin-bottom: 20px;
}
    
.load-wrapp { 
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 20px;
}

.load-10 {
  display: flex;
  justify-content: flex-start;
}

.bar { 
  width: 15px;
  height: 6px;
  border-radius: 2px;
  background-color: #88c8dc;
  margin: 0 5px;
  animation: loadingJ 2s cubic-bezier(0.17, 0.37, 0.43, 0.67) infinite;
}

@keyframes loadingJ {
  0% {
    transform: translateX(-38.75px);
  }

  50% {
    transform: translateX(38.75px);
    background-color: #d5da8d;
    width: 25px;
  }

  100% {
    transform: translateX(-38.75px);
  }
}

.loading-text {
  color: #f1f1f1;
  font-size: 18px;
  margin-top: 20px;
  font-family: 'CustomFont', sans-serif;
}

    .checkbox-container::-webkit-scrollbar {
      width: 14px;
    }
    .checkbox-container::-webkit-scrollbar-track {
      background: transparent;
    }
    .checkbox-container::-webkit-scrollbar-thumb {
      background-color: #282626;
      border-radius: 7px;
      border: 3px solid #383838;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      appearance: none;
      border: 1px solid rgba(132, 170, 251, 0.5);
      border-radius: 4px;
      background-color: #383838;
      display: inline-block;
      position: relative;
      vertical-align: middle;
      margin-right: 8px;
      transition: border-color 0.3s ease;
    }
    input[type="checkbox"]:hover {
  border-color: rgba(132, 170, 251, 1);
}
    input[type="checkbox"]:checked {
      background-color: #84AAFB;
      border-color: #84AAFB;
    }
    input[type="checkbox"]:checked::after {
      content: '\2713';
      color: #282626;
      font-size: 12px;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    #albums-container .separator {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  margin: 20px 0 20px;
  box-sizing: border-box;
}

#albums-container .separator .line {
  flex: 1;
  height: 2px;
  background-color: #383636;
  border: none;
}

#albums-container .separator .sep-text {
  margin: 0 10px;
  color: #f3f3f3;
  white-space: nowrap;
}

    #genre-checkboxes {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      padding-bottom: 10px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 460px;
      min-width: 260px;
      height: 100vh;
      padding: 20px 10px 20px;
      gap: 20px;
      overflow-y: auto;
      position: fixed;
      top: 0;
      left: 0;
      background: #282626;
      box-shadow: 2px 0 5px rgba(0, 0, 0, .25);
      z-index: 1000;
      user-select: none !important;
    }
    .controls::-webkit-scrollbar {
      width: 10px;
    }
    .controls::-webkit-scrollbar-track {
      background: #282626;
    }
    .controls::-webkit-scrollbar-thumb {
      background: #383838;
      border-radius: 7px;
      border: 2px solid #282626;
    }

    .filter-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    .filter-group {
      display: flex;
      flex-direction: row;
      gap: 20px;
      width: 100%;
      align-items: flex-start;
    }
    .filter-group .checkbox-container {
      flex: 1;
      min-width: 0;
    }

    .checkbox-container {
      background: #383838;
      border-radius: 7px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 200px;
      overflow-y: auto;
      position: relative;
    }
    .checkbox-container label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: #f3f3f3;
    }
    .checkbox-container .section-title {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #282626;
      border-bottom: 1px solid #383838;
      font-size: 16px;
      text-align: left;
      color: #f3f3f3;
      border-radius: 7px;
    }
    .checkbox-grid {
      display: flex;
      flex-direction: column;
    }

    .genre-name,
    .language-name,
    .release-type-filter-item {
      font-size: 14px;
    }
    .genre-count,
    .language-count {
      color: gray;
      font-size: 12px;
    }

    .sort-and-blacklist {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
    }
    .sort-section {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    #sort-order {
  cursor: pointer;
}
    .sort-section select {
      width: 100%;
    }
    .sort-section label {
  flex-shrink: 0;
  white-space: nowrap;
}

.sort-section .custom-select {
  flex-grow: 1;
}
    
.custom-select.upward .options-container {
  top: auto;
  bottom: 100%;
  border-radius: 7px 7px 0 0;
  width: calc(100% + 2px);
}
.custom-select.upward.open {
  border-radius: 0 0 7px 7px;
}

    .hide-listened-section {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 10px;
  background-color: #383838;
  border-radius: 7px;
  justify-content: flex-start;
}

    .hide-listened-section label {
      align-items: center;
      gap: 8px;
    }

.blacklist-row {
  display: flex;
  gap: 10px;
  align-items: center;
}

.blacklist-row .blacklist-section {
  flex: none;
}

.blacklist-row .hide-listened-section {
  flex: 1;
  height: 37px;
  background-color: #383838;
  display: flex;
  align-items: center;
  padding: 0 10px;
  border-radius: 7px;
  gap: 8px;
}

.blacklist-row #show-listened-albums {
  cursor: pointer;
  text-decoration: underline;
}

.filter-group {
  display: flex;
  gap: 20px;
  align-items: stretch;
}

.release-column {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.release-column .checkbox-container {
  flex: none;
}

.release-column .hide-listened-section {
  margin-top: auto;
  height: 37px;
  background-color: #383838;
  display: flex;
  align-items: center;
  padding: 0 10px;
  border-radius: 7px;
  gap: 8px;
}

    .blacklist-container {
      display: flex;
      gap: 20px;
    }
    .blacklist-artists,
    .blacklist-labels {
      flex: 1;
      max-height: 300px;
      overflow-y: auto;
      background-color: #282626;
      padding: 10px;
      border-radius: 7px;
    }
    .blacklist-artists h4,
    .blacklist-labels h4 {
      position: sticky;
      top: 0;
      background-color: #383838;
      padding: 10px;
      margin: 0;
      border-radius: 7px;
      z-index: 1;
    }
    .blacklist-artists ul,
    .blacklist-labels ul {
      list-style-type: none;
      padding: 0;
      margin-top: 20px;
      color: #f3f3f3;
    }
    .blacklist-artists li,
    .blacklist-labels li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
    }

    .blacklist-section {
      
    }
.blacklist-artists::-webkit-scrollbar-thumb,
.blacklist-labels::-webkit-scrollbar-thumb {
  border: 3px solid #282626 !important;
  background-color: #383838;
}

    .favorites-section {

}

.favorite-button {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 11;
  cursor: pointer;
  padding: 5px;
  background-color: #282626;
  border-radius: 7px;
  border: 1px solid rgba(132, 170, 251, 0.5);
  box-shadow: 0 4px 6px rgba(0, 0, 0, .3);
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.1s ease, border-color 0.3s ease;
  pointer-events: none;
  display: flex;
  align-items: center;
  justify-content: center;
}
.favorite-button:hover {
border-color: rgba(132, 170, 251, 1);
}

.album:hover .favorite-button {
  opacity: 1;
  transform: none;
  pointer-events: auto;
}

.favorite-button.clicked .favorite-icon {
  transform: scale(1.15);
}

.favorite-checkmark {
  position: absolute;
  top: 55%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 14px;
  color: #282626;
  font-weight: bold;
  display: none;
  z-index: 12;
  pointer-events: none;
}

.favorite-button svg {
  width: 100%;
  height: 100%;
}

    .listened-albums-container {
      max-height: 300px;
      overflow-y: auto;
      background-color: #383838;
      padding: 10px;
      border-radius: 7px;
    }
    .listened-albums-container ul {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      list-style-type: none;
      padding: 0;
      margin: 0;
      color: #f3f3f3;
    }
    .listened-albums-container li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 10px;
      background-color: #282626;
      border-radius: 5px;
    }
    .listened-albums-container a {
      color: #f3f3f3;
      text-decoration: none;
    }
    .listened-albums-container a:hover {
      text-decoration: underline;
    }
    .listened-albums-container .blacklist-cross {
      cursor: pointer;
      color: #c0392b;
      font-size: 16px;
    }
    .listened-albums-container .blacklist-cross:hover {
      color: #e74c3c;
    }
    .listened-albums-container::-webkit-scrollbar {
      width: 10px;
    }
    .listened-albums-container::-webkit-scrollbar-track {
      background: #383838;
    }
    .listened-albums-container::-webkit-scrollbar-thumb {
      background: #282626;
      border-radius: 7px;
    }

    label,
    select,
    button {
      color: #f3f3f3;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1;
    }

    .custom-select {
  position: relative;
  width: 100%;
  background-color: #383838;
  border: 1px solid rgba(132, 170, 251, 0.5);
  border-radius: 7px;
  font-family: 'CustomFont', Arial, sans-serif;
  user-select: none;
  transition: border-color 0.3s ease;
}
.custom-select:hover {
  border-color: rgba(132, 170, 251, 1);
}
    
.custom-select.open {
  border-radius: 7px 7px 0 0;
  border: 1px solid rgba(132, 170, 251, 1);
}

    .custom-select,
.custom-select .options-container {
  box-sizing: border-box;
  width: 100%;
}

.custom-select .selected {
  padding: 5px;
  cursor: pointer;
  color: #f3f3f3;
  font-size: 14px;
}

.custom-select .options-container {
  position: absolute;
  top: 100%;
  left: -1px;
  width: calc(100% + 2px);
  background-color: #383838;
  border-top: none;
  border-left: 1px solid rgba(132, 170, 251, 1);
  border-right: 1px solid rgba(132, 170, 251, 1);
  border-bottom: 1px solid rgba(132, 170, 251, 1);
  border-radius: 0 0 7px 7px;
  font-size: 14px;
  display: none;
  flex-direction: column;
  z-index: 10;
}
    
.custom-select .option {
  padding: 4px;
  cursor: pointer;
  color: #f3f3f3;
}

.custom-select .option:hover {
  background-color: #282626;
}
    
.custom-select,
.custom-select .options-container {
  box-sizing: border-box;
}

    .custom-select,
.custom-select .options-container {
  box-sizing: border-box;
}

    .custom-select .option:last-child:hover {
  border-bottom-left-radius: 7px;
  border-bottom-right-radius: 7px;
}
    
    button {
      padding: 10px 20px;
      background-color: #84AAFB;
      color: #282626;
      border: 1px solid #84AAFB;
      border-radius: 7px;
      cursor: pointer;
      transition: border 0.3s ease;
    }
    button:hover {
      border: 1px solid #f3f3f3;
    }

    #albums-container {
      margin-left: 480px;
      padding: 25px 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      user-select: none !important;
      align-items: start;
    }

    .album {
      background-color: #383838;
      border-radius: 7px;
      overflow: visible;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
      display: flex;
      flex-direction: column;
      min-width: 400px;
      max-width: 500px;
    }
    .album img {
      width: 100%;
      height: auto;
      cursor: pointer;
      transition: transform 0.3s ease, z-index 0.3s ease;
      border-radius: 7px;
      backface-visibility: hidden;
  transform-style: preserve-3d;
  will-change: transform;
    }
    .album img:hover {
      transform: scale(1.01);
      z-index: 10;
    }

    .album-details {
      padding: 15px;
      flex-grow: 1;
      background-color: #383838;
    }
    .album-details h3 {
      margin: 0 0 10px 0;
      color: #f3f3f3;
    }
    .album-details p {
      margin: 5px 0;
      color: #f3f3f3;
    }
    .album-details a {
      color: #f3f3f3;
      text-decoration: none;
      font-weight: bold;
    }
    .album-details a:hover {
      text-decoration: underline;
    }

    .album .album-links {
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.album:hover .album-links {
  opacity: 1;
}

.album .album-links a {
  display: flex;
  width: 20px;
  height: 20px;
  position: relative;
}

.album .album-links .icon-default,
.album .album-links .icon-hover {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.album .album-links .icon-hover {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.album .album-links a:hover .icon-hover {
  opacity: 1;
}

.album .album-links a:hover .icon-default {
  opacity: 0;
}

    .spotify-icon {
  flex-shrink: 0;
}
    
.album a .spotify-icon {
  display: flex;
  width: 20px;
  height: 20px;
  position: relative;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.album:hover a .spotify-icon {
  opacity: 1;
}

.album a .spotify-icon .icon-default,
.album a .spotify-icon .icon-hover {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.album a .spotify-icon .icon-hover {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.album a .spotify-icon:hover .icon-hover {
  opacity: 1;
}

.album a .spotify-icon:hover .icon-default {
  opacity: 0;
}

    .favorite-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  transition: transform 0.15s ease;
}

    .favorite-icon-wrapper {
  position: absolute;
  top: 10px;
  left: 10px;
  font-size: 24px;
  z-index: 11;
  display: none;
}

.album:hover .favorite-icon-wrapper {
  display: block;
}

.favorite-icon-wrapper svg {
  width: 24px;
  height: 24px;
  cursor: pointer;
}

    .tracks {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: auto;
      padding: 0 15px 15px;
      align-items: flex-start;
    }

    .track-circle {
      width: 40px;
      height: 40px;
      color: #f3f3f3;
      background-color: transparent;
      border-radius: 50%;
      border: 1px solid rgba(132, 170, 251, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      position: relative;
    }

    .track-circle:hover {
      background-color: #282626;
      border-color: rgba(132, 170, 251, 1);
    }
    .track-circle i {
      font-size: 20px;
      color: #555;
    }

    .lazy-loading {
      text-align: center;
      margin: 20px 0;
      color: #f3f3f3;
      user-select: none !important;
    }

    audio {
      display: none;
    }

    .album-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(40, 38, 38, 0.7);
      display: none;
      pointer-events: none;
      z-index: 1;
    }
    .album-listened .album-overlay {
      display: block;
    }
    .album-listened img:hover {
      background-color: rgba(40, 38, 38, 0.7);
      transform: none !important;
  z-index: auto !important;
    }

    .mark-listened-btn {
      cursor: pointer;
      padding: 5px 10px;
      background-color: #84AAFB;
      color: #282626;
      border: 1px solid #84AAFB;
      border-radius: 7px;
      align-self: flex-start;
      transition: border 0.3s ease;
      z-index: 9;
    }
    .mark-listened-btn:hover {
      border: 1px solid #f3f3f3;
    }

    .enlarged-img {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 640px;
      z-index: 1000;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
      user-select: none !important;
    opacity: 0;
  transition: opacity 0.3s ease;
}
.enlarged-img.shown {
  opacity: 1;
}

    .modal-overlay,
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }

    .modal-content {
      background-color: #383838;
      margin: 15% auto;
      padding: 20px;
      border-radius: 7px;
      width: 80%;
      user-select: none !important;
    }
    .modal-content h3 {
      color: #f3f3f3;
     margin-top: 0;
    margin-bottom: 10px;
    }

    .tabcontent {
      display: none;
    }
    .tabcontent.active {
      display: block;
    }
    .tablink {
      background-color: #282626;
      color: #f3f3f3;
      padding: 10px 20px;
      border: 1px solid #f3f3f3;
      cursor: pointer;
      transition: border-color 0.3s ease, background-color 0.3s ease;
      font-weight: bold;
      margin-bottom: 20px;
      margin-right: 10px;
    }
    .tablink.active {
      background-color: #84AAFB;
      border: 1px solid #84AAFB;
      color: #282626;
    }
    .tablink.active:hover {
      background-color: #84AAFB;
    }
    .tablink:hover {
      background-color: #282626;
      border: 1px solid #84AAFB;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .close:hover,
    .close:focus {
      color: #f3f3f3;
      text-decoration: none;
      cursor: pointer;
    }

    .album-details .blacklist-cross {
      display: none;
    }
    .album-details:hover .blacklist-cross {
      display: inline;
    }
    .blacklist-cross {
      cursor: pointer;
      color: #c0392b;
      font-size: 12px;
      font-weight: bold;
    }
    .blacklist-cross:hover {
      color: #e74c3c;
    }

    .export-import-container {
      display: flex;
      gap: 20px;
      justify-content: space-between;
    }
    .export-section,
    .import-section {
      flex: 1;
    }

    textarea {
  width: 500px;
  height: 200px;
  padding: 10px;
  background-color: #282626;
      border-radius: 7px;
  border: 1px solid rgba(132, 170, 251, 0.5);
  resize: none;
  color: #f3f3f3;
  scrollbar-width: auto;
  scrollbar-color: auto;
      transition: border-color 0.3s ease;
}
    textarea:hover {
  border-color: rgba(132, 170, 251, 1);
}
textarea::-webkit-scrollbar {
  width: 14px;
}
textarea::-webkit-scrollbar-track {
  background: transparent;
}
textarea::-webkit-scrollbar-thumb {
  background-color: #383838;
  border-radius: 7px;
  border: 3px solid #282626;
}
textarea:focus {
  outline: none;
}

    #export-data,
    #import-data {
      margin-top: 0;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background-color: #4CAF50;
      color: #f3f3f3;
      border: none;
      border-radius: 5px;
      width: fit-content;
      vertical-align: middle;
      transition: background-color 0.3s;
    }
    #export-data:hover,
    #import-data:hover {
      background-color: #388e3c;
    }

    #export-message,
#import-message {
  font-size: 13px;
  display: flex;
  align-items: center;
}

    #export-message.success,
#import-message.success {
  color: #7dc77d;
}

#export-message.error,
#import-message.error {
  color: #e74c3c;
}
    
    #favorites-albums-list li {
  display: flex;
  align-items: center;
  gap: 8px;
}
#favorites-albums-list li img {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 4px;
}
    
#favorites-albums-list a {
  text-decoration: none;
  transition: text-decoration 0.2s;
}
#favorites-albums-list a:hover {
  text-decoration: underline;
}
 
    .button-line {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}
    
    .exclude-genre,
    .exclude-language {
      cursor: pointer;
      color: #c0392b;
      margin-left: 5px;
      font-size: 12px;
      font-weight: bold;
    }
    .exclude-genre:hover,
    .exclude-language:hover {
      color: #e74c3c;
    }

    .genre-filter-item .exclude-genre {
      visibility: hidden;
    }
    .genre-filter-item:hover .exclude-genre {
      visibility: visible;
    }
    .language-filter-item .exclude-language {
      display: none;
    }
    .language-filter-item:hover .exclude-language {
      display: inline;
    }
    .repeat-symbol,
    .language-repeat-symbol {
      color: #7dc77d;
    }
    .repeat-symbol:hover,
    .language-repeat-symbol:hover {
      color: #90EE90;
    }

    .star-icon {
      background-color: #282626;
      border-radius: 7px;
      padding: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, .3);
    }

    .section-title {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #282626;
      padding: 8px 12px;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #383838;
    }

    .genre-header {
      padding: 10px 12px;
      background-color: #282626;
      font-size: 18px;
    }
    .genre-buttons {
      display: flex;
      gap: 5px;
    }
    .genre-buttons button {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 5px;
      background-color: #84AAFB;
      color: #282626;
      border: 1px solid #84AAFB;
      cursor: pointer;
      transition: border 0.3s ease;
    }
    .genre-buttons button:hover {
      border: 1px solid #f3f3f3;
    }

    .track-tooltip {
      display: none;
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #f3f3f3;
      padding: 5px 10px;
      border-radius: 7px;
      font-size: 12px;
      white-space: normal;
      min-width: 160px;
      text-align: center;
      z-index: 100;
    }

    .alb-head {
      display: flex;
      gap: 12px;
      margin-bottom: 6px;
    }
    .rls-icon {
      width: 45px;
      height: 45px;
      flex-shrink: 0;
    }
    .alb-head-txt h3 {
      margin: 0;
      color: #f3f3f3;
      font-size: 18px;
    }
    .alb-head-txt .alb-artist,
    .alb-head-txt {
      margin: 2px 0 0;
      color: #f3f3f3;
      font-size: 14px;
    }
    .alb-genres {
      font-size: 12px;
      margin: 2px 0 0;
      color: #f3f3f3;
    }
    .alb-artist {
      font-weight: bold;
    }
.alb-artist a:hover {
  text-decoration: underline !important;
}

    .alb-sep {
      border: 0;
      border-top: 1px solid #555;
      margin: 10px 0;
    }

    .alb-meta,
    .alb-listens {
      display: flex;
      flex-wrap: wrap;
      font-size: 14px;
      color: #f3f3f3;
    }
    .alb-listens {
      gap: 6px;
    }
    .alb-meta p {
      width: 50%;
      box-sizing: border-box;
      display: flex;
      gap: 6px;
    }
    .alb-meta p svg,
    .alb-listens svg,
    .alb-meta svg {
      flex-shrink: 0;
      display: block;
    }

    .alb-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    } 

    .album-cover-wrapper {
  width: 100%;
  aspect-ratio: 1 / 1;
  background-color: #333;
  border-radius: 7px;
  position: relative;
}

.album-cover-wrapper img.album-cover {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
    
    .controls,
.modal-content,
.controls * ,
.modal-content * {
  overscroll-behavior: none;
}

    #label-select .options-container {
  max-height: 500px;
  display: none;
  flex-direction: column-reverse;
  border-left: 1px solid #84AAFB;
      border-right: 1px solid #84AAFB;
      border-top: 1px solid #84AAFB;
      border-bottom: none;
  background: #383838;
  position: absolute;
  width: calc(100% + 2px);
  z-index: 99;
}

    #label-select .options-container {
  overflow: hidden;
}

#label-select .option-list {
  overflow-y: auto;
}

#label-select .option-fixed {
  flex-shrink: 0;
  padding-top: 4px;
  padding-bottom: 4px;
  background: #383838;
  border-top: 1px solid #84AAFB;
  display: flex;
  flex-direction: column;
}

#label-select .option-search {
  padding: 8px;
  background: #282626;
  color: #f3f3f3;
  border-top: 1px solid rgba(132, 170, 251, 0.5);
  border-bottom: 1px solid rgba(132, 170, 251, 0.5);
  border-left: none;
  border-right: none;
  transition: border 0.3s ease;
}
    
    #label-select .option-search:hover {
  border-top: 1px solid rgba(132, 170, 251, 1);
  border-bottom: 1px solid rgba(132, 170, 251, 1);
}

    #label-select .option-search:focus {
  outline: none;
  box-shadow: none;
}

#label-select .option-list {
  overflow-y: auto;
  max-height: 460px;

}

#label-select .option-list .option:first-child {
  border-top-left-radius: 7px;
}

#label-select .option-list .option:last-child {
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

#label-select .option-list::-webkit-scrollbar {
  width: 14px;
}

#label-select .option-list::-webkit-scrollbar-track {
  background: transparent;
}

#label-select .option-list::-webkit-scrollbar-thumb,
#label-select .option-list::-webkit-scrollbar-thumb:hover,
#label-select .option-list::-webkit-scrollbar-thumb:active {
  background: #282626 !important;
  border: 3px solid #383838 !important;
  border-radius: 7px !important;
  background-clip: content-box !important;
}

#label-select .option-list::-webkit-scrollbar-button {
  display: none;
  width: 0; height: 0;
}

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: center;
      }
      .controls button,
      .controls select,
      .controls label {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>

</head>
<body>
  
  <div id="loading-screen">
  <img src="https://static.wixstatic.com/media/c77f36_f267062b41fa4c0a9d708971e3a36a18~mv2.png" alt="NUAM Albums Logo">
  <div class="load-wrapp">
    <div class="load-10">
      <div class="bar"></div>
    </div>
    <p class="loading-text">Підключення до бази NUAM</p>
  </div>
</div>
  
  <div class="controls">
    <div class="filter-section">
      <div class="checkbox-container">
        <div class="section-title genre-header">
  <span>Жанри:</span>
  <div class="genre-buttons">
    <button id="select-all-genres">Вибрати всі</button>
    <button id="deselect-all-genres">Зняти всі</button>
  </div>
</div>
<div class="checkbox-grid" id="genre-checkboxes"></div>

      </div>
      <div class="filter-group">
  <div class="checkbox-container">
    <label class="section-title">Мови:</label>
    <div class="checkbox-grid" id="language-checkboxes"></div>
  </div>
  <div class="release-column">
  <div class="checkbox-container" style="max-height: none; overflow-y: visible;">
    <label class="section-title">Тип релізу:</label>
    <div class="checkbox-grid" id="release-type-checkboxes"></div>
  </div>
  <div class="hide-listened-section">
    <label for="nuam-recommended-checkbox">
      <input type="checkbox" id="nuam-recommended-checkbox">Рекомендовані NUAM
    </label>
  </div>
</div>
</div>
      
    </div>
    <div class="sort-and-blacklist">
      <div class="sort-section">
  <label for="sort-order">Сортування:</label>
  <div class="custom-select" id="sort-order">
    <div class="selected">Спочатку нові</div>
    <div class="options-container">
      <div class="option" data-value="desc">Спочатку нові</div>
      <div class="option" data-value="asc">Спочатку старі</div>
      <div class="option" data-value="listens-desc">Більше прослуховувань</div>
      <div class="option" data-value="popularity-growth">Активне зростання слухачів</div>
    </div>
  </div>
</div>

      <div class="sort-section">
  <label for="duration-filter">Тривалість:</label>
  <div class="custom-select" id="duration-filter">
    <div class="selected">Будь-яка тривалість</div>
    <div class="options-container">
      <div class="option" data-value="">Будь-яка тривалість</div>
      <div class="option" data-value="short">До 30 хвилин</div>
      <div class="option" data-value="medium">30-60 хвилин</div>
      <div class="option" data-value="long">60-120 хвилин</div>
      <div class="option" data-value="very-long">Понад 120 хвилин</div>
    </div>
  </div>
</div>

<div class="sort-section">
  <label for="track-count-filter">Кількість треків:</label>
  <div class="custom-select" id="track-count-filter">
    <div class="selected">Будь-яка кількість</div>
    <div class="options-container">
      <div class="option" data-value="">Будь-яка кількість</div>
      <div class="option" data-value="5">5 і більше треків</div>
      <div class="option" data-value="12">12 і більше треків</div>
    </div>
  </div>
</div>
      
      <div class="sort-section">
  <label for="track-count-filter">Лейбл альбому:</label>
      <div class="custom-select upward" id="label-select">
  <div class="selected">Усі лейбли</div>
  <div class="options-container">
    <div class="option" data-value="">Усі лейбли</div>
  </div>
</div>
        </div>
      
      <div class="blacklist-row">
  <div class="blacklist-section">
    <button id="blacklist-button">Чорний список</button>
  </div>
  <div class="hide-listened-section">
    <label for="hide-listened">
      <input type="checkbox" id="hide-listened">Приховати <span id="show-listened-albums">прослухані альбоми</span>
    </label>
  </div>
</div>

      <div class="favorites-section">
  <button id="favorites-button">Обрані альбоми</button>

</div>

      <label>Альбомів з урахуванням фільтрів: <span id="album-count">0</span></label>
    </div>
  </div>

  <div id="albums-container"></div>
  <div class="lazy-loading" id="lazy-loading">Завантаження альбомів...</div>

  <div id="blacklist-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="tabs">
        <button class="tablink active" id="blacklist-tab" onclick="openTab(event, 'blacklist-content')">Чорний список</button>
        <button class="tablink" id="listened-albums-tab" onclick="openTab(event, 'listened-albums-content')">Прослухані альбоми</button>
        <button class="tablink" id="export-tab" onclick="openTab(event, 'export-content')">Перенесення даних</button>
      </div>
      <div id="blacklist-content" class="tabcontent active">
        <div class="blacklist-container">
          <div class="blacklist-artists checkbox-container">
            <h4>Артисти</h4>
            <ul id="blacklisted-artists"></ul>
          </div>
          <div class="blacklist-labels checkbox-container">
            <h4>Лейбли</h4>
            <ul id="blacklisted-labels"></ul>
          </div>
        </div>
      </div>
      <div id="listened-albums-content" class="tabcontent">
        <div class="listened-albums-container">
          <ul id="listened-albums-list"></ul>
        </div>
      </div>
      <div id="export-content" class="tabcontent">
  <div class="export-import-container">
  <div class="export-section" style="display: flex; flex-direction: column; gap: 10px;">
    <label for="data-textarea">Дані для експорту:</label>
    <textarea id="data-textarea" readonly></textarea>
    <div class="button-line">
  <button id="export-data">Копіювати дані</button>
  <span id="export-message"> </span>
</div>
  </div>
  <div class="import-section" style="display: flex; flex-direction: column; gap: 10px;">
    <label for="import-textarea">Вставте сюди дані для імпорту:</label>
    <textarea id="import-textarea" placeholder="Вставте сюди дані"></textarea>
    <div class="button-line">
  <button id="import-data">Завантажити дані</button>
  <span id="import-message"> </span>
</div>
  </div>
</div>
</div>
    </div>
  </div>

  <div class="modal-overlay"></div>
 
  <div id="favorites-modal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-favorites-modal">&times;</span>
    <div class="tabs">
      <h3>Обрані альбоми</h3>
    </div>
    <div class="listened-albums-container">
      <ul id="favorites-albums-list"></ul>
    </div>
  </div>
</div>

  <div id="scrollTopButton" style="
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 50px;
  height: 50px;
  background: #84aafb;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 9999;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  transition: opacity 0.3s;
  user-select: none;
">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#282626" viewBox="0 0 24 24">
    <path d="M12 4l-8 8h6v8h4v-8h6z"/>
  </svg>
</div>
  
  <script>
    const newSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRGgPDeRNQcSe5tV2h3zu-rtMr-i7ph-4hU6HKglhXKdaAB5UFXUrdWLZKb8hwGyWgDxL5LDfnmrqe/pub?gid=1559781011&single=true&output=csv";

    let albumsData = [];
    let currentIndex = 0;
    let sortOrder = 'desc';
    let hideListened = false;
    let audioActivated = false;
    let filteredAlbums = [];
    let isFiltering = false;

    let blacklistedArtists = new Set(JSON.parse(localStorage.getItem('blacklistedArtists')) || []);
    let blacklistedLabels = new Set(JSON.parse(localStorage.getItem('blacklistedLabels')) || []);
    let labelFilter = '';

function releaseIcon(t){
  if (t==='compilation') return `<svg class="rls-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="5" y="5" width="190" height="190" rx="40" ry="40" fill="none" stroke="#f3f3f3" stroke-width="8"/><text x="50%" y="43%" text-anchor="middle" font-family="Arial Black, Arial, sans-serif" font-size="75" fill="#f3f3f3">CO</text><text x="50%" y="83%" text-anchor="middle" font-family="Arial Black, Arial, sans-serif" font-size="75" fill="#f3f3f3">MP</text></svg>`;
  if (t==='album')      return `<svg class="rls-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="5" y="5" width="190" height="190" rx="40" ry="40" fill="none" stroke="#f3f3f3" stroke-width="8"/><text x="50%" y="54%" text-anchor="middle" dominant-baseline="middle" font-family="Arial Black, Arial, sans-serif" font-size="115" fill="#f3f3f3">LP</text></svg>`;
  return `<svg class="rls-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="5" y="5" width="190" height="190" rx="40" ry="40" fill="none" stroke="#f3f3f3" stroke-width="8"/><text x="50%" y="54%" text-anchor="middle" dominant-baseline="middle" font-family="Arial Black, Arial, sans-serif" font-size="115" fill="#f3f3f3">EP</text></svg>`;
}

    const listenedAlbums = JSON.parse(localStorage.getItem('listenedAlbums')) || {};
    const favoriteAlbums = JSON.parse(localStorage.getItem('favoriteAlbums')) || {};

    const languageLabels = {
      'ukr': 'українська',
      'eng': 'англійська',
      'rus': 'російська',
      'other lang': 'інші мови'
    };

    const batchSize = 20;

    init();

    function init() {
  Papa.parse(newSheetUrl, {
    download: true,
    header: true,
    complete: function(results) {
  const rawData = results.data;
  processAlbumData(rawData);

  const loading = document.getElementById('loading-screen');
if (loading) {
  loading.classList.add('hidden');
  loading.addEventListener('transitionend', () => {
    loading.remove();
  }, { once: true });
}

  populateFilters();
  populateLabelOptions();
      initBasicCustomSelect(document.getElementById('sort-order'));
      initBasicCustomSelect(document.getElementById('duration-filter'));
      initBasicCustomSelect(document.getElementById('track-count-filter'));
      attachGlobalEventListeners();
      const albumFilters = JSON.parse(localStorage.getItem('albumFilters')) || null;
      if (albumFilters) {
        loadFiltersAfterRender();
      } else {
        applyFilters();
      }
    },
    error: function(error) {
      console.error('Помилка під час завантаження CSV:', error);
    }
  });
}

function initBasicCustomSelect(select) {
  const selected = select.querySelector('.selected');
  const optionsContainer = select.querySelector('.options-container');
  selected.addEventListener('click', e => {
  e.stopPropagation();

  document.querySelectorAll('.custom-select').forEach(otherSelect => {
    if (otherSelect !== select) {
      otherSelect.querySelector('.options-container').style.display = 'none';
      otherSelect.classList.remove('open');
    }
  });
  const isOpen = optionsContainer.style.display === 'flex';
  optionsContainer.style.display = isOpen ? 'none' : 'flex';
  select.classList.toggle('open', !isOpen);
});
  optionsContainer.querySelectorAll('.option').forEach(option => {
    option.addEventListener('click', () => {
      selected.textContent = option.textContent;
      selected.dataset.value = option.dataset.value;
      optionsContainer.style.display = 'none';
      select.classList.remove('open');
      if (select.id === 'sort-order') sortOrder = option.dataset.value;
      preserveScroll(() => smoothApplyFilters());
      saveFiltersToCache();
    });
  });
  document.addEventListener('click', e => {
    if (!select.contains(e.target)) {
      optionsContainer.style.display = 'none';
      select.classList.remove('open');
    }
  });
}

function friendlyGenreLabel(g) {
  if (g === 'producing work for international') return 'intl prod';
  if (g === 'ai') return 'AI';
  if (g === 'instrumental rock') return 'alt. instrumental';
  return g;
}

    function formatListens(num) {
  if (num >= 10000) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }
  return num;
}

    function processAlbumData(rawData) {
      rawData.forEach(item => {
        if (!item.alName || !item.Type) return;
if (item.excluded && item.excluded.trim() === '+') return;

        const album = {
          nameAlbum: item.alName,
          albumID: item.alURL,
          date: item.Date,
          type: item.Type.toLowerCase(),
          cover: item.Cover,
          genres: (() => {
  let baseGenres = item.Genres ? item.Genres.split(', ').map(g => g.trim()).filter(g => g) : [];
  let addGenres = item.addGenre ? item.addGenre.split(',').map(g => g.trim()).filter(g => g) : [];

  addGenres.forEach(g => {
    if (g.startsWith('-')) {
      const genreToRemove = g.slice(1).trim();
      baseGenres = baseGenres.filter(bg => bg !== genreToRemove);
    }
  });

  addGenres.forEach(g => {
    if (!g.startsWith('-')) {
      if (!baseGenres.includes(g)) {
        baseGenres.push(g);
      }
    }
  });

  return baseGenres;
})(),

          languages: (() => {
  let baseLangs = item.Lang
    ? item.Lang.split(', ').map(l => (l.trim().toLowerCase() === 'no voice' ? 'без голосу' : l.trim())).filter(l => l)
    : [];
  let addLangs = item.addLang
    ? item.addLang.split(',').map(l => (l.trim().toLowerCase() === 'no voice' ? 'без голосу' : l.trim())).filter(l => l)
    : [];

  addLangs.forEach(l => {
    if (l.startsWith('-')) {
      const langToRemove = l.slice(1).trim();
      baseLangs = baseLangs.filter(bl => bl !== langToRemove);
    }
  });

  addLangs.forEach(l => {
    if (!l.startsWith('-')) {
      if (!baseLangs.includes(l)) {
        baseLangs.push(l);
      }
    }
  });

  return baseLangs;
})(),

          listens: parseInt(item.Listens) || 0,
          label: item.Label || '',
          duration: item.Duration || '',
          tracksIDs: item.Tracks ? item.Tracks.split(',') : [],
          tracksMP3: item.MP3 ? item.MP3.split(',') : [],
          good: (item.Good && item.Good.trim() === '+'),
          artistNames: item.artName ? item.artName.split(',,').map(a => a.trim()) : [],
          artistIDs: item.artID ? item.artID.split(',') : [],
          listened: !!listenedAlbums[item.alURL],
          growthScore: 0
        };

        albumsData.push(album);
        
if (item.Listens) {
  const history = item.Listens
    .split(',')
    .map(x => parseInt(x.trim(), 10))
    .filter(n => !isNaN(n));

  if (history.length >= 2) {
    const recent = history.slice(0, 8);
    const deltas = [];
    for (let i = 0; i < recent.length - 1; i++) {
      deltas.push(recent[i] - recent[i + 1]);
    }

    const avgDelta = deltas.reduce((a, b) => a + b, 0) / deltas.length;
    album.growthScore = avgDelta;
  } else {
    album.growthScore = -Infinity;
  }
} else {
  album.growthScore = -Infinity;
}
      });
    }

    function populateFilters() {
      const genreContainer = document.getElementById('genre-checkboxes');
      const languageContainer = document.getElementById('language-checkboxes');
      const releaseTypeContainer = document.getElementById('release-type-checkboxes');

      const genresCountMap = new Map();
      const languagesCountMap = new Map();
      const releaseTypesSet = new Set();

      albumsData.forEach(album => {
        album.genres.forEach(genre => {
          genresCountMap.set(genre, (genresCountMap.get(genre) || 0) + 1);
        });
        if (album.languages.length === 0) {
  languagesCountMap.set('без голосу', (languagesCountMap.get('без голосу') || 0) + 1);
} else {
  album.languages.forEach(lang => {
    const mappedLang = (lang.trim().toLowerCase() === 'no voice') ? 'без голосу' : lang;
    languagesCountMap.set(mappedLang, (languagesCountMap.get(mappedLang) || 0) + 1);
  });
}

        releaseTypesSet.add(album.type);
      });

      const desiredGenreOrder = [
  'pop/indie', 'rock', 'hip-hop', 'electronic', 'metal', 'post-punk', 'trap', 'phonk',
  'folk', 'jazz', 'worship', 'instrumental', 'instrumental rock', 'piano', 'synthwave',
  'cinematic', 'hyperpop', 'vocal guitar', 'vocal piano', 'cover', 'remix', 'live',
  'phonk beats', 'beats rap', 'beats lo-fi', 'chillout', 'drone', 'exp. electronic',
  'exp. instrumental', 'opera', 'a cappella', 'background', 'jersey club', 'ai',
  'producing work for international', 'christmas'
];

const sortedGenres = [
  ...desiredGenreOrder
    .filter(genre => genresCountMap.has(genre))
    .map(genre => [genre, genresCountMap.get(genre)]),
  ...[...genresCountMap.entries()]
    .filter(([genre]) => !desiredGenreOrder.includes(genre))
    .sort((a, b) => a[0].localeCompare(b[0]))
];

      genreContainer.innerHTML = '';
      const genreFrag = document.createDocumentFragment();
      sortedGenres.forEach(([genre, count]) => {
        const div = document.createElement('div');
        div.classList.add('genre-filter-item');

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = genre;
        checkbox.id = `genre-${encodeURIComponent(genre)}`;
        checkbox.classList.add('genre-checkbox');

        const label = document.createElement('label');
        label.htmlFor = checkbox.id;

        const genreName = document.createElement('span');
genreName.classList.add('genre-name');
genreName.textContent = friendlyGenreLabel(genre);

if (genre === 'producing work for international'){
  attachTooltip(genreName,'Музика наших музикантів для іноземних артистів');
}

        const genreCount = document.createElement('span');
        genreCount.classList.add('genre-count');
        genreCount.textContent = ` (${count})`;

        const genreCross = document.createElement('span');
        genreCross.textContent = '✖';
        genreCross.classList.add('exclude-genre');
        genreCross.style.cursor = 'pointer';
        genreCross.setAttribute('data-genre', genre);

        label.appendChild(genreName);
        label.appendChild(genreCount);

        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(genreCross);
        genreFrag.appendChild(div);
      });
      genreContainer.appendChild(genreFrag);

      const defaultLangOrder = ['ukr', 'eng', 'rus', 'other lang', 'без голосу'];
      languageContainer.innerHTML = '';
      const languageFrag = document.createDocumentFragment();
      defaultLangOrder.forEach(langKey => {

        const count = languagesCountMap.get(langKey) || 0;
        if (count > 0 || langKey === 'без голосу') {
          const div = document.createElement('div');
          div.classList.add('language-filter-item');

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = langKey;
          checkbox.id = `language-${encodeURIComponent(langKey)}`;
          checkbox.classList.add('language-checkbox');

          const label = document.createElement('label');
          label.htmlFor = checkbox.id;

          const languageName = document.createElement('span');
          languageName.classList.add('language-name');
          languageName.textContent = languageLabels[langKey] || langKey;

          const languageCount = document.createElement('span');
          languageCount.classList.add('language-count');
          languageCount.textContent = ` (${count})`;

          const languageCross = document.createElement('span');
          languageCross.textContent = '✖';
          languageCross.classList.add('exclude-language');
          languageCross.style.cursor = 'pointer';
          languageCross.setAttribute('data-language', langKey);

          label.appendChild(languageName);
          label.appendChild(languageCount);

          div.appendChild(checkbox);
          div.appendChild(label);
          div.appendChild(languageCross);
          languageFrag.appendChild(div);
        }
      });
      languageContainer.appendChild(languageFrag);

      releaseTypeContainer.innerHTML = '';
      const releaseTypeLabels = {
        'album': 'LP',
        'ep': 'EP',
        'compilation': 'Компіляції'
      };
      const releaseTypeCounts = {};
albumsData.forEach(album => {
  releaseTypeCounts[album.type] = (releaseTypeCounts[album.type] || 0) + 1;
});

releaseTypesSet.forEach(rType => {
  const div = document.createElement('div');
  div.classList.add('release-type-filter-item');

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.value = rType;
  checkbox.id = `release-type-${rType}`;
  checkbox.classList.add('release-type-checkbox');
  checkbox.checked = true;

  const label = document.createElement('label');
  label.htmlFor = checkbox.id;
  label.innerHTML = `${releaseTypeLabels[rType] || rType} <span class="genre-count">(${releaseTypeCounts[rType] || 0})</span>`;

  div.appendChild(checkbox);
  div.appendChild(label);
  releaseTypeContainer.appendChild(div);
});
    }

function populateLabelOptions() {
  const map = {};
  albumsData.forEach(al => {
    if (!al.label || al.artistNames.length === 0) return;
    const artist = al.artistNames[0];
    if (artist === al.label) return;
    if (!map[al.label]) map[al.label] = new Set();
    map[al.label].add(artist);
  });
  const labels = Object.entries(map)
    .filter(([, artists]) => artists.size >= 3)
    .map(([lbl]) => lbl)
    .sort((a, b) => a.localeCompare(b));

  const select = document.getElementById('label-select');
  const optsContainer = select.querySelector('.options-container');
  optsContainer.innerHTML = `
    
    <div class="option-fixed">
      <div class="option" data-value="">Усі лейбли</div>
      <input type="text" class="option-search" placeholder="Пошук...">
    </div>
    <div class="option-list"></div>
  `;

  const listContainer = optsContainer.querySelector('.option-list');
  labels.forEach(lbl => {
    const o = document.createElement('div');
    o.className = 'option';
    o.dataset.value = lbl;
    o.textContent = lbl;
    listContainer.appendChild(o);
  });

  initCustomSelect(select);
}

function initCustomSelect(select) {
  const selected        = select.querySelector('.selected');
  const optionsContainer = select.querySelector('.options-container');
  const listContainer   = optionsContainer.querySelector('.option-list');
  const fixedContainer  = optionsContainer.querySelector('.option-fixed');
  const searchInput     = fixedContainer.querySelector('.option-search');

  selected.addEventListener('click', e => {
  e.stopPropagation();

  document.querySelectorAll('.custom-select').forEach(otherSelect => {
    if (otherSelect !== select) {
      otherSelect.querySelector('.options-container').style.display = 'none';
      otherSelect.classList.remove('open');
    }
  });
  const isOpen = optionsContainer.style.display === 'flex';
  optionsContainer.style.display = isOpen ? 'none' : 'flex';
  select.classList.toggle('open', !isOpen);
});

  optionsContainer.querySelectorAll('.option').forEach(option => {
    option.addEventListener('click', () => {
      selected.textContent = option.textContent;
      selected.dataset.value = option.dataset.value;
      optionsContainer.style.display = 'none';
      select.classList.remove('open');

      if (select.id === 'label-select') {
        labelFilter = option.dataset.value;
      } else if (select.id === 'sort-order') {
        sortOrder = option.dataset.value;
      }

      preserveScroll(() => smoothApplyFilters());
      saveFiltersToCache();
    });
  });

  document.addEventListener('click', e => {
    if (!select.contains(e.target)) {
      optionsContainer.style.display = 'none';
      select.classList.remove('open');
    }
  });

  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim().toLowerCase();
    listContainer.querySelectorAll('.option').forEach(opt => {
      opt.style.display = opt.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
}

    function loadFiltersAfterRender() {
      const filterData = JSON.parse(localStorage.getItem('albumFilters'));
      if (!filterData) return;

      document.querySelectorAll('.genre-checkbox').forEach(ch => {
        ch.checked = false; ch.disabled = false;
        const lb = ch.nextElementSibling;
        lb.style.textDecoration = 'none';
        lb.style.color = '#f3f3f3';
      });
      if (Array.isArray(filterData.selectedGenres)) {
        filterData.selectedGenres.forEach(g => {
          const cb = document.getElementById(`genre-${encodeURIComponent(g)}`);
          if (cb) cb.checked = true;
        });
      }
      if (Array.isArray(filterData.excludedGenres)) {
        filterData.excludedGenres.forEach(g => {
          const cb = document.getElementById(`genre-${encodeURIComponent(g)}`);
          if (cb) {
            cb.disabled = true;
            const cross = cb.parentNode.querySelector('.exclude-genre');
            cross.textContent = '↻';
            cross.classList.add('repeat-symbol');
            const lb = cb.nextElementSibling;
            lb.style.textDecoration = 'line-through';
            lb.style.color = 'gray';
          }
        });
      }

      document.querySelectorAll('.language-checkbox').forEach(ch => {
        ch.checked = false; ch.disabled = false;
        const lb = ch.nextElementSibling;
        lb.style.textDecoration = 'none';
        lb.style.color = '#f3f3f3';
      });
      if (Array.isArray(filterData.selectedLanguages)) {
        filterData.selectedLanguages.forEach(l => {
          const cb = document.getElementById(`language-${encodeURIComponent(l)}`);
          if (cb) cb.checked = true;
        });
      }
      if (Array.isArray(filterData.excludedLanguages)) {
        filterData.excludedLanguages.forEach(l => {
          const cb = document.getElementById(`language-${encodeURIComponent(l)}`);
          if (cb) {
            cb.disabled = true;
            const cross = cb.parentNode.querySelector('.exclude-language');
            cross.textContent = '↻';
            cross.classList.add('language-repeat-symbol');
            const lb = cb.nextElementSibling;
            lb.style.textDecoration = 'line-through';
            lb.style.color = 'gray';
          }
        });
      }

      document.querySelectorAll('.release-type-checkbox').forEach(ch => {
        ch.checked = false;
      });
      if (Array.isArray(filterData.selectedReleaseTypes)) {
        filterData.selectedReleaseTypes.forEach(rt => {
          const cb = document.getElementById(`release-type-${rt}`);
          if (cb) cb.checked = true;
        });
      }

      if (filterData.sortOrder) {
  const select = document.getElementById('sort-order');
  const selected = select.querySelector('.selected');
  const options = select.querySelectorAll('.option');

  const foundOption = Array.from(options).find(opt => opt.dataset.value === filterData.sortOrder);
  if (foundOption) {
  selected.textContent = foundOption.textContent;
  selected.dataset.value = foundOption.dataset.value;
  sortOrder = filterData.sortOrder;
}
}

      if (typeof filterData.hideListened === 'boolean') {
        document.getElementById('hide-listened').checked = filterData.hideListened;
        hideListened = filterData.hideListened;
        if (typeof filterData.nuamRecommended === 'boolean') {
  document.getElementById('nuam-recommended-checkbox').checked = filterData.nuamRecommended;
}

        const durationSelect = document.getElementById('duration-filter');
const trackCountSelect = document.getElementById('track-count-filter');

if (filterData.duration) {
  const opt = durationSelect.querySelector(`.option[data-value="${filterData.duration}"]`);
  if (opt) {
    durationSelect.querySelector('.selected').textContent = opt.textContent;
    durationSelect.querySelector('.selected').dataset.value = opt.dataset.value;
  }
}

if (filterData.trackCount) {
  const opt = trackCountSelect.querySelector(`.option[data-value="${filterData.trackCount}"]`);
  if (opt) {
    trackCountSelect.querySelector('.selected').textContent = opt.textContent;
    trackCountSelect.querySelector('.selected').dataset.value = opt.dataset.value;
  }
}
      }
      applyFilters();
    }

    function saveFiltersToCache() {
      const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);
      const excludedGenres = Array.from(document.querySelectorAll('.genre-checkbox:disabled')).map(cb => cb.value);

      const selectedLanguages = Array.from(document.querySelectorAll('.language-checkbox:checked')).map(cb => cb.value);
      const excludedLanguages = Array.from(document.querySelectorAll('.language-checkbox:disabled')).map(cb => cb.value);

      const selectedReleaseTypes = Array.from(document.querySelectorAll('.release-type-checkbox:checked')).map(cb => cb.value);

      const sortOrder = document.getElementById('sort-order').querySelector('.selected').dataset.value;
      const hideListened = document.getElementById('hide-listened').checked;

      const filterData = {
        selectedGenres,
        excludedGenres,
        selectedLanguages,
        excludedLanguages,
        selectedReleaseTypes,
        sortOrder,
        hideListened,
        duration: document.getElementById('duration-filter')?.querySelector('.selected')?.dataset?.value || '',
        trackCount: document.getElementById('track-count-filter')?.querySelector('.selected')?.dataset?.value || '',
        nuamRecommended: document.getElementById('nuam-recommended-checkbox').checked,
      };
      localStorage.setItem('albumFilters', JSON.stringify(filterData));
    }

    function attachGlobalEventListeners() {
      document.getElementById('genre-checkboxes').addEventListener('change', (e) => {
        if (e.target.classList.contains('genre-checkbox')) {
          preserveScroll(() => smoothApplyFilters());
saveFiltersToCache();
        }
      });
      
      document.getElementById('genre-checkboxes').addEventListener('click', (e) => {
        if (e.target.classList.contains('exclude-genre')) {
          const genre = e.target.getAttribute('data-genre');
          const cb = document.getElementById(`genre-${encodeURIComponent(genre)}`);
          const lb = cb.nextElementSibling;
          toggleExcludeGenre(genre, cb, lb, e.target);
          saveFiltersToCache();
        }
      });

      document.getElementById('language-checkboxes').addEventListener('change', (e) => {
        if (e.target.classList.contains('language-checkbox')) {
          preserveScroll(() => smoothApplyFilters());
saveFiltersToCache();
        }
      });
      
      document.getElementById('language-checkboxes').addEventListener('click', (e) => {
        if (e.target.classList.contains('exclude-language')) {
          const lang = e.target.getAttribute('data-language');
          const cb = document.getElementById(`language-${encodeURIComponent(lang)}`);
          const lb = cb.nextElementSibling;
          toggleExcludeLanguage(lang, cb, lb, e.target);
          saveFiltersToCache();
        }
      });

      document.getElementById('release-type-checkboxes').addEventListener('change', (e) => {
        if (e.target.classList.contains('release-type-checkbox')) {
          preserveScroll(() => smoothApplyFilters());
saveFiltersToCache();
        }
      });

      document.getElementById('nuam-recommended-checkbox').addEventListener('change', () => {
  preserveScroll(() => smoothApplyFilters());
  saveFiltersToCache();
});
      
document.getElementById('duration-filter').addEventListener('change', () => {
  preserveScroll(() => smoothApplyFilters());
  saveFiltersToCache();
});

document.getElementById('track-count-filter').addEventListener('change', () => {
  preserveScroll(() => smoothApplyFilters());
  saveFiltersToCache();
});

      document.getElementById('hide-listened').addEventListener('change', (e) => {
        hideListened = e.target.checked;
        preserveScroll(() => smoothApplyFilters());
saveFiltersToCache();
      });

      document.getElementById('select-all-genres').addEventListener('click', () => {
        document.querySelectorAll('.genre-checkbox').forEach(cb => {
          if (!cb.disabled) cb.checked = true;
        });
        preserveScroll(() => smoothApplyFilters());
saveFiltersToCache();
      });
      
      document.getElementById('deselect-all-genres').addEventListener('click', () => {
        document.querySelectorAll('.genre-checkbox').forEach(cb => {
          if (!cb.disabled) cb.checked = false;
        });
        preserveScroll(() => smoothApplyFilters());
saveFiltersToCache();
      });

      document.getElementById('blacklist-button').addEventListener('click', function() {
        showBlacklist(true);
      });

      document.getElementById('show-listened-albums').addEventListener('click', function(event) {
        event.preventDefault();
        showBlacklist(false);
      });

      window.addEventListener('scroll', throttle(handleScroll, 200));

      document.getElementById('export-data').addEventListener('click', () => {
  const dataTextarea = document.getElementById('data-textarea');
  const msg = document.getElementById('export-message');
  dataTextarea.select();
  navigator.clipboard.writeText(dataTextarea.value).then(() => {
    msg.textContent = 'Скопійовано!';
    msg.className = 'success';
    setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 2000);
  }).catch(err => {
    console.error('Помилка копіювання даних: ', err);
    msg.textContent = 'Помилка при копіюванні даних.';
    msg.className = 'error';
    setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 4000);
  });
});

document.getElementById('import-data').addEventListener('click', () => {
  const importTextarea = document.getElementById('import-textarea');
  const msg = document.getElementById('import-message');
  const importDataString = importTextarea.value.trim();
  if (!importDataString) {
    msg.textContent = 'Введіть дані для завантаження.';
    msg.className = 'error';
    setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 4000);
    return;
  }
  try {
    const importData = JSON.parse(importDataString);
    if (importData.blacklistArtists) {
      localStorage.setItem('blacklistedArtists', JSON.stringify(importData.blacklistArtists));
    }
    if (importData.blacklistLabels) {
      localStorage.setItem('blacklistedLabels', JSON.stringify(importData.blacklistLabels));
    }
    if (importData.listenedAlbums) {
      localStorage.setItem('listenedAlbums', JSON.stringify(importData.listenedAlbums));
    }
    if (importData.albumFilters) {
      localStorage.setItem('albumFilters', JSON.stringify(importData.albumFilters));
    }
    msg.textContent = 'Дані завантажені. Перезавантажте сторінку.';
    msg.className = 'success';
    setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 5000);
  } catch (error) {
    msg.textContent = 'Помилка при завантаженні. Формат JSON некоректний.';
    msg.className = 'error';
    setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 4000);
  }
});
  
window.addEventListener('scroll', () => {
  const scrollTopButton = document.getElementById('scrollTopButton');
  if (window.scrollY > 200) {
    scrollTopButton.style.display = 'flex';
    scrollTopButton.style.opacity = '1';
  } else {
    scrollTopButton.style.opacity = '0';
    setTimeout(() => {
      if (window.scrollY <= 200) {
        scrollTopButton.style.display = 'none';
      }
    }, 300);
  }
});

      document.getElementById('favorites-button').addEventListener('click', () => {
  const modal = document.getElementById('favorites-modal');
  modal.style.display = 'block';
  updateFavoritesModal();
});
      
document.getElementById('close-favorites-modal').addEventListener('click', () => {
  document.getElementById('favorites-modal').style.display = 'none';
});

      window.addEventListener('click', (event) => {
  const modal = document.getElementById('favorites-modal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
});
      
document.getElementById('scrollTopButton').addEventListener('click', () => {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
});  
    }

    function toggleExcludeGenre(genre, checkbox, label, genreCross) {
      if (checkbox.disabled) {
        checkbox.disabled = false;
        genreCross.textContent = '✖';
        genreCross.classList.remove('repeat-symbol');
        label.style.textDecoration = 'none';
        label.style.color = '#f3f3f3';
      } else {
        checkbox.disabled = true;
        genreCross.textContent = '↻';
        genreCross.classList.add('repeat-symbol');
        label.style.textDecoration = 'line-through';
        label.style.color = 'gray';
      }
      preserveScroll(() => smoothApplyFilters());

    }

    function toggleExcludeLanguage(language, checkbox, label, langCross) {
      if (checkbox.disabled) {
        checkbox.disabled = false;
        langCross.textContent = '✖';
        langCross.classList.remove('language-repeat-symbol', 'repeat-symbol');
        label.style.textDecoration = 'none';
        label.style.color = '#f3f3f3';
      } else {
        checkbox.disabled = true;
        langCross.textContent = '↻';
        langCross.classList.add('language-repeat-symbol');
        label.style.textDecoration = 'line-through';
        label.style.color = 'gray';
      }
      preserveScroll(() => smoothApplyFilters());
    }

    function getFilteredAlbums() {
  const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);
  const excludedGenres = Array.from(document.querySelectorAll('.genre-checkbox:disabled')).map(cb => cb.value);
  const selectedLangs = Array.from(document.querySelectorAll('.language-checkbox:checked')).map(cb => cb.value);
  const excludedLangs = Array.from(document.querySelectorAll('.language-checkbox:disabled')).map(cb => cb.value);
  const selectedReleaseTypes = Array.from(document.querySelectorAll('.release-type-checkbox:checked')).map(cb => cb.value);

  return albumsData.filter(al => {
    if (hideListened && al.listened) return false;

    const matchGenres = selectedGenres.length === 0 || al.genres.some(g => selectedGenres.includes(g));
    const notExcludedGenres = excludedGenres.length === 0 || !al.genres.some(g => excludedGenres.includes(g));

    const matchLangs = selectedLangs.length === 0 || (
      al.languages.length === 0
        ? selectedLangs.includes('без голосу')
        : al.languages.some(l => selectedLangs.includes(l))
    );
    const notExcludedLangs = excludedLangs.length === 0 || (
      al.languages.length === 0
        ? !excludedLangs.includes('без голосу')
        : !al.languages.some(l => excludedLangs.includes(l))
    );

    const matchRelease = selectedReleaseTypes.length === 0 || selectedReleaseTypes.includes(al.type);
    const notBlacklistedArtist = !al.artistIDs.some(id => blacklistedArtists.has(id));
    const notBlacklistedLabel = !blacklistedLabels.has(al.label);

    return matchGenres && notExcludedGenres &&
           matchLangs && notExcludedLangs &&
           matchRelease &&
           notBlacklistedArtist && notBlacklistedLabel;
  });
}

    function applyFilters(renderImmediately = false) {
      filteredAlbums = [...albumsData];

      const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);
      if (selectedGenres.length > 0) {
        filteredAlbums = filteredAlbums.filter(al => {
          return al.genres.some(g => selectedGenres.includes(g));
        });
      }

      const excludedGenres = Array.from(document.querySelectorAll('.genre-checkbox:disabled')).map(cb => cb.value);
      if (excludedGenres.length > 0) {
        filteredAlbums = filteredAlbums.filter(al => {
          return !al.genres.some(g => excludedGenres.includes(g));
        });
      }

      const selectedLangs = Array.from(document.querySelectorAll('.language-checkbox:checked')).map(cb => cb.value);
      if (selectedLangs.length > 0) {
        filteredAlbums = filteredAlbums.filter(al => {
          if (al.languages.length === 0) {
            return selectedLangs.includes('без голосу');
          } else {
            return al.languages.some(l => selectedLangs.includes(l));
          }
        });
      }

      const excludedLangs = Array.from(document.querySelectorAll('.language-checkbox:disabled')).map(cb => cb.value);
      if (excludedLangs.length > 0) {
        filteredAlbums = filteredAlbums.filter(al => {
          if (al.languages.length === 0) {
            return !excludedLangs.includes('без голосу');
          } else {
            return !al.languages.some(l => excludedLangs.includes(l));
          }
        });
      }

      const selectedReleaseTypes = Array.from(document.querySelectorAll('.release-type-checkbox:checked')).map(cb => cb.value);
      if (selectedReleaseTypes.length > 0) {
        filteredAlbums = filteredAlbums.filter(al => selectedReleaseTypes.includes(al.type));
      }

      const onlyRecommended = document.getElementById('nuam-recommended-checkbox').checked;
if (onlyRecommended) {
  filteredAlbums = filteredAlbums.filter(al => al.good);
}
      
      filteredAlbums = filteredAlbums.filter(al => {
  return !al.artistIDs.some(id => blacklistedArtists.has(id));
});

      filteredAlbums = filteredAlbums.filter(al => {
        return !blacklistedLabels.has(al.label);
      });

      if (hideListened) {
        filteredAlbums = filteredAlbums.filter(al => !al.listened);
      }

      if (sortOrder === 'listens-desc') {
  filteredAlbums.sort((a, b) => b.listens - a.listens);
} else if (sortOrder === 'popularity-growth') {
  filteredAlbums.sort((a, b) => b.growthScore - a.growthScore);
} else {
  filteredAlbums.sort((a, b) => {
    const da = new Date(a.date);
    const db = new Date(b.date);
    return sortOrder === 'asc' ? da - db : db - da;
  });
}

const selectedDuration = document.getElementById('duration-filter')?.querySelector('.selected')?.dataset?.value || '';
if (selectedDuration) {
  filteredAlbums = filteredAlbums.filter(al => {
    const parts = (al.duration || '00:00:00').split(':').map(p => parseInt(p) || 0);
    const totalMinutes = parts[0] * 60 + parts[1];
    if (selectedDuration === 'short') return totalMinutes < 30;
    if (selectedDuration === 'medium') return totalMinutes >= 30 && totalMinutes < 60;
    if (selectedDuration === 'long') return totalMinutes >= 60 && totalMinutes < 120;
    if (selectedDuration === 'very-long') return totalMinutes >= 120;
    return true;
  });
}

const selectedTrackCount = document.getElementById('track-count-filter')?.querySelector('.selected')?.dataset?.value || '';
if (selectedTrackCount) {
  const minTracks = parseInt(selectedTrackCount, 10);
  filteredAlbums = filteredAlbums.filter(al => al.tracksIDs.length >= minTracks);
}

      if (labelFilter) {
  filteredAlbums = filteredAlbums.filter(al => al.label === labelFilter);
}
    
if (labelFilter) {
  const totalByLabel  = albumsData.filter(a => a.label === labelFilter);
  const hiddenByLabel = totalByLabel.filter(a => !filteredAlbums.includes(a));

  if (sortOrder === 'listens-desc') {
    hiddenByLabel.sort((a,b) => b.listens - a.listens);
  } else if (sortOrder === 'popularity-growth') {
    hiddenByLabel.sort((a,b) => b.growthScore - a.growthScore);
  } else {
    hiddenByLabel.sort((a,b) => {
      const da = new Date(a.date), db = new Date(b.date);
      return sortOrder === 'asc' ? da - db : db - da;
    });
  }

  if (hiddenByLabel.length) {
    filteredAlbums.push({ __separator: true });
    filteredAlbums.push(...hiddenByLabel);
  }
}

const forceAll = Boolean(labelFilter) || renderImmediately;
currentIndex = 0;
renderAlbums(filteredAlbums, true, forceAll);

      document.getElementById('album-count').textContent = filteredAlbums.length;
      
      const lazyMsg = document.getElementById('lazy-loading');

if (labelFilter) {
  const totalByLabel   = albumsData.filter(a => a.label === labelFilter);
  const hiddenByLabel  = totalByLabel.filter(a => !filteredAlbums.includes(a));

  if (hiddenByLabel.length) {
    filteredAlbums.push({ __separator: true });
    filteredAlbums.push(...hiddenByLabel);
  }

  lazyMsg.textContent = '';
} else {
  lazyMsg.textContent = filteredAlbums.length === 0
          ? 'Більше немає альбомів для завантаження'
          : '';
}
    }

    function updateRenderedAlbums(filteredAlbums) {
  const container = document.getElementById('albums-container');
  const filteredIDs = new Set(filteredAlbums.map(a => a.albumID));

  document.querySelectorAll('.album').forEach(albumDiv => {
    const id = albumDiv.dataset.albumId;
    if (!filteredIDs.has(id)) {
      albumDiv.style.transition = 'opacity 0.3s';
      albumDiv.style.opacity = '0';
      setTimeout(() => albumDiv.remove(), 300);
    }
  });

  currentIndex = [...container.querySelectorAll('.album')].length;
}

    function handleScroll() {
  if (isFiltering) return;

  if ((window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) && currentIndex < filteredAlbums.length) {
    renderAlbums(filteredAlbums);
  }
}

    function forceLazyLoadCheck() {
  const container = document.getElementById('albums-container');

  const containerBottom = container.getBoundingClientRect().bottom;
  const viewportHeight = window.innerHeight;

  if (containerBottom <= viewportHeight + 100 && currentIndex < filteredAlbums.length) {
    renderAlbums(filteredAlbums);
  } else if (currentIndex >= filteredAlbums.length) {
    document.getElementById('lazy-loading').textContent = 'Більше немає альбомів для завантаження';
  }
}

    function throttle(func, limit) {
      let lastFunc;
      let lastRan;
      return function() {
        const context = this, args = arguments;
        if (!lastRan) {
          func.apply(context, args);
          lastRan = Date.now();
        } else {
          clearTimeout(lastFunc);
          lastFunc = setTimeout(function() {
            if ((Date.now() - lastRan) >= limit) {
              func.apply(context, args);
              lastRan = Date.now();
            }
          }, limit - (Date.now() - lastRan));
        }
      };
    }

    function renderAlbums(data, reset = false, forceAll = false) {
  const container = document.getElementById('albums-container');
  if (reset) container.innerHTML = '';

  const endIndex = forceAll ? data.length : Math.min(currentIndex + batchSize, data.length);

  for (let i = currentIndex; i < endIndex; i++) {
    const album    = data[i];
    
  if (album.__separator) {
  const sep = document.createElement('div');
  sep.classList.add('separator');

  const l1 = document.createElement('div');
  l1.classList.add('line');
  const txt = document.createElement('div');
  txt.classList.add('sep-text');
  txt.textContent = 'Альбоми лейбла, що не відповідають обраним вами фільтрам';
  const l2 = document.createElement('div');
  l2.classList.add('line');

  sep.append(l1, txt, l2);
  container.appendChild(sep);
  continue;
}

    const albumDiv = document.createElement('div');
    albumDiv.classList.add('album');
    albumDiv.dataset.albumId = album.albumID;
    if (album.listened) albumDiv.classList.add('album-listened');
    
    const coverUrl   = `https://i.scdn.co/image/ab67616d0000b273${album.cover}`;
    const albumLink  = `https://open.spotify.com/album/${album.albumID}`;
    const langText   = album.languages.length === 0
      ? 'Без голосу'
      : album.languages.map(l => languageLabels[l] || l).join(', ');
    const joinedGenres = album.genres.length
      ? album.genres.map(g => friendlyGenreLabel(g)).join(', ')
      : 'Немає даних';

    albumDiv.innerHTML = `
      <div class="album-overlay"></div>
      <div class="album-cover-wrapper">
        <img src="${coverUrl}" alt="${album.nameAlbum}" class="album-cover">
      </div>

      <div class="album-details">
        <div class="alb-head">
          ${releaseIcon(album.type)}
          <div class="alb-head-txt">
            <h3 style="display: flex; align-items: center; gap: 6px;">
  <a href="${albumLink}" target="_blank" style="display: flex; align-items: center; gap: 6px;">
    ${album.nameAlbum}
    <span class="spotify-icon">
      <span class="icon-default">
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill="none">
          <circle cx="24" cy="24" r="21.5" stroke="#f3f3f3" stroke-width="2"/>
          <path d="M33.86 33.51c-.39.63-1.21.83-1.84.44-5.05-3.08-11.4-3.78-18.89-2.07-.72.16-1.44-.29-1.6-1.01-.17-.72.29-1.44 1.01-1.6 8.19-1.87 15.21-1.07 20.88 2.4.63.39.83 1.21.44 1.84Zm2.63-5.85c-.49.79-1.52 1.04-2.31.55-5.78-3.55-14.59-4.58-21.42-2.51-.89.27-1.82-.23-2.09-1.12-.27-.89.23-1.82 1.12-2.09 7.81-2.37 17.52-1.22 24.15 2.86.79.49 1.04 1.52.55 2.3Zm.23-6.1c-6.93-4.12-18.36-4.49-24.98-2.49-1.06.32-2.19-.28-2.51-1.34-.32-1.06.28-2.19 1.34-2.51 7.59-2.31 20.22-1.86 28.2 2.88.96.57 1.27 1.8.7 2.76-.56.96-1.8 1.27-2.75.7Z" fill="#f3f3f3"/>
        </svg>
      </span>
      <span class="icon-hover">
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
        <path fill="#00DA5A" d="M238.16,481.36 C230.48,476.8 217.64,476.32 210.32,478.6 C209.12,478.96 207.92,478.24 207.56,477.16 C207.2,475.96 207.92,474.76 209,474.4 C217.52,471.88 231.56,472.36 240.44,477.64 C241.52,478.24 241.88,479.68 241.28,480.76 C240.68,481.6 239.24,481.96 238.16,481.36 M237.92,488.08 C237.32,488.92 236.24,489.28 235.4,488.68 C228.92,484.72 219.08,483.52 211.52,485.92 C210.56,486.16 209.48,485.68 209.24,484.72 C209,483.76 209.48,482.68 210.44,482.44 C219.2,479.8 230,481.12 237.44,485.68 C238.16,486.04 238.52,487.24 237.92,488.08 M235.04,494.68 C234.56,495.4 233.72,495.64 233,495.16 C227.36,491.68 220.28,490.96 211.88,492.88 C211.04,493.12 210.32,492.52 210.08,491.8 C209.84,490.96 210.44,490.24 211.16,490 C220.28,487.96 228.2,488.8 234.44,492.64 C235.28,493 235.4,493.96 235.04,494.68 M224,460 C210.8,460 200,470.8 200,484 C200,497.2 210.8,508 224,508 C237.2,508 248,497.2 248,484 C248,470.8 237.32,460 224,460" transform="translate(-200 -460)"/>
      </svg>
      </span>
    </span>
  </a>

  <span class="album-links">
    <a href="https://music.youtube.com/search?q=${encodeURIComponent(album.artistNames.join(', ') + ' - ' + album.nameAlbum)}" target="_blank" class="yt-icon">
      <span class="icon-default">
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill="none">
  <circle cx="24" cy="24" r="14" stroke="#f3f3f3" stroke-width="2"/>
  <circle cx="24" cy="24" r="21.5" stroke="#f3f3f3" stroke-width="2"/>
  <path d="M31,24L19,31V17Z" fill="#f3f3f3"/>
</svg>
      </span>
      <span class="icon-hover">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <path fill="#FF0000" d="M50,2.5C23.766,2.5,2.5,23.823,2.5,50.126c2.502,63.175,92.507,63.157,95-0.001C97.5,23.823,76.233,2.5,50,2.5z
            M50,77.399c-15.036,0-27.27-12.233-27.27-27.27c0.74-18.662,14.654-27.134,27.269-27.134c0.001,0,0.001,0,0.002,0
            c12.616,0.001,26.531,8.473,27.267,27.073C77.27,65.167,65.036,77.399,50,77.399z"/>
          <path fill="#FF0000" d="M50.002,26.103c-15.946-0.001-23.704,12.486-24.165,24.088C25.838,63.453,36.677,74.292,50,74.292
            S74.162,63.453,74.162,50.13C73.705,38.591,65.948,26.105,50.002,26.103z"/>
          <path fill="#FFFFFF" d="M41.055,52.528c-0.001,2.575,0.001,7.867,0,10.46c0,0,21.802-13.417,21.802-13.417L41.055,37.272V52.528z"/>
        </svg>
      </span>
    </a>

    <a href="https://music.apple.com/ua/search?term=${encodeURIComponent(album.artistNames.join(', ') + ' - ' + album.nameAlbum)}" target="_blank" class="apple-icon">
      <span class="icon-default">
        <svg viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="none">
  <path stroke="#f3f3f3" stroke-width="12" d="m68 60 80-14M68 60v91m0-91V40.722a8 8 0 0 1 6.621-7.88l64-11.2c4.895-.857 9.379 2.91 9.379 7.88V46m0 0v89m-98.477.234-8.48 1.483A15.761 15.761 0 0 0 28 152.242c0 9.791 8.833 17.212 18.477 15.524l8.48-1.483A15.761 15.761 0 0 0 68 150.758c0-9.791-8.833-17.212-18.477-15.524Zm80-16-8.479 1.483A15.761 15.761 0 0 0 108 136.242c0 9.791 8.833 17.212 18.477 15.524l8.479-1.483A15.761 15.761 0 0 0 148 134.758c0-9.791-8.833-17.212-18.477-15.524Z"/>
</svg>
      </span>
      <span class="icon-hover">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Apple Music" role="img" viewBox="0 0 512 512" fill="#000000">
          <rect width="512" height="512" rx="15%" fill="url(#g)"></rect>
          <linearGradient id="g" x1=".5" y1=".99" x2=".5" y2=".02">
            <stop offset="0" stop-color="#FA233B"></stop>
            <stop offset="1" stop-color="#FB5C74"></stop>
          </linearGradient>
          <path fill="#ffffff" d="M199 359V199q0-9 10-11l138-28q11-2 12 10v122q0 15-45 20c-57 9-48 105 30 79 30-11 35-40 35-69V88s0-20-17-15l-170 35s-13 2-13 18v203q0 15-45 20c-57 9-48 105 30 79 30-11 35-40 35-69"/>
        </svg>
      </span>
    </a>
  </span>
</h3>

            <p class="alb-artist">${renderArtists(i, album)}</p>
            <p class="alb-genres">${joinedGenres}</p>
          </div>
        </div>

        <hr class="alb-sep">

        <div class="alb-meta">
          <p><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="#f3f3f3" d="M9 2a8 8 0 0 1 7.934 6.965l2.25 3.539c.148.233.118.58-.225.728L17 14.07V17a2 2 0 0 1-2 2h-1.999L13 22H4v-3.694c0-1.18-.436-2.297-1.244-3.305A8 8 0 0 1 9 2m12.154 16.102l-1.665-1.11A8.96 8.96 0 0 0 21 12a8.96 8.96 0 0 0-1.51-4.993l1.664-1.11A10.95 10.95 0 0 1 23 12c0 2.258-.68 4.356-1.846 6.102"/></svg> ${langText}</p>

          <p><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="#f3f3f3" d="M7.75 2.5a.75.75 0 0 0-1.5 0v1.58c-1.44.115-2.384.397-3.078 1.092c-.695.694-.977 1.639-1.093 3.078h19.842c-.116-1.44-.398-2.384-1.093-3.078c-.694-.695-1.639-.977-3.078-1.093V2.5a.75.75 0 0 0-1.5 0v1.513C15.585 4 14.839 4 14 4h-4c-.839 0-1.585 0-2.25.013z"/><path fill="#f3f3f3" fill-rule="evenodd" d="M2 12c0-.839 0-1.585.013-2.25h19.974C22 10.415 22 11.161 22 12v2c0 3.771 0 5.657-1.172 6.828S17.771 22 14 22h-4c-3.771 0-5.657 0-6.828-1.172S2 17.771 2 14zm15 2a1 1 0 1 0 0-2a1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2a1 1 0 0 0 0 2m-4-5a1 1 0 1 1-2 0a1 1 0 0 1 2 0m0 4a1 1 0 1 1-2 0a1 1 0 0 1 2 0m-6-3a1 1 0 1 0 0-2a1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2a1 1 0 0 0 0 2" clip-rule="evenodd"/></svg> ${album.date}</p>

          <p><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="#f3f3f3" d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7.256A4.5 4.5 0 0 0 12.5 8a4.5 4.5 0 0 0-3.59 1.787A.5.5 0 0 0 9 9.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .39-.187A4.5 4.5 0 0 0 8.027 12H6.5a.5.5 0 0 0-.5.5V16H3a1 1 0 0 1-1-1zm2 1.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5m3 0v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5m3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zM4 5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5M7.5 5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm2.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5M4.5 8a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"/><circle cx="12.5" cy="12.5" r="3.5" fill="#f3f3f3"/><path fill="#282626" d="M20.82 6.49v1a3 3 0 0 1-.32 1.34a3 3 0 0 1-.87 1.07a3.1 3.1 0 0 1-1.25.57q-.301.06-.61.06q-.391 0-.77-.09l-4.24-1.2v8.22a4.79 4.79 0 1 1-1.5-3.47V2.46a.6.6 0 0 1 0-.2v-.08a.76.76 0 0 1 .54-.44h.44l6.3 1.79a3 3 0 0 1 2.22 2.93z" transform="translate(9.5 9.5) scale(0.25)"/></svg>
  <span class="label-wrapper">
    ${album.label || '-'}
    <span id="label-cross-${i}" class="blacklist-cross" data-type="label" data-name="${album.label}" style="cursor:pointer;">✖</span>
  </span>
</p>

          <p><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 48 48"><defs><mask id="ipSTime0"><g fill="none" stroke-linejoin="round" stroke-width="4"><path fill="#fff" stroke="#fff" d="M24 44c11.046 0 20-8.954 20-20S35.046 4 24 4S4 12.954 4 24s8.954 20 20 20Z"/><path stroke="#000" stroke-linecap="round" d="M24.008 12v12.01l8.479 8.48"/></g></mask></defs><path fill="#f3f3f3" d="M0 0h48v48H0z" mask="url(#ipSTime0)"/></svg> ${album.duration}</p>
        </div>

        <div class="alb-footer">
          <button class="mark-listened-btn" onclick="markAlbumAsListened('${album.albumID}', this.closest('.album'))">
            ${album.listened ? 'Позначити як не прослуханий' : 'Позначити як прослуханий'}
          </button>
          <span id="listens-${i}" class="alb-listens"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20"><path fill="#f3f3f3" d="M5.312 4.566C4.19 5.685-.715 12.681 3.523 16.918c4.236 4.238 11.23-.668 12.354-1.789c1.121-1.119-.335-4.395-3.252-7.312c-2.919-2.919-6.191-4.376-7.313-3.251m9.264 9.59c-.332.328-2.895-.457-5.364-2.928c-2.467-2.469-3.256-5.033-2.924-5.363c.328-.332 2.894.457 5.36 2.926c2.471 2.467 3.258 5.033 2.928 5.365m.858-8.174l1.904-1.906a.999.999 0 1 0-1.414-1.414L14.02 4.568a.999.999 0 1 0 1.414 1.414M11.124 3.8a1 1 0 0 0 1.36-.388l1.087-1.926a1 1 0 0 0-1.748-.972L10.736 2.44a1 1 0 0 0 .388 1.36m8.748 3.016a1 1 0 0 0-1.36-.388l-1.94 1.061a1 1 0 1 0 .972 1.748l1.94-1.061a1 1 0 0 0 .388-1.36"/></svg> ${formatListens(album.listens)}
</span>
        </div>
      </div>

      <div class="tracks" id="tracks-${i}"></div>
    `;

    const favButton = document.createElement('div');
favButton.classList.add('favorite-button');
favButton.innerHTML = `
  <div class="favorite-icon">
    <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
      <path fill="#84AAFB" d="M34,9c-4.2,0-7.9,2.1-10,5.4C21.9,11.1,18.2,9,14,9C7.4,9,2,14.4,2,21c0,11.9,22,24,22,24s22-12,22-24C46,14.4,40.6,9,34,9z"/>
    </svg>
  </div>
`;
    
    const checkmark = document.createElement('div');
checkmark.classList.add('favorite-checkmark');
checkmark.textContent = '✓';
checkmark.style.display = favoriteAlbums[album.albumID] ? 'block' : 'none';
favButton.appendChild(checkmark);
    
attachTooltip(favButton, favoriteAlbums[album.albumID]
  ? 'Прибрати альбом з обраного'
  : 'Додати альбом в обране', '180px');

favButton.addEventListener('click', (e) => {
  e.stopPropagation();

  favButton.classList.add('clicked');
  setTimeout(() => favButton.classList.remove('clicked'), 150);

  if (favoriteAlbums[album.albumID]) {
    delete favoriteAlbums[album.albumID];
    checkmark.style.display = 'none';
  } else {
    favoriteAlbums[album.albumID] = true;
    checkmark.style.display = 'block';
  }

  localStorage.setItem('favoriteAlbums', JSON.stringify(favoriteAlbums));
  updateFavoritesModal();

  removeTooltip(favButton);
  attachTooltip(favButton, favoriteAlbums[album.albumID]
    ? 'Прибрати альбом з обраного'
    : 'Додати альбом в обране');
});

albumDiv.appendChild(favButton);
    
    const spotifyIcon = albumDiv.querySelector('.spotify-icon');
if (spotifyIcon) attachTooltip(spotifyIcon, 'Відкрити в Spotify', '160px');

const ytIcon = albumDiv.querySelector('.yt-icon');
if (ytIcon) attachTooltip(ytIcon, 'Шукати в YouTube Music', '160px');

const appleIcon = albumDiv.querySelector('.apple-icon');
if (appleIcon) attachTooltip(appleIcon, 'Шукати в Apple Music', '160px');
    
    if (album.good) {
      const starBox = document.createElement('div');
      starBox.style.position   = 'absolute';
      starBox.style.top        = '10px';
      starBox.style.right      = '10px';
      starBox.style.fontSize   = '24px';
      starBox.style.zIndex     = '11';
      starBox.innerHTML        = '<i class="fas fa-star star-icon" style="color:gold;"></i>';
      attachTooltip(starBox, 'NUAM рекомендує цей альбом для прослуховування');
      albumDiv.appendChild(starBox);
    }

    const nextAlbum = [...container.children].find(div => {
  const idx = filteredAlbums.findIndex(a => a.albumID === div.dataset.albumId);
  return idx > i;
});

if (nextAlbum) {
  container.insertBefore(albumDiv, nextAlbum);
} else {
  container.appendChild(albumDiv);
}

    albumDiv.querySelector('img').addEventListener('click', function () {
      const imgSrc        = this.src;
      const enlargedPrev  = document.querySelector('.enlarged-img');
      const modalOverlay  = document.querySelector('.modal-overlay');
      if (enlargedPrev) {
        enlargedPrev.remove();
        modalOverlay.style.display = 'none';
        document.body.classList.remove('no-scroll');
        document.body.style.top = '';
        window.scrollTo(0, parseInt(document.body.style.top || '0') * -1);
        return;
      }
      const scrollY = window.scrollY;
      const enlargedImg = document.createElement('img');
      enlargedImg.src = imgSrc;
      enlargedImg.classList.add('enlarged-img');
      document.body.appendChild(enlargedImg);
      requestAnimationFrame(() => enlargedImg.classList.add('shown'));

      modalOverlay.style.display = 'block';
      document.body.classList.add('no-scroll');
      document.body.style.top = `-${scrollY}px`;

      const closeImg = () => {
        enlargedImg.remove();
        modalOverlay.style.display = 'none';
        document.body.classList.remove('no-scroll');
        document.body.style.top = '';
        window.scrollTo(0, scrollY);
      };
      enlargedImg.addEventListener('click', closeImg);
      modalOverlay.addEventListener('click', closeImg);
    });

    const tracksContainer = document.getElementById(`tracks-${i}`);
    album.tracksIDs.forEach((trackID, idx) => {
      const mp3hash = album.tracksMP3[idx] || '';
      if (!trackID || !mp3hash) return;
      const trackLink    = `https://open.spotify.com/track/${trackID}`;
      const trackPreview = `https://p.scdn.co/mp3-preview/${mp3hash}`;

      const circle = document.createElement('a');
      circle.classList.add('track-circle');
      circle.href   = trackLink;
      circle.target = '_blank';
      circle.innerHTML = '<i class="fas fa-music"></i>';

      const audio = document.createElement('audio');
      audio.src = trackPreview;
      circle.appendChild(audio);

      attachTrackBehavior(circle, audio, album, albumDiv);
      tracksContainer.appendChild(circle);
    });

   const listensEl = document.getElementById(`listens-${i}`);
if (album.listens === 0) {
  attachTooltip(listensEl, 'Жоден трек не набрав понад 1000 прослуховувань');
} else {
  attachTooltip(listensEl, 'Загальна кількість прослуховувань всіх треків релізу');
}

    const labelCrossEl = document.getElementById(`label-cross-${i}`);
if (labelCrossEl) {
  attachTooltip(labelCrossEl, 'Не показувати альбоми цього лейбла');
  labelCrossEl.addEventListener('click', function() {
    removeTooltip(labelCrossEl);
    blacklistedLabels.add(album.label);
    localStorage.setItem('blacklistedLabels', JSON.stringify([...blacklistedLabels]));
    albumsData.forEach(alb => {
      if (alb.label === album.label) {
        hideAlbum(alb.albumID);
      }
    });
    forceLazyLoadCheck();
  });
}

    albumDiv.querySelectorAll('.blacklist-cross[data-type="artist"]').forEach(cross => {
  attachTooltip(cross, 'Не показувати альбоми цього артиста');
  cross.addEventListener('click', () => {
    const name = cross.dataset.name;
    removeTooltip(cross);
    blacklistedArtists.add(cross.dataset.name);
    localStorage.setItem('blacklistedArtists', JSON.stringify([...blacklistedArtists]));
    albumsData.forEach(album => {
      if (album.artistIDs.includes(name)) {
  hideAlbum(album.albumID);
}
    });
    forceLazyLoadCheck();
  });
});
  }

  currentIndex = endIndex;
  document.getElementById('lazy-loading').textContent =
    currentIndex >= data.length
      ? 'Більше немає альбомів для завантаження'
      : 'Завантаження альбомів...';
}

    function renderArtists(index, album) {
  const fragment = document.createDocumentFragment();

  album.artistNames.forEach((artist, i) => {
    const wrapper = document.createElement('span');
    wrapper.style.whiteSpace = 'nowrap';

    const artistLink = document.createElement('a');
    artistLink.textContent = artist;
    artistLink.href = `https://open.spotify.com/artist/${album.artistIDs[i] || ''}`;
    artistLink.target = '_blank';
    artistLink.style.color = '#f3f3f3';
    artistLink.style.textDecoration = 'none';
    artistLink.style.fontWeight = 'bold';

    const crossSpan = document.createElement('span');
    crossSpan.id = `artist-cross-${index}-${i}`;
    crossSpan.classList.add('blacklist-cross');
    crossSpan.dataset.type = 'artist';
    crossSpan.dataset.name = album.artistIDs[i];
    crossSpan.style.cursor = 'pointer';
    crossSpan.textContent = ' ✖';

    wrapper.appendChild(artist === 'Various Artists' ? document.createTextNode(artist) : artistLink);
    wrapper.appendChild(crossSpan);

    fragment.appendChild(wrapper);

    if (i < album.artistNames.length - 1) {
      const comma = document.createElement('span');
      comma.textContent = ', ';
      fragment.appendChild(comma);
    }
  });

  const div = document.createElement('div');
  div.appendChild(fragment);
  return div.innerHTML;
}

    function hideAlbum(albumID) {
  const albumDiv = document.querySelector(`.album[data-album-id="${albumID}"]`);
  if (albumDiv) {
    albumDiv.style.transition = 'opacity 0.3s';
    albumDiv.style.opacity = '0';
    setTimeout(() => {
      albumDiv.remove();
    }, 300);
  }
}

function showAlbum(album) {
  const container = document.getElementById('albums-container');
  const albumDiv = document.createElement('div');
  albumDiv.classList.add('album');
  albumDiv.style.opacity = '0';
  albumDiv.dataset.albumId = album.albumID;
  albumDiv.innerHTML = `
    <div class="album-overlay"></div>
    <img src="https://i.scdn.co/image/ab67616d0000b273${album.cover}" alt="${album.nameAlbum}">
    <div class="album-details">
      <div class="alb-head">
        ${releaseIcon(album.type)}
        <div class="alb-head-txt">
          <h3><a href="https://open.spotify.com/album/${album.albumID}" target="_blank">${album.nameAlbum}</a></h3>
          <p class="alb-artist">${renderArtists(0, album)}</p>
          <p class="alb-genres">${album.genres.map(friendlyGenreLabel).join(', ') || 'Немає даних'}</p>
        </div>
      </div>
      <hr class="alb-sep">
      <div class="alb-meta">
        <p>${album.date}</p>
        <p>${album.label || '-'}</p>
        <p>${album.duration || '-'}</p>
      </div>
    </div>
  `;
  container.appendChild(albumDiv);

  requestAnimationFrame(() => {
    albumDiv.style.transition = 'opacity 0.3s';
    albumDiv.style.opacity = '1';
  });
}

    function renderReleaseType(t) {
      if (t === 'album') return 'повноформатний альбом';
      if (t === 'ep') return 'міні-альбом';
      if (t === 'compilation') return 'компіляція';
      return t;
    }

    function attachTrackBehavior(circle, audio, album, albumDiv) {
      let tooltipShown = false;
      const tipText = 'Натисніть для відтворення уривка. Далі просто наводьте курсор на треки.';

      circle.addEventListener('mouseenter', (e) => {
        if (!audioActivated) {
          showSimpleTooltip(e.clientX, e.clientY, tipText);
        } else {
          audio.play().catch(err => {
  if (err.name !== 'AbortError') {
    console.error('Audio play error:', err);
  }
});
        }
      });
      
      circle.addEventListener('mousemove', (e) => {
        if (!audioActivated) {
          moveSimpleTooltip(e.clientX, e.clientY);
        }
      });
      
      circle.addEventListener('mouseleave', () => {
        hideSimpleTooltip();
        if (audioActivated) {
          if (!audio.paused) {
  audio.pause();
  audio.currentTime = 0;
}
        }
      });
      
      circle.addEventListener('click', (evt) => {
        if (!audioActivated) {
          evt.preventDefault();
          audioActivated = true;
          hideSimpleTooltip();
          audio.play();
        }
      });

      audio.addEventListener('pause', () => {
      });
    }

    function removeTooltip(element) {
      element.dispatchEvent(new Event('mouseleave'));
    }

    function markAlbumAsListened(albumID, albumElement, fromModal = false) {
  const album = albumsData.find(a => a.albumID === albumID);
  if (!album) return;

  if (fromModal) {
    delete listenedAlbums[albumID];
    album.listened = false;
  } else {
    album.listened = !album.listened;
    if (album.listened) {
      listenedAlbums[albumID] = true;
    } else {
      delete listenedAlbums[albumID];
    }
  }

  saveListenedAlbums();
  updateListenedAlbumsModal();

  if (albumElement) {
    const markButton = albumElement.querySelector('.mark-listened-btn');
    markButton.textContent = album.listened
      ? 'Позначити як не прослуханий'
      : 'Позначити як прослуханний';

    albumElement.classList.toggle('album-listened', album.listened);

    if (hideListened && album.listened) {
      albumElement.style.transition = 'opacity 0.3s';
      albumElement.style.opacity = '0';
      setTimeout(() => {
        albumElement.remove();
        forceLazyLoadCheck();
      }, 300);
    } else if (!album.listened && hideListened) {

      const reFiltered = getFilteredAlbums();
      const index = reFiltered.findIndex(a => a.albumID === albumID);
      if (index === -1) return;

      if (sortOrder === 'listens-desc') {
        reFiltered.sort((a, b) => b.listens - a.listens);
      } else {
        reFiltered.sort((a, b) => {
          const da = new Date(a.date);
          const db = new Date(b.date);
          return sortOrder === 'asc' ? da - db : db - da;
        });
      }

      const container = document.getElementById('albums-container');
      const allDom = [...container.querySelectorAll('.album')];
      const nextDom = allDom.find(div => {
        const idx = reFiltered.findIndex(a => a.albumID === div.dataset.albumId);
        return idx > index;
      });

      const dummy = document.createElement('div');
      container.insertBefore(dummy, nextDom || null);
      const prevIndex = currentIndex;
      currentIndex = index;
      renderAlbums(reFiltered.slice(index, index + 1), false);
      dummy.remove();
      currentIndex = prevIndex;
    }
    return;
  }
  preserveScroll(() => applyFilters());
}

    function saveListenedAlbums() {
      for (const key in listenedAlbums) {
        if (!listenedAlbums[key]) {
          delete listenedAlbums[key];
        }
      }
      localStorage.setItem('listenedAlbums', JSON.stringify(listenedAlbums));
    }

    function showBlacklist(isBlacklist = true) {
      const modal = document.getElementById('blacklist-modal');
      const closeBtn = modal.querySelector('.close');
      modal.style.display = 'block';
      closeBtn.onclick = () => { modal.style.display = 'none'; };
      window.onclick = (ev) => {
        if (ev.target == modal) {
          modal.style.display = 'none';
        }
      };
      if (isBlacklist) {
        document.getElementById('blacklist-tab').click();
      } else {
        document.getElementById('listened-albums-tab').click();
      }
    }

    function openTab(evt, tabName) {
      const tablinks = document.querySelectorAll('.tablink');
      const tabcontents = document.querySelectorAll('.tabcontent');
      tabcontents.forEach(tb => tb.classList.remove('active'));
      tablinks.forEach(ln => ln.classList.remove('active'));

      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');

      if (tabName === 'blacklist-content') {
        updateBlacklist();
      } else if (tabName === 'listened-albums-content') {
        updateListenedAlbumsModal();
      } else if (tabName === 'export-content') {
        const dataTextarea = document.getElementById('data-textarea');
        dataTextarea.value = generateExportData();
      }
    }

    function updateBlacklist() {
  const artistsList = document.getElementById('blacklisted-artists');
  const labelsList = document.getElementById('blacklisted-labels');
  artistsList.innerHTML = '';
  labelsList.innerHTML = '';

  if (blacklistedArtists.size === 0) {
    const msg = document.createElement('p');
    msg.textContent = 'Тут будуть вилучені вами артисти.';
    msg.style.textAlign = 'center';
    msg.style.color = '#f3f3f3';
    artistsList.appendChild(msg);
  } else {
    blacklistedArtists.forEach(artistID => {
  const artistName = albumsData.find(a => a.artistIDs?.includes(artistID))?.artistNames?.[albumsData.find(a => a.artistIDs?.includes(artistID))?.artistIDs.indexOf(artistID)] || 'Unknown Artist';

      const li = document.createElement('li');
      const sp = document.createElement('span');
      if (artistName !== 'Various Artists') {
  const link = document.createElement('a');
  link.href = `https://open.spotify.com/artist/${artistID}`;
  link.target = '_blank';
  link.textContent = artistName;
  link.style.color = '#f3f3f3';
  link.style.textDecoration = 'none';
  link.addEventListener('mouseover', () => link.style.textDecoration = 'underline');
  link.addEventListener('mouseout', () => link.style.textDecoration = 'none');
  sp.appendChild(link);
} else {
  sp.textContent = artistName;
}
      sp.style.color = '#f3f3f3';

      const removeIcon = document.createElement('span');
      removeIcon.textContent = '✖';
      removeIcon.classList.add('blacklist-cross');
      removeIcon.addEventListener('click', () => {
        blacklistedArtists.delete(artistID);

        localStorage.setItem('blacklistedArtists', JSON.stringify(Array.from(blacklistedArtists)));
        li.remove();

        const albumsContainer = document.getElementById('albums-container');
        smoothApplyFilters();
         forceLazyLoadCheck();
      });

      li.appendChild(sp);
      li.appendChild(removeIcon);
      artistsList.appendChild(li);
    });
  }

  if (blacklistedLabels.size === 0) {
    const msg2 = document.createElement('p');
    msg2.textContent = 'Тут будуть вилучені вами лейбли.';
    msg2.style.textAlign = 'center';
    msg2.style.color = '#f3f3f3';
    labelsList.appendChild(msg2);
  } else {
    blacklistedLabels.forEach(label => {
      const li = document.createElement('li');
      const sp = document.createElement('span');
      sp.textContent = label;
      sp.style.color = '#f3f3f3';

      const removeIcon = document.createElement('span');
      removeIcon.textContent = '✖';
      removeIcon.classList.add('blacklist-cross');
      removeIcon.addEventListener('click', () => {
        blacklistedLabels.delete(label);
        localStorage.setItem('blacklistedLabels', JSON.stringify(Array.from(blacklistedLabels)));
        li.remove();

        const albumsContainer = document.getElementById('albums-container');
        smoothApplyFilters();
        forceLazyLoadCheck();
      });

      li.appendChild(sp);
      li.appendChild(removeIcon);
      labelsList.appendChild(li);
    });
  }
}

    function updateListenedAlbumsModal() {
      const list = document.getElementById('listened-albums-list');
      list.innerHTML = '';

      const listenedArr = albumsData.filter(al => al.listened);
      if (listenedArr.length === 0) {
        const msg = document.createElement('p');
        msg.textContent = 'Тут буде список відслуханих вами альбомів.';
        msg.style.textAlign = 'center';
        msg.style.color = '#f3f3f3';
        list.appendChild(msg);
      } else {
        listenedArr.forEach(al => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          const link = `https://open.spotify.com/album/${al.albumID}`;
          a.href = link;
          a.target = '_blank';
          a.textContent = `${al.artistNames.join(', ')} – ${al.nameAlbum}`;
          a.style.cursor = 'pointer';

          const removeIcon = document.createElement('span');
          removeIcon.textContent = '✖';
          removeIcon.classList.add('blacklist-cross');
          removeIcon.style.cursor = 'pointer';
          removeIcon.style.marginLeft = '10px';
          removeIcon.addEventListener('click', () => {
            markAlbumAsListened(al.albumID, null, true);
            li.remove();
            forceLazyLoadCheck();
          });

          li.appendChild(a);
          li.appendChild(removeIcon);
          list.appendChild(li);
        });
      }
    }

    function generateExportData() {
      const obj = {
        blacklistArtists: Array.from(blacklistedArtists),
        blacklistLabels: Array.from(blacklistedLabels),
        listenedAlbums: JSON.parse(localStorage.getItem('listenedAlbums')) || {},
        favoriteAlbums: JSON.parse(localStorage.getItem('favoriteAlbums')) || {},
        albumFilters: JSON.parse(localStorage.getItem('albumFilters')) || {}
      };
      return JSON.stringify(obj, null, 2);
    }

    function attachTooltip(element, text, width = '120px') {
  element._tooltip = null;

  element.addEventListener('mouseenter', (ev) => {
    if (!element._tooltip) {
      const tip = document.createElement('div');
      tip.classList.add('tooltip');
      tip.textContent = text;
      tip.style.position = 'fixed';
      tip.style.backgroundColor = '#333';
      tip.style.color = '#f3f3f3';
      tip.style.padding = '5px 10px';
      tip.style.borderRadius = '7px';
      tip.style.fontSize = '12px';
      tip.style.whiteSpace = 'normal';
      tip.style.maxWidth = width;
      tip.style.zIndex = '9999';
      document.body.appendChild(tip);
      element._tooltip = tip;
    }

    const tip = element._tooltip;
    tip.style.visibility = 'visible';
    positionTooltip(ev.clientX, ev.clientY, tip);
  });

  element.addEventListener('mousemove', (ev) => {
    const tip = element._tooltip;
    if (tip && tip.style.visibility === 'visible') {
      positionTooltip(ev.clientX, ev.clientY, tip);
    }
  });

  element.addEventListener('mouseleave', () => {
    const tip = element._tooltip;
    if (tip) {
      tip.remove();
      element._tooltip = null;
    }
  });
}

    function positionTooltip(x, y, tip) {
      const rect = tip.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      let tx = x + 10;
      let ty = y + 10;
      if (tx + rect.width > vw) tx = x - rect.width - 10;
      if (ty + rect.height > vh) ty = y - rect.height - 10;
      tip.style.top = `${ty}px`;
      tip.style.left = `${tx}px`;
    }

    let simpleTooltip = null;
    function showSimpleTooltip(x, y, text) {
      if (!simpleTooltip) {
        simpleTooltip = document.createElement('div');
        simpleTooltip.style.position = 'fixed';
        simpleTooltip.style.backgroundColor = '#333';
        simpleTooltip.style.color = '#f3f3f3';
        simpleTooltip.style.padding = '5px 10px';
        simpleTooltip.style.borderRadius = '7px';
        simpleTooltip.style.fontSize = '12px';
        simpleTooltip.style.visibility = 'hidden';
        simpleTooltip.style.whiteSpace = 'normal';
        simpleTooltip.style.maxWidth = '200px';
        simpleTooltip.style.zIndex = '9999';
        document.body.appendChild(simpleTooltip);
      }
      simpleTooltip.textContent = text;
      simpleTooltip.style.visibility = 'visible';
      positionTooltip(x, y, simpleTooltip);
    }
    function moveSimpleTooltip(x, y) {
      if (simpleTooltip && simpleTooltip.style.visibility === 'visible') {
        positionTooltip(x, y, simpleTooltip);
      }
    }
    function hideSimpleTooltip() {
      if (simpleTooltip) {
        simpleTooltip.style.visibility = 'hidden';
      }
    }
    
    function preserveScroll(callback) {
  const container = document.getElementById('albums-container');
  const anchor = [...container.children].find(el => el.getBoundingClientRect().top >= 0);
  const anchorId = anchor?.dataset?.albumId;
  const offset = anchor?.getBoundingClientRect().top || 0;

  callback();

  requestAnimationFrame(() => {
    if (anchorId) {
      const newAnchor = container.querySelector(`[data-album-id="${anchorId}"]`);
      if (newAnchor) {
        const newOffset = newAnchor.getBoundingClientRect().top;
        const scrollY = window.scrollY + (newOffset - offset);
        window.scrollTo(0, scrollY);
      }
    }
  });
}
   
    function smoothApplyFilters() {
  isFiltering = true;
  const container = document.getElementById('albums-container');

  window.removeEventListener('scroll', handleScroll);
  container.style.transition = 'opacity 0.2s';
  container.style.opacity = '0.3';

  setTimeout(() => {
    preserveScroll(() => applyFilters());

    requestAnimationFrame(() => {
      container.style.opacity = '1';
      isFiltering = false;
      window.addEventListener('scroll', throttle(handleScroll, 200));
    });
  }, 50);
}

    function updateFavoritesModal() {
  const list = document.getElementById('favorites-albums-list');
  list.innerHTML = '';
  const favArr = albumsData.filter(al => favoriteAlbums[al.albumID]);
  if (favArr.length === 0) {
    const msg = document.createElement('p');
    msg.textContent = 'Тут буде список ваших улюблених альбомів.';
    msg.style.textAlign = 'center';
    msg.style.color = '#f3f3f3';
    list.appendChild(msg);
  } else {
    favArr.forEach(al => {
      const li = document.createElement('li');

      const img = document.createElement('img');
      img.src = `https://i.scdn.co/image/ab67616d0000b273${al.cover}`;
      img.alt = al.nameAlbum;

      const a = document.createElement('a');
      a.href = `https://open.spotify.com/album/${al.albumID}`;
      a.target = '_blank';
      a.textContent = `${al.artistNames.join(', ')} – ${al.nameAlbum}`;
      a.style.color = '#f3f3f3';
     
      const removeIcon = document.createElement('span');
      removeIcon.textContent = '✖';
      removeIcon.classList.add('blacklist-cross');
      removeIcon.style.cursor = 'pointer';
      removeIcon.style.marginLeft = 'auto';
      removeIcon.addEventListener('click', () => {
        delete favoriteAlbums[al.albumID];
        localStorage.setItem('favoriteAlbums', JSON.stringify(favoriteAlbums));
        updateFavoritesModal();
      });

      li.appendChild(img);
      li.appendChild(a);
      li.appendChild(removeIcon);
      list.appendChild(li);
    });
  }
}

  </script>
</body>
</html>
