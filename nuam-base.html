<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUAM Base</title>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.18.0/clusterize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.0/nouislider.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.0/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  
    <style>
      @font-face {
         font-family: 'CustomFont';
         src: url('https://static.wixstatic.com/ufonts/c77f36_8e332f6e48954416a7131ece2e2fab0f/woff2/file.woff2') format('woff2');
    }
     html, body {
            font-family: 'CustomFont', Arial, sans-serif;
            color: #f3f3f3;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
       min-width: 1220px;
        }
      
.custom-checkbox input[type="checkbox"] {
    display: none;
}

.custom-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-family: 'CustomFont', Arial, sans-serif;
    color: #f3f3f3;
    margin-bottom: 10px;
    font-size: 16px;
    width: fit-content;
}

.custom-checkbox .checkbox-icon {
    position: relative;
    width: 20px;
    height: 20px;
    border: 1px solid #f3f3f3;
    border-radius: 7px;
    background-color: #282626;
    transition: background-color 0.3s, border-color 0.3s;
    margin-right: 10px;
}
      
   .custom-checkbox .checkbox-icon:hover {
    border: 1px solid #84AAFB;
}   
      
.custom-checkbox input[type="checkbox"]:checked + .checkbox-icon {
    background-color: #282626;
    border-color: #84AAFB;
}

.custom-checkbox .checkbox-icon::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    color: #f3f3f3;
    font-size: 16px;
    text-align: center;
    line-height: 23px;
    opacity: 0;
    transition: opacity 0.3s;
}

.custom-checkbox input[type="checkbox"]:checked + .checkbox-icon::after {
    opacity: 1;
}

.custom-checkbox .checkbox-text {
    margin-top: 2px;
}
      
       #main-container {
            height: 100%;
            display: flex;
            flex-direction: column;
         justify-content: center;
        }
      
      #main {
            max-height: 100%;
            overflow-y: auto;
            overflow-x: none;
        }
      
      ::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #282626;
}

::-webkit-scrollbar-thumb {
  background: #383838;
}

      #logo {
  height: 30px;
        top: 4px;
  margin-right: 20px;
        margin-left: 20px;
}
      
      #artist-section .artist-container {
        border-top: 4px solid #282626;
}
      
    #artist-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
      
       #artist-scroll-container {
            flex: 1;
            overflow-y: auto;
        }

      .artist-container {
            padding-bottom: 20px;
        }
      
.artist-scroll-container::-webkit-scrollbar {
    width: 14px;
}

.artist-scroll-container::-webkit-scrollbar-track {
    background: #282626;
}

.artist-scroll-container::-webkit-scrollbar-thumb {
    background-color: #383838;
    border-radius: 6px;
    border: 3px solid #282626;
}
      
      img {
    -webkit-user-drag: none;
    user-drag: none;
}
        
      #filter-section {
    display: flex;
    background-color: #282626;
    justify-content: space-between;
    align-items: center;
    padding: 20px 20px 20px 20px;
    position: relative;
    z-index: 1;
    user-select: none !important;
}
     
#list-container {
    height: 500px;
    overflow-y: auto;
}

.list-item {
    height: 100px;
    border-bottom: 1px solid #444;
}

#genre-button, #sort-button, #filters-button {
    position: relative;
    background-color: #f3f3f3;
    color: #282626;
    font-size: 16px;
    font-weight: bold;
    border: 2px solid #f3f3f3;
    padding: 10px 20px;
    cursor: pointer;
    border-radius: 7px 7px 0 0;
    transition: color 0.3s ease, background 0.3s ease, border 0.3s ease;
    z-index: 200;
}

#genre-button:hover, #sort-button:hover, #filters-button:hover {
      border: 2px solid #84AAFB;
      } 

#genre-button.active, #sort-button.active, #filters-button.active {
    background-color: #f3f3f3;
    border-radius: 7px 7px 0 0;
    border: 2px solid #84AAFB;
}

      #genre-button i, #sort-button i, #filters-button i {
    margin-right: 8px;
    color: #282626;
}
      
#genres-section, #sort-section, #filters-section {
    display: block;
    position: relative;
    flex-direction: column;
    background-color: #383838;
    padding: 0 20px;
    color: #282626;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
    user-select: none !important;
}

#genres-section.expanded, #sort-section.expanded, #filters-section.expanded {
  display: block;
    max-height: 1000px;
    padding: 20px;
}

#genres-section.expanding {
    transition: max-height 0.5s ease, padding 0.5s ease;
}

      #genres-section.expanding .hidden-genre {
    transition: max-height 0.5s ease, padding 0.5s ease;
}
           
#genres-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    transition: all 0.3s;
    user-select: none !important;
}
   
:root {
    --genre-button-color: #282626;
    --genre-button-hover-color: #90EE90;
    --hidden-genre-shadow-color: #f3f3f3;
}

.genre-button {
    width: 136px;
    height: 20px;
    padding: 0 10px;
    background-color: var(--genre-button-color);
    color: #f3f3f3;
    border: none;
    cursor: pointer;
    position: relative;
    border-radius: 5px;
    line-height: 20px;
    transition: background-color 0.3s, color 0.3s, box-shadow 0.25s, transform 0.25s;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.genre-button:hover:not(.selected) {
    box-shadow: 0 0.5em 0.5em -0.4em var(--genre-button-hover-color);
    transform: translateY(0.25em);
}

.genre-button.selected {
    background-color: #90EE90;
    color: #383838;
    box-shadow: none;
    transform: none;
}

.genre-button:active {
    box-shadow: none;
    transform: none;
}

.genre-button.removed {
    background-color: #fb8484;
    color: #f3f3f3;
    box-shadow: none !important;
    transform: none !important;
}

.genre-button .remove-genre {
    position: absolute;
    height: 20px;
    top: 50%;
    border-radius: 0 5px 5px 0px;
    right: 0;
    background-color: #e74c3c;
    color: #f3f3f3;
    border: none; 
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-50%);
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.genre-button:hover .remove-genre {
    opacity: 1;
    visibility: visible;
}

      .genre-button.red-shadow {
    box-shadow: 0 0.5em 0.5em -0.4em #fb8484 !important;
}

.genre-button.selected,
.genre-button.selected:hover,
.genre-button.removed,
.genre-button.removed:hover {
    box-shadow: none !important;
    transform: none !important;
}

      .genre-button.selected .remove-genre,
    .genre-button.removed .remove-genre {
        display: none;
    }
      
.remove-genre:hover {
    background-color: #c0392b;
}

.genre-button.gray-out {
    background-color: #383838;
    color: #575757;
    cursor: default;
    transition: none !important;
    transform: none !important;
    box-shadow: none !important;
}
      
.hidden {
    display: none !important;
}

.genre-button.show-more,
.genre-button.show-less,
.genre-button.toggle-genres {
    background-color: #f3f3f3;
    color: #282626;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s, box-shadow 0.25s, transform 0.25s;
}

.genre-button.show-more:hover,
.genre-button.show-less:hover,
.genre-button.toggle-genres:hover {
    box-shadow: 0 0.5em 0.5em -0.4em #f3f3f3;
    transform: translateY(0.25em);
}

.genre-button.toggle-genres.active {
    background-color: #90EE90 !important;
}

.genre-button.toggle-genres.expanded {
    background-color: #f3f3f3 !important;
}

    .date-added,
    .related-artists-button, .date-release {
        position: absolute;
        bottom: 0;
        background-color: #383838;
        color: #f3f3f3;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease;
        z-index: 10;
        display: flex;
        align-items: center;
        height: 40px;
      user-select: none !important;
    }

    .date-added, .date-release {
        height: 20px;
        width: 70px;
        bottom: 20px;
        left: 0;
        border-top: 1px solid #282626;
        border-right: 1px solid #282626;
        border-left: none;
        border-bottom: none;
        border-radius: 0 7px 0 0;
        padding: 0 10px;
        font-size: 10px;
        background-color: rgba(56, 56, 56, 0.8);
        cursor: auto;
        font-weight: normal;
        z-index: 1001;
    }
      
      .date-added span, .date-release span {
    top: 1px;
}
      
      .date-release {
        bottom: 0;
        border-left: none;
        border-top: none;
        border-radius: 0 0 0 7px;
    }

    .related-artists-button {
        right: 0;
        border-top: 1px solid #282626;
        border-left: 1px solid #282626;
        border-right: none;
        border-bottom: none;
        border-radius: 7px 0 7px 0;
        padding: 10px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease, background-color 0.2s ease, color 0.2s ease;
      display: inline-block;
    width: 120px;
    }

    .date-added i,
    .related-artists-button i, .date-release i {
        margin-right: 5px;
    }
      
      .date-added i, .date-release i {
    position: relative;
    top: 0;
    display: flex;
    align-items: center;
}
      
.related-artists-button:hover {
    background-color: #84AAFB;
    color: #282626;
}

      .artist:hover .related-artists-button {
    opacity: 1;
}
      
      .artist img.playing {
    box-shadow: 
        0 0 0 2px #88c8dc,
        0 0 0 4px #d5da8d;
    z-index: 1;
    position: relative;
}
      
.related-artists-container {
    position: absolute;
    top: 0;
    width: 204px;
    height: 154px;
    display: none;
    background-color: rgba(0, 0, 0, 0.7);
    color: #f3f3f3;
    padding: 10px; 
    border-radius: 7px 7px 0 0;
    overflow-y: auto;
    font-size: 14px;
    word-wrap: break-word;
  z-index: 1000;
}

.related-artists-container a.related-artist-link {
    color: #f3f3f3 !important;
    text-decoration: none !important;
    font-weight: normal !important;
    display: inline !important;
  font-size: 14px;
}

.related-artists-container a.related-artist-link:hover {
    text-decoration: underline !important;
}

.related-artists-container::-webkit-scrollbar {
    width: 10px;
}

.related-artists-container::-webkit-scrollbar-track {
    background: #282626;
    border-radius: 0 7px 0 0;
}

.related-artists-container::-webkit-scrollbar-thumb {
    background-color: #383838;
    border-radius: 6px;
    border-radius: 0 7px 0 0;
    border: 3px solid #282626;
}
      
      .no-related-artists {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    font-size: 14px;
    color: #f3f3f3;
    text-align: center;
    word-wrap: break-word;
}
      
      .no-tracks-message, .no-recent-tracks-message {
    color: #fb8484;
    text-align: center;
    margin-top: -188px;
    font-size: 14px;
    position: absolute;
    top: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    border-radius: 7px;
    width: 204px;
    left: 50%;
    transform: translateX(-50%);
    user-select: none !important;
    line-height: 1.2;
    padding-top: 5px;
    padding-bottom: 5px;
        z-index: 2;
}
      
.artist-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    padding: 0;
    margin: 0;
  background-color: #282626;
}

.artist {
    width: 228px;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.artist a {
    color: #84AAFB;
    font-weight: bold;
    text-decoration: none;
    display: block;
    font-size: 18px;
    text-align: center;
white-space: normal;
    word-wrap: break-word;
    line-height: 1.2;
  margin-top: 10px;
}

.artist a:hover {
    text-decoration: underline;
}

      .artist .genres-container {
    margin-bottom: 10px;
}
      
  .track-artist-name {
    display: inline-block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #84AAFB;
    padding: 0;
    margin: 0;
    font-weight: bold;
    text-align: center;
    text-decoration: none;
    width: fit-content;
}

.track-artist-name:hover {
    text-decoration: underline;
}
      
      .track-buttons {
    display: flex;
    align-items: center;
  }
  .prev-track, .next-track {
    flex-shrink: 0;
    color: #84AAFB;
  }
      
.listeners-element {
    display: flex;
    align-items: center;
    gap: 5px;
    line-height: 1.2;
    margin-top: 5px;
    margin-bottom: 5px;
    height: 20px;
  user-select: none !important;
}

.listeners-element .fa-users,
.listeners-element .fa-instagram,
.listeners-element span {
    margin: 0;
    padding: 0;
    vertical-align: middle;
    
}

      .listeners-element .fa-users {
        position: relative;
        top: -2px;
      }
      
.listeners-element .fa-instagram {
    font-size: 1.2em;
  margin-top: -9px !important;
}

.separator {
    margin: 0 5px;
    color: #383838;
}
 
     .genres-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    text-align: center;
}

.genre-link {
    display: inline-block;
    font-size: 12px;
    border: 1px solid #f3f3f3;
    border-radius: 7px;
    padding: 2px 6px;
    margin: 2px;
    color: #f3f3f3;
    transition: border-color 0.3s, background-color 0.3s, color 0.3s;
    cursor: pointer;
    line-height: 1.2;
    box-sizing: border-box;
  height: 20px;
  user-select: none !important;
}

.genre-button .genre-name {
    margin-right: auto;
}

.genre-button .genre-count {
    margin-left: auto;
}

.hidden-genre {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 136px;
    height: 20px;
    padding: 0 10px;
}

.genre-link:hover {
    border-color: #84AAFB;
    color: #84AAFB;
}
   
#controls-section {
    display: flex;
  width: 100%;  
  align-items: center;
    background-color: #282626;
    height: 40px;
    flex-wrap: wrap;
  padding-top: 20px;
}

#genre-button, #sort-button {
    margin-right: 5px;
}
          
.line {
    width: 100%;
    height: 1px;
    background-color: #f3f3f3;
    margin: 0;
    position: relative;
    order: 1;
  top: -1px;
  z-index: 201;
}
      
      .line2 {
    width: 100%;
    height: 1px;
    background-color: #383838;
    margin: 0;
    position: relative;

z-index: 3;
}
        
      .line3 {
    width: 100%;
    height: 1px;
    background-color: #383838;
    margin: 0;
    position: relative;
    order: 1;
    z-index: 200;
}
      
      #player-wrapper {
    display: none;
    align-items: center;
    justify-content: flex-end;
    width: 550px;
    height: 40px;
    margin-left: 0;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    background-color: #282626;
    border-radius: 7px 7px 0 0;
    z-index: 1002;
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.5);
}

#player-wrapper.show {
    display: flex;
}

#player-container {
    background-color: #383838;
    border-radius: 7px 0 0 0;
    padding: 5px;
    width: 500px;
    height: 40px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    justify-content: space-between;
    box-sizing: border-box;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    flex-grow: 0;
}

#player-container.show {
    opacity: 1;
}

#close-player {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #f3f3f3;
    transition: color 0.2s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    position: static;
    right: 10px;
    top: 50%;
    margin-left: 10px;
    margin-right: 5px;
}

.volume-icon {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #f3f3f3;
    transition: color 0.2s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    position: static;
    right: 50px;
    top: 50%;
    padding-top: 2px;
    margin-left: 10px;
    z-index: 10;
}

#close-player:hover,
.volume-icon:hover {
    color: #84AAFB;
}

.volume-slider {
    display: none;
    position: absolute;
    bottom: 50px;
    right: 35px;
    width: 20px;
    height: 150px;
    background-color: #383838;
    border-radius: 7px;
    border: 1px solid #282626;
    padding: 10px 5px 10px 5px;
    z-index: 999;
    display: flex;
    justify-content: center;
    align-items: center;
}

.volume-slider .noUi-target {
    width: 100%;
    height: 100%;
}

#volume-control .noUi-handle {
    background-color: #84AAFB;
    border: 1px solid #f3f3f3;
    border-radius: 50%;
    width: 20px !important;
    height: 20px !important;
    right: -2px;
    position: absolute;
    bottom: 0;
    transform: translateY(50%);
}

#volume-control .noUi-connect {
    background: #84AAFB;
}
      
#search-container {
    position: relative;
    display: flex;
    align-items: center;
    margin-left: auto;
    margin-right: 20px;
    user-select: none !important;
}

      #gear-icon {
    margin: 0 10px;
    font-size: 20px;
    cursor: pointer;
    position: relative;
    transition: transform 0.3s ease;
}

#gear-icon:hover {
    transform: rotate(180deg);
}
      
#settings-popup {
    display: block;
    position: absolute;
    top: 70px;
    right: 20px;
    background-color: #383838;
    border: 1px solid #f3f3f3;
    border-radius: 7px;
    padding: 10px;
    z-index: 10000;
    width: 420px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

#settings-popup.show {
    visibility: visible;
    opacity: 1;
}

#settings-popup label {
    display: flex;
    align-items: flex-start;
    width: 100%;
}
      
      #settings-popup::before {
    content: '';
    position: absolute;
    top: -20px;
    left: -20px;
    right: -20px;
    bottom: -20px;
    z-index: -1;
}
      
      #settings-popup .custom-checkbox span {
    display: flex;
    flex-direction: column;
        flex: 1;
    word-wrap: break-word;
        font-size: 14px;
}
      
      #settings-popup .custom-checkbox span .sub-text {
    font-size: 12px;
    color: #ccc;
}
      
      #settings-popup hr {
    border: none;
    border-top: 1px solid #f3f3f3;
    margin: 10px 0;
}

#settings-popup .support-links {
    text-align: center;
    font-size: 14px;
}

#settings-popup .support-links a {
    color: #84AAFB;
    text-decoration: none;
}

#settings-popup .support-links a:hover {
    text-decoration: underline;
}
      
     .data-source-notice {
  font-size: 12px;
  text-align: center;
  color: #888;
  margin-top: 5px;
}
      
      .popup {
  display: none;
  position: fixed;
  z-index: 10001;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.7);
}

.popup-content {
  background-color: #383838;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #f3f3f3;
  border-radius: 7px;
  width: 80%;
  max-width: 600px;
  position: relative;
}

.close-btn {
  color: #f3f3f3;
  float: right;
  font-size: 24px;
  font-weight: bold;
  user-select: none !important;
}

.close-btn:hover,
.close-btn:focus {
  color: white;
  text-decoration: none;
  cursor: pointer;
}

.support-links .new-links {
  margin-top: 10px;
  display: block;
}
      
      #project-popup a {
  color: #84AAFB;
  text-decoration: none;
}
      
      #project-popup a:hover {
    text-decoration: underline;
}
      
      #project-popup hr {
    border: none;
    border-top: 1px solid #f3f3f3;
    margin: 10px 0;
}
      
      #help-icon {
    color: #f3f3f3;
    cursor: pointer;
    font-size: 20px;
    margin-left: 10px;
}
 
.controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

.track-buttons {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.controls button {
    width: 20px;
    height: 20px;
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.controls button i {
    font-size: 14px;
}

.controls button:disabled {
    color: #282626;
    cursor: not-allowed;
}
 
.progress-bar-container {
    width: 100%;
    height: 5px;
    background-color: #383838;
    margin-top: 2px;
    position: relative;
}

.progress-bar {
    height: 100%;
    background-color: #84AAFB;
    width: 0%;
}

#artist-search {
    width: 200px;  
    height: 30px;
    border-radius: 7px;
    border: 2px solid #383838;
    background-color: #282626;
    color: #f3f3f3;
    padding: 5px 10px;
    margin-right: 10px;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
}

      #artist-search:hover {
      border: 2px solid #84AAFB;
      }
      
input:-webkit-autofill,
  input:-webkit-autofill:hover,
  input:-webkit-autofill:focus,
  input:-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0px 1000px #282626 inset !important;
    box-shadow: 0 0 0px 1000px #282626 inset !important;
    -webkit-text-fill-color: #f3f3f3 !important;
  }

.artist img {
    width: 224px;
    height: 224px;
    object-fit: cover;
    position: relative;
    cursor: pointer;
    border-radius: 7px;
display: block;
    vertical-align: bottom;
  user-select: none !important;
}

.artist .play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    color: #84AAFB;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s;
  z-index: 1;
}

.artist:hover .play-icon {
    opacity: 1;
    cursor: pointer;
  z-index: 1;
}
      
.artist-counter-wrapper {
    flex-shrink: 0;
    width: 207px;
    text-align: left;
    position: absolute;
    right: 20px;
}

.artist-counter {
    font-weight: bold;
    white-space: nowrap;
}

.filter-tags {
    font-weight: bold;
  max-width: 920px;
}

.filter-tag {
    display: inline-block;
    font-size: 14px;
    border: 1px solid #f3f3f3;
    border-radius: 7px;
    background-color: #90EE90;
    padding: 2px 5px;
    margin-right: 5px;
    margin-bottom: 5px;
    color: #282626;
    line-height: 1.1;
    box-sizing: border-box;
}

.filter-tag.removed {
    background-color: #fb8484;
    color: #282626;
}
      
      .filter-tag.check {
        background-color: #d5da8d;
    color: #282626;
      }

.filter-tag .remove-tag {
    margin-left: 5px;
    cursor: pointer;
}

#sort-menu {
    display: flex;
    flex-direction: column;
    background-color: #383838;
    font-size: 16px;
    margin-left: -13px;
    color: #f3f3f3;
}

#sort-menu div {
    display: flex;
    align-items: center;
    margin: 5px 0;
  }

  #sort-menu button {
    background: none;
    border: 1px solid #f3f3f3;
    color: #f3f3f3;
    cursor: pointer;
    font-size: 16px;
    margin: 0 5px;
    border-radius: 4px;
    transition: border-color 0.3s ease;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
      
      #sort-menu button:hover {
        border: 1px solid #84AAFB;
      }

  #sort-menu button.clear-sort {
    color: #fb8484;
    font-size: 18px;
    visibility: hidden;
    margin-right: 5px;
    border: 1px solid #f3f3f3;
    border-radius: 4px;
    transition: border-color 0.3s ease;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

      #sort-menu button.clear-sort:hover {
        border: 1px solid #fb8484;
      }
      
  #sort-menu .active-sort .clear-sort {
    visibility: visible;
  }
      
      #sort-menu span {
  margin-left: 10px;
}
      
      #sort-menu button.active {
  color: #84fb8f;
}

  #artist-search:focus + #clear-search,
  #artist-search:not(:placeholder-shown) + #clear-search {
    display: block;
  }

      #clear-search {
    position: absolute;
    right: 90px;
    color: #f3f3f3;
    cursor: pointer;
    font-size: 16px;
    display: none;
    z-index: 10;
}

.genre-button.show-more {
    background-color: #f3f3f3;
}

.genre-button.show-less {
    background-color: #F3f3f3;
}

      .expanding {
    transition: max-height 0.5s ease, padding 0.5s ease;
}
      
.genre-button.toggle-genres {
    cursor: pointer;
    color: inherit;
    background-color: #f3f3f3;
}
      
.tab-content {
    display: none;
}

.tab-content[aria-hidden="false"] {
    display: block;
}
      
      #range-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 20px;
    position: relative;
    background-color: #282626;
    user-select: none !important;
}

#listeners-range {
    width: 95%;
  right: 5px;
} 
 
.noUi-handle {
    background-color: #84AAFB;
    border: 1px solid #f3f3f3;
    border-radius: 50%;
    width: 26px !important;
    height: 26px !important;
    box-shadow: none;
    cursor: grab;
}
      
      .noUi-handle:active {
    cursor: grabbing;
}

.noUi-connect {
    background: #383838;
    border-color: #84AAFB;
    color: red;
}
      
      .noUi-connects {
background: #282626;
        border-radius: 0px;
}
      .noUi-handle:after, .noUi-handle:before {
        display: none;
      }
      
      .noUi-target {
        border: 2px solid #383838;
        box-shadow: none;
      }
      
#range-label {
    text-align: center;
    margin-bottom: 5px;
}
 
      .genre-name {
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}
      
      .genre-count {
    color: #bababa;
        font-size: 10px;
        display: inline-block;
    margin-left: 5px;
}
      
      .genre-button.selected .genre-count {
    color: #383838;
}

.genre-button.removed .genre-count {
    display: none;
}

.genre-button.gray-out .genre-count {
    color: #575757;
}
   
      #loading-screen {
    position: fixed;
    padding-top: 100px;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #282626;
    z-index: 20000;
    display: flex;
    align-items: center;
    opacity: 1;
    visibility: visible;
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        display: flex;
  flex-direction: column;
}

#loading-screen.hidden {
    opacity: 0;
    visibility: hidden;
}

#loading-screen img {
    max-width: 50%;
    height: auto;
}

.load-wrapp { 
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 60px;
}
 
.load-10 {
  display: flex;
  justify-content: flex-start;
}

.bar { 
  width: 15px;
  height: 6px;
  border-radius: 2px;
  background-color: #88c8dc;
  margin: 0 5px;
  animation: loadingJ 2s cubic-bezier(0.17, 0.37, 0.43, 0.67) infinite;
}

.loading-text {
  margin-top: 10px; 
  color: #f3f3f3;
  font-size: 16px;
}

      .introjs-overlay {
    background-color: #111111;
    opacity: 0.7;
}
 
.introjs-tooltip.customTooltip {
    background-color: #f3f3f3;
    color: #282626;
    border-radius: 7px;
}
      
      .introjs-tooltip {
    min-width: 500px;
    max-width: 550px;
      }
      
      .introjs-tooltiptext {
    padding: 10px;
        font-size: 14px;
}
      
     .introjs-tooltiptext a {
        color: #84AAFB;
        text-decoration: none;
    }
      
      .introjs-dontShowAgain label {
    font-size: 14px;
    background-color: #f3f3f3;
    color: #383838;
      } 

      .introjs-tooltip.customTooltip.rangeTooltip {
    transform: translateX(50%);
    left: 50%;
}
      
      .artistTooltip .introjs-tooltip {
    width: 400px;
}

      .introjs-button {
    box-shadow: none;
    border: 1px solid #383838;
    border-radius: 7px;
    color: #282626;
        transition: border 0.3s ease;
      }
      
      .introjs-button:focus {
    box-shadow: none;
    border: 1px solid #383838;
    border-radius: 7px;
    color: #282626;
      }
      
      .introjs-button:hover {
    box-shadow: none;
    border: 1px solid #84AAFB;
    border-radius: 7px;
    background-color: #f3f3f3;
    color: #282626;
      }
      
      .introjs-disabled, .introjs-disabled:focus, .introjs-disabled:hover {
      display: none;
      }
      
      .introjs-bullets ul li a.active {
    background: #8ec9db;
}
      
      .introjs-bullets ul li a:focus, .introjs-bullets ul li a:hover {
    background: #8ec9db;
}
      
      .introjs-bullets ul li a {
        background: #d5da91;
      }
      
      .introjs-skipbutton {
    color: #383838;
      }
      
      .introjs-skipbutton:hover {
    color: #282626;
      }
      
      #no-artists-message, #no-artists-name-message {
    display: none;
    text-align: center;
    padding: 20px;
    background-color: #282626;
    color: #f3f3f3;
    font-size: 16px;
}

@keyframes loadingJ {
  0% {
    transform: translateX(-38.75px);
  }

  50% {
    transform: translateX(38.75px);
    background-color: #d5da8d;
    width: 25px;
  }

  100% {
    transform: translateX(-38.75px);
  }
}
       
      [data-tooltip] {
  position: relative;
}

[data-tooltip]::after {
  font-family: 'CustomFont', Arial, sans-serif;
  content: attr(data-tooltip);
  visibility: hidden;
  background-color: #383838;
  color: #f3f3f3;
  font-size: 12px;
  font-weight: normal;
  text-align: center;
  padding: 5px;
  border-radius: 7px;
  border: 1px solid #282626;
  width: 130px;
  max-width: 90vw;
  position: absolute;
  z-index: 1001;
  right: -137px;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s;
  white-space: normal;
}

[data-tooltip]:hover::after {
  visibility: visible;
  opacity: 1;
} 
      
.listeners-tooltip[data-tooltip]::after {
    right: -110px;
}
      
      .difference-tooltip[data-tooltip]::after {
        right: -90px;
}
      
      .match-all-genres-tooltip[data-tooltip]::after {
    white-space: pre-line;
        width: 250px;
    top: 30px;
    left: 175px;
        transition: opacity 0.3s 0.3s, visibility 0s 0.3s;
}

      .date-release [data-tooltip]::after {
    top: -75px;
    left: 42px;
    line-height: 1.2;
    width: 110px;
}
      
      .date-added [data-tooltip]::after {
    top: -55px;
    left: 42px;
    line-height: 1.2;
    width: 110px;
}
      
      .date-added span::after {
  top: -60px; 
}

.listeners-element > span::after {
  top: -30px; 
  right: -128px;
  
}

.listeners-element .difference::after {
  display: none;
  top: -45px; 
  right: -85px;
}
      
      .icon-container {
  position: absolute;
  top: 5px;
  right: 5px;
  background-color: rgba(0, 0, 0, 0.5);
  border-radius: 7px;
  padding: 3px 5px 1px 5px;
  display: flex;
  gap: 10px;
  z-index: 1000;
}
      
      .year-rel-icon i[data-tooltip]:hover::after,
.multi-rel-icon i[data-tooltip]:hover::after,
.russian-tag i[data-tooltip]:hover::after {
  visibility: visible;
  opacity: 1;
}
      
.year-rel-icon i[data-tooltip]::after {
  top: 30px;
  left: -32px;
  width: 90px;
  height: 24px;
}

.multi-rel-icon i[data-tooltip]::after {
    top: 30px;
    width: 100px;
    left: -35px;
    height: 24px;
}

.russian-tag i[data-tooltip]::after {
  top: 30px;
    width: 120px;
    left: -45px;
    height: 24px;
}
      
      .debut-icon i[data-tooltip]::after {
  top: 30px;
    width: 120px;
    left: -47px;
    height: 24px;
}  

      .mobile-label {
  display: none;
}
      
      #search-icon {
    display: none;
}
      
      .info-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
      
      .mobile-only {
    display: none;
}
      
      @media (min-width: 769px) {
    .date-added-mobile {
        display: none;
    }
        .line4 {
    display: none;
}
}
      
  @media (max-width: 768px) {
    html, body {
    font-family: 'CustomFont', Arial, sans-serif;
    color: #f3f3f3;
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100%;
    width: 100%;
      background: #282626;
      min-width: 320px;
}
    
    #project-popup .popup-content {
    font-size: 14px;
  }
    
    .date-release [data-tooltip]::after {
    top: -45px;
    left: 52px;
    line-height: 1.2;
    width: 110px;
}
    
    .debut-icon i[data-tooltip]::after {
    top: 30px;
    left: -5px;
}
    
    .year-rel-icon i[data-tooltip]::after {
    top: 30px;
    left: 5px;
   }
    
    .multi-rel-icon i[data-tooltip]::after {
    top: 30px;
    left: 10px;
}
    
    .russian-tag i[data-tooltip]::after {
    top: 30px;
    left: 10px;
}
    
    .icon-container {
  position: absolute;
  top: 2px;
  right: 12px;
    }
    
    #no-artists-message, #no-artists-name-message {
    font-size: 14px;
}
    
    #gear-icon {
    z-index: 10001;
}
    
    #gear-icon:hover {
    transform: none;
}
    
#main-container {
    height: 100%;
    display: flex;
    flex-direction: column;
}

#main {
    max-height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
}

    #controls-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
      padding-top: 10px;
  }

  #logo {
    display: none;
  }

  #buttons-wrapper {
    display: flex;
    flex-direction: row;
          z-index: 10002;
  }

    #genre-button::after {
        content: "Жанри";
    }

    #genre-button span {
        display: none;
    }
    
  #genre-button, #sort-button, #filters-button {
    width: auto;
    margin-right: 5px;
    position: relative;
    background-color: #f3f3f3;
    color: #282626;
    font-size: 10px;
    font-weight: bold;
    border: 1px solid #f3f3f3;
    padding: 10px 7px 10px 7px;
    cursor: pointer;
    border-radius: 7px 7px 0 0;
    z-index: 200;
  }
    
    .custom-checkbox {
    font-size: 12px;
    }
    
    .custom-checkbox .checkbox-text {
        width: 270px;
    }
    
    #genre-button:hover, #sort-button:hover, #filters-button:hover {
      border: 1px solid #84AAFB;
      } 
    
    #genre-button {
      margin-left: 5px;
    }
    
    #genre-button i, #sort-button i {
    margin-right: 5px;
}
    
    #filters-button i {
    margin-right: 3px;
}
    
    #genre-button.active, #sort-button.active, #filters-button.active {
    border: 1px solid #84AAFB;
}
    
.genre-button {
    width: 150px;
    }
    
    .genre-button .remove-genre {
        opacity: 1;
        visibility: visible;
        position: static;
        margin-left: 5px;
        transform: none;
        background-color: #e74c3c8c;
    }
    
    #genres-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        transition: none !important;
    }
    
    #genres-section {
      max-height: 320px;
        overflow-y: auto;
    }
    
    #genres-section::-webkit-scrollbar {
        width: 8px;
    }
    #genres-section::-webkit-scrollbar-track {
        background: #282626;
    }
    #genres-section::-webkit-scrollbar-thumb {
        background-color: #383838;
        border-radius: 7px;
        border: 2px solid #282626;
    }
    
    #settings-popup {
    top: 50px;
    right: 10px;
    width: 280px;
}
    
    .date-release {
    bottom: 30px;
    border-radius: 0 !important;
    border: none !important;
}
    
    .date-added, .date-release {
    width: 90px;
    padding: 0 5px;
    }
    
    .genre-button {
        width: calc(50% - 5px);
      padding: 0 0 0 5px;
    }
    
    .genre-name {
    font-weight: normal;
}
    
    .genre-button.selected .remove-genre {
    display: none;
}
    
    .genre-button.removed .remove-genre {
    display: none;
}
    
    .genre-button.selected .genre-count {
    margin-right: 5px;
}
    
    .genre-button:hover:not(.selected) {
      box-shadow: none;
    transform: none;
    }
    
    .genre-button.red-shadow {
    box-shadow: none !important;
}
    
    #sort-menu {
    font-size: 12px;
    margin-left: -10px;
}

#sort-menu button {
font-size: 12px;
    width: 25px;
    height: 25px;
}

#sort-menu span {
    margin-left: 5px;
}

#sort-menu button.clear-sort {
font-size: 14px;
    width: 25px;
    height: 25px;
}

#genres-section.expanded, #sort-section.expanded, #filters-section.expanded {
    padding: 10px;
  max-height: 300px !important;
}
    
    #search-container {
        position: relative;
        display: flex;
        align-items: center;
        margin-right: 0px;
    }

    #artist-search {
        display: none;
        position: absolute;
        left: -276px;
        z-index: 10003;
        width: 240px;
        height: 35px;
        border-radius: 7px 7px 0 0;
        border: 1px solid #383838;
        background-color: #282626;
        color: #f3f3f3;
        padding: 5px;
        box-sizing: border-box;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease, left 0.3s ease;
    }

    #artist-search:hover {
        border: 1px solid #84AAFB;
    }
    
    #artist-search:focus {
        border-color: #84AAFB;
        outline: none;
    }
    
    #search-icon {
      display: inline;
      cursor: pointer;
        z-index: 1001;
        margin-right: 5px;
    }

    #clear-search {
        display: none;
        position: absolute;
        right: 55px;
        top: -5px;
        cursor: pointer;
        z-index: 1002;
        font-size: 24px;
    }

    #search-container.active #artist-search {
        display: block;
        opacity: 1;
    }

    #search-container.active #clear-search {
        display: inline;
    }

    #search-container.active #search-icon {
        display: none;
    }
    
    .line4 {
      display: block;
        width: 100%;
    height: 1px;
    background-color: #383838;
    margin: 0;
    position: relative;
      top: 29px;
    z-index: 200;
}
    
    #range-container {
    width: 90%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 12px;
      padding-bottom: 34px;
    position: relative;
    background-color: #282626;
        user-select: none !important;
      padding-left: 8px;
      top: 24px;
}

#listeners-range {
    width: 100%;
  right: 0px;
} 

.noUi-handle {
    background-color: #84AAFB;
    border: 1px solid #f3f3f3;
    border-radius: 50%;
    width: 20px !important;
    height: 20px !important;
    box-shadow: none;
}

.noUi-connect {
    background: #383838;
    border-color: #84AAFB;
    color: red;
}
      
      .noUi-connects {
background: #282626;
        border-radius: 0px;
}
      .noUi-handle:after, .noUi-handle:before {
        display: none;
      }
      
      .noUi-target {
        border: 2px solid #383838;
        box-shadow: none;
        height: 12px;
        align-items: center;
      }
      
#range-label {
    text-align: center;
    margin-bottom: 9px;
  font-size: 10px;
}
    
#artist-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#artist-scroll-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
}

.artist-scroll-container::-webkit-scrollbar {
    width: 14px;
}

.artist-scroll-container::-webkit-scrollbar-track {
    background: #282626;
}

.artist-scroll-container::-webkit-scrollbar-thumb {
    background-color: #383838;
    border-radius: 6px;
    border: 3px solid #282626;
}
    
    .artist-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding-bottom: 20px;
        justify-content: space-between;
        border-top: 4px solid #282626;
    }

    .artist {
        flex-direction: row;
        align-items: flex-start;
        width: 100%;
      position: relative;
    }

    .artist a {
      margin-top: 0;
    }
    
    .artist img {
        width: 100px;
        height: 100px;
        margin-right: 10px;
      border-radius: 0 7px 0 0;
      z-index: 2;
    }

    .artist .info-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        width: calc(100% - 110px);
    } 

    a.track-artist-name,
    .listeners-element,
    .genres-container {
        text-align: left;
        margin-top: 0;
        font-size: 16px;
        display: inline-block;
    }

    .listeners-element i,
    .listeners-element span,
    .listeners-element a {
        display: flex;
        align-items: center;
        line-height: normal;
    }
    
    .listeners-element .fa-instagram {
        margin-top: 0 !important;
      font-size: 12px;
    }
    
    .listeners-element a .fa-instagram {
        margin-top: 0 !important;
    }
    
    .genres-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .genres-section {
        width: calc(50% - 10px);
        margin-bottom: 20px;
    }

    .genres-container {
        transition: none !important;
    }
    
    .date-added-mobile {
        color: #f3f3f3;
        font-size: 12px;
      line-height: 2;
    }
    
    .date-added {
      display: none;
    }
    
    .track-artist-name {
        max-width: calc(100% - 5px);
      width: 100%;
    }
    
    .listeners-element span {
    font-size: 12px;
}
    
    .genre-link {
      font-size: 14px;
      border: none;
      padding: 0;
      margin: 0 5px 0 0;
      color: #d5da8d;
      line-height: 1.2;
      height: 15px;
}
    
    .russian-tag {
        white-space: pre-line;
        font-size: 14px;
      margin-top: 4px !important;
      max-width: 90px;
      left: 0;
      border-radius: 0 7px 0 0;
      line-height: 1.2;
      z-index: 3;
    } 
    
    .no-tracks-message, .no-recent-tracks-message {
    color: #fb8484;
    text-align: center;
    margin-top: -100px;
    font-size: 10px;
    line-height: 1.2;
    position: absolute;
    top: 100px;
        background-color: #383838;
    border-radius: 0 5px 0 0;
    padding: 5px;
    width: 90px;
    left: 0;
    transform: translateX(0%);
    user-select: none !important;
      z-index: 1001;
}
    
    .listeners-element .fa-users {
        font-size: 11px;
        top: 0;
    }
    
    .listeners-element .fa-instagram {
        font-size: 18px;
    }
    
    .genres-container {
        display: block;
    }

    .listeners-element {
        display: flex;
        align-items: center;
    }

    .related-artists-button {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100px;
        height: 30px;
        font-size: 10px;
        font-weight: bold;
        margin: 0;
        border-radius: 0 0 7px 0;
        background-color: #383838;
        color: #f3f3f3;
        border: none;
        text-align: center;
        opacity: 1;
        transition: none;
      z-index: 5;
    }

    .related-artists-button:hover {
    background-color: #383838;
        color: #f3f3f3;
}
    
    .artist .play-icon {
        font-size: 32px;
      top: 30px;
      left: 30px;
      right: 0;
      bottom: 0;
      width: 42px;
      height: 42px;
      transform: none;
    }
    
    .artist .play-icon:hover {
      z-index: 30;
    } 

    i.fas.fa-circle-play {
      font-size: 32px;
      right: 20px;
    }
    
    .artist img.playing {
    outline: 2px solid #d5da8d;
    outline-offset: -4px;
      box-shadow: none;
  }
    
    @keyframes slideInFromLeft {
    0% {
        left: -100%;
    }
    100% {
        left: -45px;
    }
}

    .related-artists-container {
    position: absolute;
    top: 0;
    left: -100%;
    right: auto;
    width: calc(100% - 11px);
    height: 120px;
    background-color: #383838;
    color: #f3f3f3;
    padding: 5px;
    border-radius: 0 7px 7px 0;
    overflow-y: auto;
    font-size: 12px;
    display: flex;
    justify-content: flex-end;
    padding-left: 40px;
    animation: slideInFromLeft 0.2s ease-in-out forwards;
}

    .info-container {
        position: relative;
    }

    .info-container .related-artists-container {
        display: none;
        z-index: 0;
    }

    .related-artists-container a.related-artist-link {
        color: #f3f3f3 !important;
        text-decoration: none !important;
        font-weight: normal !important;
        display: inline !important;
        font-size: inherit;
      right: 25px !important;  
    }

    .artist-counter-wrapper {
    flex-shrink: 0;
    width: 113px;
    text-align: left;
    position: absolute;
    right: 20px;
    font-size: 10px;
}

.artist-counter {
    font-weight: normal;
    white-space: nowrap;
  padding-top: 5px;
}

    #filter-section {
    display: flex;
    background-color: #282626;
    justify-content: space-between;
    flex-direction: column;
    align-items: flex-start;
    padding: 0;
    position: relative;
    z-index: 1;
    user-select: none !important;
}
    
    .filter-tags {
    display: none;
}
    
    #player-wrapper {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    background-color: #282626;
    z-index: 1002;
    display: none;
    align-items: center;
    margin-left: 0px;
    bottom: 40px;
    border-radius: 7px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
}

#player-wrapper.show {
    display: flex;
}
    
#player-container {
    background-color: #383838;
    border-radius: 0;
    padding: 10px;
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 1px solid #d5da8d;
    border-radius: 7px 0 0 7px;
}

    #player-wrapper a.track-artist-name {
    text-align: center;
    flex-grow: 1;
}

#close-player {
    position: static;
    margin-left: 10px;
    margin-right: 10px;
}

#volume-icon {
    display: none !important;
}
    
    .volume-icon {
    display: none !important;
}

    .genre-button.gray-out .remove-genre {
    display: none;
}
    
    .mobile-hide {
        display: none;
    }

    .mobile-only {
        display: inline;
    }
    
    .no-related-artists {
    font-size: 12px;
}
    
    .match-all-genres-tooltip[data-tooltip]::after {
    display: none;
}
    
    #help-icon {
    display: none;
}
     
    #main-container {
    flex-direction: column;
  }

  #buttons-wrapper { order: 1; }
  #search-container { order: 2; }
  .line { display: none; }
  .checkbox-container { order: 4; }
  #artist-counter-wrapper { order: 4; }
  .line4 { order: 5; }
  #range-container { order: 6; }
  .line2 { order: 7; }
  #artist-section { order: 8; }
  .line3 { order: 9; }
  #player-wrapper { order: 10; }
      }     
    </style>
</head>
<body>
  
  <div id="loading-screen">
  <img src="https://static.wixstatic.com/media/c77f36_8aa2c93d844a42f5b0799cd7bfb63e22~mv2.png" alt="Loading"> 
  <div class="load-wrapp">
    <div class="load-10">
      <div class="bar"></div>
    </div>
    <p class="loading-text">Підключення до бази NUAM</p>
  </div>
</div>
  
<div id="scrollArea" class="clusterize-scroll">
    <div id="contentArea" class="clusterize-content">
    </div>
</div>

<div id="main-container">
        <section id="controls-section">
    <img id="logo" src="https://static.wixstatic.com/media/c77f36_8aa2c93d844a42f5b0799cd7bfb63e22~mv2.png" alt="Логотип">
    <div id="buttons-wrapper">
        <button id="genre-button" aria-expanded="false" aria-controls="genres-section">
            <i class="fas fa-music"></i> <span>Вибір жанру</span>
        </button>
        <button id="sort-button" aria-expanded="false" aria-controls="sort-section">
            <i class="fas fa-sort"></i> <span>Сортування</span>
        </button>
        <button id="filters-button" aria-expanded="false" aria-controls="filters-section">
            <i class="fas fa-filter"></i> <span>Фільтри</span>
        </button>
    </div>
    <div id="search-container">
        <i id="search-icon" class="fas fa-magnifying-glass"></i>
        <input type="text" id="artist-search" placeholder="Пошук за артистами...">
        <span id="clear-search" aria-label="Clear search">&times;</span>
        <i id="gear-icon" class="fas fa-cog"></i>
        <i id="help-icon" class="fas fa-question-circle"></i>
    </div>

    <div id="player-wrapper">
    <div id="player-container" class="player-container">
        <div class="controls">
            <div class="track-buttons">
                <button class="prev-track" aria-label="Previous track"><i class="fa fa-chevron-left"></i></button>
                <a id="player-artist-name" href="#" target="_blank" class="track-artist-name" style="margin: 0 10px; color: #84AAFB; font-weight: bold;"></a>
                <button class="next-track" aria-label="Next track"><i class="fa fa-chevron-right"></i></button>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar"></div>
            </div>
        </div>
    </div>
    <div id="volume-icon" class="volume-icon"><i class="fa fa-volume-up"></i></div>
    <button id="close-player" class="close-player">✖</button>
    <div id="volume-slider" class="volume-slider">
        <div id="volume-control"></div>
    </div>
</div>

<div id="settings-popup">
  <label class="custom-checkbox" for="open-in-spotify">
    <input type="checkbox" id="open-in-spotify" class="checkbox">
    <div class="checkbox-icon"></div>
    <span>
      <span class="main-text">Відкривати профілі артистів одразу в додатку Spotify</span>
      <span class="sub-text">інакше відкривається в браузері</span>
    </span>
  </label>
  <label class="custom-checkbox" for="play-latest">
    <input type="checkbox" id="play-latest" class="checkbox">
    <div class="checkbox-icon"></div>
    <span>
      <span class="main-text">Грати в плеєрі останні релізи артиста за 2024 рік</span>
      <span class="sub-text">інакше грають найпопулярніші</span>
    </span>
  </label>
  <hr>
  <div class="support-links">
    <a href="https://nuam.club" target="_blank">Перейти до сайту</a> | 
    <a href="https://nuam.club/donate" target="_blank">Підтримати проєкт</a> | 
      <a href="#" id="about-project">Про проєкт</a><br class="mobile-hide"/><span class="mobile-only"> | </span>
      <a href="https://nuam.club/add" target="_blank">Додати артиста</a> | <a href="https://nuam.club/echo" target="_blank">Спробуйте NUAM Echo</a>
    <div class="new-links">
      Стежити за NUAM: <a href="https://t.me/NewUAM" target="_blank">Telegram</a> | <a href="https://instagram.com/newuam/" target="_blank">Instagram</a><br/>
      Зв'язок: <a href="https://t.me/livefimenko" target="_blank">t.me/livefimenko</a> | <a href="mailto:hi@nuam.club" target="_blank">hi@nuam.club</a>
    </div>
  </div>
</div>

<div id="project-popup" class="popup">
  <div class="popup-content">
    <span class="close-btn">&times;</span>
    <p><strong>NUAM Base</strong> — веб-додаток від агрегатора української музики <a href="https://nuam.club" target="_blank">NUAM</a>. Місія NUAM Base — познайомити українського слухача з локальною музичною сценою, показати її масштаби та різноманітність. Це комплексне рішення з безліччю інструментів для глибокого дослідження української музики.</p>
    <p>Ми щодня перебуваємо в пошуку нових музикантів України, використовуючи безліч власних внутрішніх технологічних рішень. Це база, яка постійно масштабується і розвивається. Бла-бла-бла, скільки ще потрібно нагнати пафосу, щоб ви пішли й почали знайомитися з українською музикою та відкрили її для себе по-новому?</p>
    <hr>
    <div class="data-source-notice">
      Усі дані, що використовуються в цьому веб-додатку, отримані з відкритих джерел Spotify. NUAM не пов'язаний зі Spotify і не представляє його інтереси. А хотілося б.
    </div>
  </div>
</div>

    <div class="line"></div>
</section>

<section id="genres-section" class="tab-content" aria-hidden="true">
  <label class="custom-checkbox match-all-genres-tooltip" data-tooltip="При активному режимі будуть показані артисти, у яких зустрічаються всі обрані жанри одночасно. &#10;&#10; Якщо зняти відмітку, показуються артисти, у яких є хоча б один з обраних жанрів.">
    <input type="checkbox" id="match-all-genres-checkbox" checked>
    <span class="checkbox-icon"></span>
    <span class="checkbox-text">Відповідність усім обраним жанрам</span>
</label>
    <div id="genres-container"></div>
</section>

<section id="sort-section" class="tab-content" aria-hidden="true">
    <div id="sort-menu">
      
      <div class="sort-option">
    <button class="clear-sort" onclick="clearSort()">×</button>
    <button onclick="sortArtistsHandler('lastReleaseDate', 'asc')"><i class="fas fa-arrow-up-wide-short"></i></button>
    <button onclick="sortArtistsHandler('lastReleaseDate', 'desc')"><i class="fas fa-arrow-down-wide-short"></i></button>
    <span>За датою крайнього релізу</span>
  </div>
      
      <div class="sort-option">
    <button class="clear-sort" onclick="clearSort()">×</button>
    <button onclick="sortArtistsHandler('listeners', 'asc')"><i class="fas fa-arrow-up-wide-short"></i></button>
    <button onclick="sortArtistsHandler('listeners', 'desc')"><i class="fas fa-arrow-down-wide-short"></i></button>
    <span>За кількістю слухачів на місяць</span>
  </div>
  <div class="sort-option">
    <button class="clear-sort" onclick="clearSort()">×</button>
    <button onclick="sortArtistsHandler('growth', 'asc')"><i class="fas fa-arrow-up-wide-short"></i></button>
    <button onclick="sortArtistsHandler('growth', 'desc')"><i class="fas fa-arrow-down-wide-short"></i></button>
    <span>За приростом слухачів</span>
  </div>
  <div class="sort-option">
    <button class="clear-sort" onclick="clearSort()">×</button>
    <button onclick="sortArtistsHandler('date', 'asc')"><i class="fas fa-arrow-up-wide-short"></i></button>
    <button onclick="sortArtistsHandler('date', 'desc')"><i class="fas fa-arrow-down-wide-short"></i></button>
    <span>За датою додавання до бази</span>
  </div>
  <div class="sort-option">
    <button class="clear-sort" onclick="clearSort()">×</button>
    <button onclick="sortArtistsHandler('name', 'asc')"><i class="fas fa-arrow-up-wide-short"></i></button>
    <button onclick="sortArtistsHandler('name', 'desc')"><i class="fas fa-arrow-down-wide-short"></i></button>
    <span>За іменем артиста</span>
  </div>
</div>
</section>

  <section id="filters-section" aria-hidden="true">
    <label class="custom-checkbox" for="hide-russian">
        <input type="checkbox" id="hide-russian" class="checkbox" checked />
        <div class="checkbox-icon"></div>
        <span class="checkbox-text">Прибрати артистів із російськомовними піснями у 2024 році</span>
    </label>
    <label class="custom-checkbox" for="yearRel-checkbox">
        <input type="checkbox" id="yearRel-checkbox" class="checkbox" />
        <div class="checkbox-icon"></div>
        <span class="checkbox-text">Прибрати артистів без релізів у поточному році</span>
    </label>
    <label class="custom-checkbox" for="multiRel-checkbox">
        <input type="checkbox" id="multiRel-checkbox" class="checkbox" />
        <div class="checkbox-icon"></div>
        <span class="checkbox-text">Прибрати артистів, у яких лише один реліз за весь час</span>
    </label>
    <label class="custom-checkbox" for="debut-checkbox">
        <input type="checkbox" id="debut-checkbox" class="checkbox" />
        <div class="checkbox-icon"></div>
        <span class="checkbox-text">Показати тільки артистів, які дебютували у 2024 році</span>
    </label>
</section>

<section id="filter-section">
    <div class="filter-tags">Фільтри: <span id="filter-list"></span></div>
    <div class="artist-counter-wrapper">
        <div class="artist-counter">Показано артистів: <span id="artist-count">0</span></div>
    </div>
</section>
<div class="line4"></div>
  <div id="range-container">
        <span id="range-label">Слухачів на місяць: <span id="range-value"></span></span>
        <div id="listeners-range"></div>
    </div>
 <div class="line2"></div>
  
    <section id="artist-section">
    <div id="no-artists-message">
        Артистів із такими параметрами не знайдено.<br/><br/>Спробуйте інший набір жанрів, виключіть фільтри або збільште діапазон слухачів на місяць.
    </div>
    <div id="no-artists-name-message">
        Артистів із таким ім'ям не знайдено.<br/><br/>Спробуйте використати для пошуку посилання на профіль артиста в Spotify.
    </div>
    <div id="artist-scroll-container" class="artist-scroll-container">
        <div class="artist-container"></div>
    </div>
    <div class="line3"></div>
</section>

  </div>
<script>
let displayOffset = 0;
const displayBatchSize = 50;
let currentDisplayList = [];
let selectedGenres = [];
let removedGenres = [];
let hideRussian = false;
let listenerColumns = {};
let artistsData = [];
let accessToken = '';
let shuffledArtistsData = [];
let originalArtistsOrder = [];
let isSortActive = false;

async function getAccessToken() {
    const clientId = 'b5ff50f2075e4a15a6820f06a8269c80';
    const clientSecret = 'aca376357ef645fe95f103c8e363e8f9';

    const response = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
        },
        body: 'grant_type=client_credentials'
    });

    const data = await response.json();
    accessToken = data.access_token;
}

  function transliterate(input) {
    const cyrillicToLatin = {
        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo', 'ж': 'zh',
        'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o',
        'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f', 'х': 'kh', 'ц': 'ts',
        'ч': 'ch', 'ш': 'sh', 'щ': 'shch', 'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu',
        'я': 'ya', 'і': 'i', 'ї': 'yi', 'є': 'ye', 'ґ': 'g'
    };

    return input.split('').map(char => cyrillicToLatin[char] || char).join('');
}

function fixKeyboardLayout(input) {
    const enToRu = {
        'q': 'й', 'w': 'ц', 'e': 'у', 'r': 'к', 't': 'е', 'y': 'н', 'u': 'г', 'i': 'ш', 'o': 'щ', 'p': 'з',
        '[': 'х', ']': 'ъ', 'a': 'ф', 's': 'ы', 'd': 'в', 'f': 'а', 'g': 'п', 'h': 'р', 'j': 'о', 'k': 'л',
        'l': 'д', ';': 'ж', '\'': 'э', 'z': 'я', 'x': 'ч', 'c': 'с', 'v': 'м', 'b': 'и', 'n': 'т', 'm': 'ь',
        ',': 'б', '.': 'ю', '/': '.'
    };

    return input.split('').map(char => enToRu[char] || char).join('');
}
  
  let allArtistURLs = new Set();

function collectAllArtistURLs(artists) {
    artists.forEach(artist => {
        for (let i = 1; i <= 6; i++) {
            const url = artist[`URL${i}`];
            if (url) {
                allArtistURLs.add(url.split('/').pop().split('?')[0]);
            }
        }
    });
}
  
let genreCombinations = {};
let initialGenreCombinations = {};

function initializeGenreCombinations(artists) {
    genreCombinations = {};
    let genreCounts = {};
    let filteredGenreCounts = {};

    artists.forEach(artist => {
        const artistGenres = artist['Жанр'].split(', ');

        if (artistGenres.some(genre => removedGenres.includes(genre))) {
            return;
        }

        const matchesYearRel = !filterYearRel || artist['YearRel'] === '+';
        const matchesMultiRel = !filterMultiRel || artist['MultiRel'] === '+';
        const matchesDebut = !filterDebut || artist['Debut'] === '+';
        const matchesHideRussian = !hideRussian || !artist['RuLang'];

        if (matchesYearRel && matchesMultiRel && matchesDebut && matchesHideRussian) {
            artistGenres.forEach(genre => {
                if (!genreCounts[genre]) {
                    genreCounts[genre] = 0;
                }
                genreCounts[genre]++;
            });

            const genreCount = artistGenres.length;
            for (let i = 1; i < (1 << genreCount); i++) {
                let combination = [];
                for (let j = 0; j < genreCount; j++) {
                    if (i & (1 << j)) {
                        combination.push(artistGenres[j]);
                    }
                }
                const key = combination.sort().join(',');
                if (!filteredGenreCounts[key]) {
                    filteredGenreCounts[key] = 0;
                }
                filteredGenreCounts[key]++;
            }
        }
    });

    for (let genre in genreCounts) {
        if (genreCounts.hasOwnProperty(genre)) {
            genreCombinations[genre] = { count: genreCounts[genre], filterCount: genreCounts[genre] };
        }
    }

    for (let combination in filteredGenreCounts) {
        if (filteredGenreCounts.hasOwnProperty(combination)) {
            if (!genreCombinations[combination]) {
                genreCombinations[combination] = { count: 0, filterCount: filteredGenreCounts[combination] };
            } else {
                genreCombinations[combination].filterCount = filteredGenreCounts[combination];
            }
        }
    }

    initialGenreCombinations = JSON.parse(JSON.stringify(genreCombinations));
}

async function fetchArtists() {
    const response = await fetch('https://docs.google.com/spreadsheets/d/1_PavIrMhHpUHXG7uDrT83yznb2nrJfSd-9G8Hnm9ywM/pub?gid=0&single=true&output=csv');
    if (!response.ok) {
        throw new Error('Failed to fetch artists data');
    }
    const csvData = await response.text();
    Papa.parse(csvData, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            listenerColumns = findListenerColumns(results.meta.fields);
            artistsData = results.data.slice(1).filter(artist => !artist['Empty']);
            shuffleArray(artistsData);
            shuffledArtistsData = [...artistsData];
            originalArtistsOrder = [...shuffledArtistsData];

            const maxListeners = Math.max(...artistsData.map(artist => parseInt(artist[Object.keys(artist)[listenerColumns.currentMonthIndex]]) || 0));

            setupRangeSlider(maxListeners);
            collectAllArtistURLs(artistsData);
            extractAndDisplayGenres(artistsData);
            initializeSearchIndex(artistsData);
            initializeGenreCombinations(artistsData);
            updateGenreCounts(true);
            updateArtistsDisplay();
        }
    });
}


  let tracksData = [];

async function fetchTracksData() {
    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQF8E3B7sRWEdfGxrRwQqtNvf4scBZexST0LGUbR7cXss53wcZw6UCZFHA9ChflUcDOJDTL1F1pJ3M8/pub?gid=1080612412&single=true&output=csv');
    const csvData = await response.text();
    const parsedData = Papa.parse(csvData, { header: true, skipEmptyLines: true }).data;
    tracksData = parsedData.map(row => ({
        track: row.track,
        artist: row.artist.split('/').pop(),
        artist2: row.artist2 ? row.artist2.split('/').pop() : '',
        artist3: row.artist3 ? row.artist3.split('/').pop() : '',
        artist4: row.artist4 ? row.artist4.split('/').pop() : '',
        artist5: row.artist5 ? row.artist5.split('/').pop() : '',
        artist6: row.artist6 ? row.artist6.split('/').pop() : '',
        artist7: row.artist7 ? row.artist7.split('/').pop() : '',
        artist8: row.artist8 ? row.artist8.split('/').pop() : '',
        artist9: row.artist9 ? row.artist9.split('/').pop() : '',
        artist10: row.artist10 ? row.artist10.split('/').pop() : '',
        artist11: row.artist11 ? row.artist11.split('/').pop() : '',
        artist12: row.artist12 ? row.artist12.split('/').pop() : '',
        artist13: row.artist13 ? row.artist13.split('/').pop() : '',
        artist14: row.artist14 ? row.artist14.split('/').pop() : '',
        artist15: row.artist15 ? row.artist15.split('/').pop() : '',
        artist16: row.artist16 ? row.artist16.split('/').pop() : '',
        artist17: row.artist17 ? row.artist17.split('/').pop() : '',
        artist18: row.artist18 ? row.artist18.split('/').pop() : '',
        artist19: row.artist19 ? row.artist19.split('/').pop() : '',
        artist20: row.artist20 ? row.artist20.split('/').pop() : '',
        artist21: row.artist21 ? row.artist21.split('/').pop() : '',
        artist22: row.artist22 ? row.artist22.split('/').pop() : '',
        artist23: row.artist23 ? row.artist23.split('/').pop() : '',
        artist24: row.artist24 ? row.artist24.split('/').pop() : '',
        album: row.album,
        type: row.type,
        date: row.date,
        preview: row.preview
    }));
}

fetchTracksData();
  
function findListenerColumns(header) {
    let listenerColumns = [];

    header.forEach((col, index) => {
        if (/Слухачів \d{2}\.\d{2}/.test(col)) {
            listenerColumns.push(index);
        }
    });

    let currentMonthIndex = listenerColumns[0];
    let previousMonthIndex = listenerColumns[1];

    return { currentMonthIndex, previousMonthIndex };
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function extractAndDisplayGenres(artists) {
    const genres = {};
    artists.forEach(artist => {
        artist['Жанр'].split(', ').forEach(genre => {
            genres[genre] = (genres[genre] || 0) + 1;
        });
    });

    const genresContainer = document.getElementById('genres-container');
    genresContainer.innerHTML = '';

    const sortedGenres = Object.entries(genres).sort((a, b) => b[1] - a[1]);

    const allGenresButton = document.createElement('button');
    allGenresButton.className = 'genre-button selected';
    allGenresButton.dataset.genre = 'всі жанри';
    allGenresButton.innerHTML = '<span class="genre-name">всі жанри</span>';
    allGenresButton.onclick = () => {
        selectedGenres = [];
        removedGenres = [];

        initializeGenreCombinations(artistsData);

        document.querySelectorAll('.genre-button').forEach(button => {
            button.classList.remove('selected', 'gray-out', 'removed');
            button.style.pointerEvents = 'auto';
        });

        updateArtistsDisplay();
        updateGenreCounts();
        updateGenreUIState();

        document.getElementById('artist-search').value = '';
        document.getElementById('clear-search').style.display = 'none';
        updateFilterTags();
    };
    genresContainer.appendChild(allGenresButton);

    sortedGenres.forEach(([genre, count]) => {
        if (count < 5) {
            return;
        }

        const genreButton = document.createElement('button');
        genreButton.className = 'genre-button';
        genreButton.dataset.originalCount = count;
        genreButton.dataset.genre = genre;
        genreButton.innerHTML = `<span class="genre-name">${genre}</span><span class="genre-count">(${count})</span>`;

        const removeButton = document.createElement('button');
        removeButton.className = 'remove-genre';
        removeButton.textContent = '×';
        removeButton.onclick = (event) => {
            event.stopPropagation();

            const genre = genreButton.dataset.genre;

            if (!removedGenres.includes(genre)) {
                removedGenres.push(genre);
                selectedGenres = selectedGenres.filter(g => g !== genre);

                initializeGenreCombinations(artistsData);

                updateFilterTags();
                updateArtistsDisplay();
                updateGenreCounts();
                updateGenreUIState();
            }
        };
        genreButton.appendChild(removeButton);

        genreButton.onclick = () => {
            if (removedGenres.includes(genre)) {
                restoreGenre(genre);
            } else {
                toggleGenreSelection(genre);
            }

            const allGenresButton = document.querySelector('.genre-button[data-genre="всі жанри"]');
            if (allGenresButton) {
                allGenresButton.classList.remove('selected');
            }

            document.getElementById('artist-search').value = '';
            document.getElementById('clear-search').style.display = 'none';
            updateFilterTags();
            updateArtistsDisplay();
            updateToggleButton();
            updateGenreCounts();
        };

        if (count < 10) {
            genreButton.classList.add('hidden-genre');
            genreButton.style.display = 'none';
        }

        genresContainer.appendChild(genreButton);
    });

    const toggleButton = document.createElement('button');
    toggleButton.className = 'genre-button toggle-genres show-more-less-button';
    toggleButton.innerHTML = `<span class="genre-name">Показати ще...</span>`;
    toggleButton.style.backgroundColor = '#f3f3f3';
    toggleButton.onclick = () => {
        const hiddenButtons = document.querySelectorAll('.hidden-genre');
        const isHidden = Array.from(hiddenButtons).some(button => button.style.display === 'none');
        hiddenButtons.forEach(button => {
            button.style.display = isHidden ? 'flex' : 'none';
        });

        if (isHidden) {
            toggleButton.innerHTML = `<span class="genre-name">Показати менше</span>`;
            toggleButton.classList.add('expanded');
            toggleButton.classList.remove('active');
        } else {
            toggleButton.innerHTML = `<span class="genre-name">Показати ще...</span>`;
            toggleButton.classList.remove('expanded');
            toggleButton.classList.add('active');
        }

        const genresSection = document.getElementById('genres-section');
        requestAnimationFrame(() => {
            genresSection.style.maxHeight = isHidden ? genresSection.scrollHeight + 'px' : '0';
        });
    };
    const firstHiddenGenreButton = genresContainer.querySelector('.hidden-genre');
    if (firstHiddenGenreButton) {
        genresContainer.insertBefore(toggleButton, firstHiddenGenreButton);
    } else {
        genresContainer.appendChild(toggleButton);
    }

    updateToggleButton();
    updateGenreUIState();
    updateGenreCounts(true);
}

let filterYearRel = false;
let filterMultiRel = false;
let filterDebut = false;
let matchAllGenres = true;
let invalidGenres = [];

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('yearRel-checkbox').addEventListener('change', function() {
        filterYearRel = this.checked;
        document.getElementById('artist-search').value = '';
        document.getElementById('clear-search').style.display = 'none';
        updateArtistsDisplay();
        updateFilterTags();
        initializeGenreCombinations(artistsData);
        updateGenreCounts();
      updateGenreUIState();
    });

    document.getElementById('multiRel-checkbox').addEventListener('change', function() {
        filterMultiRel = this.checked;
        document.getElementById('artist-search').value = '';
        document.getElementById('clear-search').style.display = 'none';
        updateArtistsDisplay();
        updateFilterTags();
        initializeGenreCombinations(artistsData);
        updateGenreCounts();
      updateGenreUIState();
    });

    document.getElementById('hide-russian').addEventListener('change', function() {
    hideRussian = this.checked;
    updateArtistsDisplay();
    updateFilterTags();
    initializeGenreCombinations(artistsData);
    updateGenreCounts();
    updateGenreUIState();
});

    document.getElementById('debut-checkbox').addEventListener('change', function() {
        filterDebut = this.checked;
        document.getElementById('artist-search').value = '';
        document.getElementById('clear-search').style.display = 'none';
        updateArtistsDisplay();
        updateFilterTags();
        initializeGenreCombinations(artistsData);
        updateGenreCounts();
      updateGenreUIState();
    });

    document.getElementById('match-all-genres-checkbox').addEventListener('change', function() {
        matchAllGenres = this.checked;

        if (matchAllGenres) {
            selectedGenres = selectedGenres.filter(genre => {
                return artistsData.some(artist => {
                    const artistGenres = artist['Жанр'].split(', ');
                    return selectedGenres.every(selectedGenre => artistGenres.includes(selectedGenre));
                });
            });
        }

        updateArtistsDisplay();
        updateFilterTags();
        updateGenreCounts();
      
        const genreButtons = document.querySelectorAll('.genre-button');
        genreButtons.forEach(button => {
            const genre = button.dataset.genre;
            const count = parseInt(button.querySelector('.genre-count').textContent.replace(/[()]/g, ''), 10);
            if (count === 0) {
                button.classList.add('gray-out');
                button.style.pointerEvents = 'none';
            } else {
                button.classList.remove('gray-out');
                button.style.pointerEvents = 'auto';
            }
        });

        const allGenresButton = document.querySelector('.genre-button:first-child');
        if (allGenresButton) {
            allGenresButton.disabled = false;
            allGenresButton.classList.remove('gray-out');
            allGenresButton.style.pointerEvents = 'auto';
            if (selectedGenres.length === 0) {
                allGenresButton.classList.add('selected');
            } else {
                allGenresButton.classList.remove('selected');
            }
        }
    });
});
  
function updateToggleButton() {
    const hiddenButtons = document.querySelectorAll('.hidden-genre');
    const toggleButton = document.querySelector('.toggle-genres');
    if (!toggleButton) return;

    const activeGenres = selectedGenres.length > 0 ? selectedGenres : ['всі жанри'];
    const hideRussian = document.getElementById('hide-russian').checked;

    const hasActiveHiddenGenres = Array.from(hiddenButtons).some(button => {
        const genre = button.dataset.genre;
        const hasArtists = artistsData.some(artist => {
            const artistGenres = artist['Жанр'].split(', ');
            return activeGenres.every(activeGenre => artistGenres.includes(activeGenre)) && artistGenres.includes(genre) && (!hideRussian || !artist['RuLang']);
        });
        return hasArtists;
    });

    if (hasActiveHiddenGenres && !toggleButton.classList.contains('expanded')) {
        toggleButton.classList.add('active');
    } else {
        toggleButton.classList.remove('active');
    }

    toggleButton.disabled = false;
    toggleButton.style.pointerEvents = 'auto';

    toggleButton.onclick = () => {
        const isHidden = Array.from(hiddenButtons).some(button => button.style.display === 'none');
        hiddenButtons.forEach(button => {
            button.style.display = isHidden ? 'flex' : 'none';
        });
        toggleButton.innerHTML = isHidden ? `<span class="genre-name">Показати менше</span>` : `<span class="genre-name">Показати ще...</span>`;
        toggleButton.style.backgroundColor = isHidden ? '#f3f3f3' : '#f3f3f3';
        if (isHidden) {
            toggleButton.classList.add('expanded');
            toggleButton.classList.remove('active');
        } else {
            toggleButton.classList.remove('expanded');
            updateToggleButton();
        }
        requestAnimationFrame(() => {
            const genresSection = document.getElementById('genres-section');
            genresSection.style.maxHeight = genresSection.scrollHeight + 'px';
        });
    };
}

function updateFilterTags() {
    const filterList = document.getElementById('filter-list');
    filterList.innerHTML = '';

    const searchQuery = document.getElementById('artist-search').value.trim();

    if (searchQuery) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag';
        filterTag.textContent = 'пошуковий запит';
        filterList.appendChild(filterTag);
    } else {
        if (selectedGenres.length === 0 && removedGenres.length === 0) {
            const filterTag = document.createElement('span');
            filterTag.className = 'filter-tag';
            filterTag.textContent = 'всі жанри';
            filterList.appendChild(filterTag);
        } else {
            selectedGenres.forEach(genre => {
                const filterTag = document.createElement('span');
                filterTag.className = 'filter-tag';
                filterTag.textContent = genre;
                const removeTag = document.createElement('span');
                removeTag.className = 'remove-tag';
                removeTag.textContent = '×';
                removeTag.onclick = () => {
                    toggleGenreSelection(genre);
                    initializeGenreCombinations(artistsData);
                    updateGenreCounts();
                    updateFilterTags();
                };
                filterTag.appendChild(removeTag);
                filterList.appendChild(filterTag);
            });

            removedGenres.forEach(genre => {
                const filterTag = document.createElement('span');
                filterTag.className = 'filter-tag removed';
                filterTag.textContent = genre;
                const removeTag = document.createElement('span');
                removeTag.className = 'remove-tag';
                removeTag.textContent = '×';
                removeTag.onclick = () => {
                    restoreGenre(genre);
                    initializeGenreCombinations(artistsData);
                    updateGenreCounts();
                    updateFilterTags();
                };
                filterTag.appendChild(removeTag);
                filterList.appendChild(filterTag);
            });
        }
    }

    if (hideRussian) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag check';
        filterTag.textContent = 'без російськомовних артистів';
        const removeTag = document.createElement('span');
        removeTag.className = 'remove-tag';
        removeTag.textContent = '×';
        removeTag.onclick = () => {
            document.getElementById('hide-russian').checked = false;
            hideRussian = false;
            initializeGenreCombinations(artistsData);
            updateArtistsDisplay();
            updateFilterTags();
            updateGenreCounts();
        };
        filterTag.appendChild(removeTag);
        filterList.appendChild(filterTag);
    }

    if (filterYearRel) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag check';
        filterTag.textContent = 'артисти з релізами цьогоріч';
        const removeTag = document.createElement('span');
        removeTag.className = 'remove-tag';
        removeTag.textContent = '×';
        removeTag.onclick = () => {
            document.getElementById('yearRel-checkbox').checked = false;
            filterYearRel = false;
            initializeGenreCombinations(artistsData);
            updateArtistsDisplay();
            updateFilterTags();
            updateGenreCounts();
        };
        filterTag.appendChild(removeTag);
        filterList.appendChild(filterTag);
    }

    if (filterMultiRel) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag check';
        filterTag.textContent = 'є більше одного релізу';
        const removeTag = document.createElement('span');
        removeTag.className = 'remove-tag';
        removeTag.textContent = '×';
        removeTag.onclick = () => {
            document.getElementById('multiRel-checkbox').checked = false;
            filterMultiRel = false;
            initializeGenreCombinations(artistsData);
            updateArtistsDisplay();
            updateFilterTags();
            updateGenreCounts();
        };
        filterTag.appendChild(removeTag);
        filterList.appendChild(filterTag);
    }

    if (filterDebut) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag check';
        filterTag.textContent = 'дебют 2024 року';
        const removeTag = document.createElement('span');
        removeTag.className = 'remove-tag';
        removeTag.textContent = '×';
        removeTag.onclick = () => {
            document.getElementById('debut-checkbox').checked = false;
            filterDebut = false;
            initializeGenreCombinations(artistsData);
            updateArtistsDisplay();
            updateFilterTags();
            updateGenreCounts();
        };
        filterTag.appendChild(removeTag);
        filterList.appendChild(filterTag);
    }
  
    if (searchQuery) {
        const filterTags = filterList.querySelectorAll('.filter-tag');
        filterTags.forEach(tag => {
            if (tag.textContent !== 'пошуковий запит') {
                tag.style.display = 'none';
            }
        });
    }

    updateGenreCounts();
}

function updateArtistsDisplay() {
    const artistScrollContainer = document.getElementById('artist-scroll-container');
    const scrollPosition = artistScrollContainer.scrollTop;

    currentDisplayList = applyFilters(artistsData, minListeners, maxListeners);

    if (isSortActive && currentSortCriteria) {
        currentDisplayList = sortArtists(currentDisplayList, currentSortCriteria, currentSortOrder);
    } else {
        currentDisplayList = applyFilters(shuffledArtistsData, minListeners, maxListeners);
    }

    const noArtistsMessage = document.getElementById('no-artists-message');
    const noArtistsNameMessage = document.getElementById('no-artists-name-message');
    noArtistsNameMessage.style.display = 'none';

    if (!currentDisplayList.length) {
        noArtistsMessage.style.display = 'block';
    } else {
        noArtistsMessage.style.display = 'none';
    }

    displayArtists(currentDisplayList, true);
    updateArtistCounter(currentDisplayList.length);
    updateFilterTags();
    updateGenreCounts();
    updateGenreUIState();
  
    artistScrollContainer.scrollTop = scrollPosition;

    const container = document.getElementById('artist-scroll-container');
    if (container) {
        container.removeEventListener('scroll', scrollHandler);
        container.addEventListener('scroll', scrollHandler);
    }
}

function applyFilters(artists, minListeners = 0, maxListeners = Infinity) {
    const filteredArtists = artists.filter(artist => {
        const artistGenres = artist['Жанр'].split(', ');
        const currentListeners = parseInt(artist[Object.keys(artist)[listenerColumns.currentMonthIndex]]) || 0;

        const matchesSelectedGenres = selectedGenres.length === 0 || (
            matchAllGenres 
                ? selectedGenres.every(genre => artistGenres.includes(genre)) 
                : selectedGenres.some(genre => artistGenres.includes(genre))
        );
        const matchesRemovedGenres = removedGenres.length === 0 || !removedGenres.some(genre => artistGenres.includes(genre));
        const matchesHideRussian = !hideRussian || artist['RuLang'] === '';
        const matchesListenersRange = currentListeners >= minListeners && currentListeners <= maxListeners;
        const matchesYearRel = !filterYearRel || artist['YearRel'] === '+';
        const matchesMultiRel = !filterMultiRel || artist['MultiRel'] === '+';
        const matchesDebut = !filterDebut || artist['Debut'] === '+';

        return matchesSelectedGenres && matchesRemovedGenres && matchesHideRussian && matchesListenersRange && matchesYearRel && matchesMultiRel && matchesDebut;
    });

    updateGenreCounts(); 
    updateGenreUIState(); 

    return filteredArtists;
}

  function formatNumber(value) {
    return value >= 10000 ? value.toLocaleString('uk-UA') : value.toString();
}
  
let currentlyOpenContainer = null;

function toggleRelatedArtists(artistElement, artistId) {
    const relatedArtistsContainer = artistElement.querySelector('.related-artists-container');
    const relatedArtistsButton = artistElement.querySelector('.related-artists-button');

    document.querySelectorAll('.related-artists-container').forEach(container => {
        container.style.display = 'none';
    });
    document.querySelectorAll('.related-artists-button').forEach(button => {
        button.textContent = 'Схожі артисти';
    });

    const volumeSlider = document.getElementById('volume-slider');
    volumeSlider.style.display = 'none';

    if (relatedArtistsContainer !== currentlyOpenContainer) {
        fetchRelatedArtists(artistId, relatedArtistsContainer);
        relatedArtistsButton.textContent = 'Закрити';
        relatedArtistsContainer.style.display = 'block';
        currentlyOpenContainer = relatedArtistsContainer;
    } else {
        currentlyOpenContainer = null;
    }
}

async function fetchRelatedArtists(artistId, container) {
    const response = await fetch(`https://api.spotify.com/v1/artists/${artistId}/related-artists`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    const data = await response.json();

    container.innerHTML = '';
    if (data.artists && data.artists.length > 0) {
        const filteredArtists = data.artists.filter(relatedArtist => allArtistURLs.has(relatedArtist.id));
        
        if (filteredArtists.length > 0) {
            const relatedArtistsLinks = filteredArtists
                .map(relatedArtist => `<a class="related-artist-link" href="${relatedArtist.external_urls.spotify}" target="_blank">${relatedArtist.name}</a>`)
                .join(', ');
            container.innerHTML = relatedArtistsLinks;
        } else {
            container.innerHTML = '<div class="no-related-artists">Схожих артистів не знайдено</div>';
        }
    } else {
        container.innerHTML = '<div class="no-related-artists">Схожих артистів не знайдено</div>';
    }
    container.style.display = 'block';
}

function displayArtists(artists, reset = false) {
    const container = document.querySelector('.artist-container');
    if (reset) {
        container.innerHTML = '';
        displayOffset = 0;
        currentDisplayList = artists;
        document.getElementById('artist-scroll-container').scrollTop = 0;
    }

    const toDisplay = artists.slice(displayOffset, displayOffset + displayBatchSize);
    displayOffset += displayBatchSize;

    toDisplay.forEach(artist => {
        if (!artist) return;

        const artistElement = document.createElement('div');
        artistElement.className = 'artist';

        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative';

        const imgElement = document.createElement('img');
        imgElement.src = artist['IMG'] || 'https://static.wixstatic.com/media/c77f36_18ba153c351744bc9cb5eecb39ca6d90~mv2.png';
        if (artist['URL1']) {
            imgElement.setAttribute('data-spotify-id', artist['URL1'].split('/').pop().split('?')[0]);
            imgElement.addEventListener('click', function() {
                playTrackPreview(this.getAttribute('data-spotify-id'));
            });
        }

        imgContainer.appendChild(imgElement);

        const playIcon = document.createElement('div');
        playIcon.className = 'play-icon';
        playIcon.innerHTML = '<i class="fas fa-circle-play"></i>';
        playIcon.addEventListener('click', function(event) {
            event.stopPropagation();
            playTrackPreview(imgElement.getAttribute('data-spotify-id'));
        });
        imgContainer.appendChild(playIcon);

        const noTracksMessage = document.createElement('div');
        noTracksMessage.className = 'no-tracks-message';
        noTracksMessage.textContent = 'Відсутні треки для відтворення';
        noTracksMessage.style.display = 'none';
        imgContainer.appendChild(noTracksMessage);
      
        const noRecentTracksMessage = document.createElement('div');
        noRecentTracksMessage.className = 'no-recent-tracks-message';
        noRecentTracksMessage.textContent = 'У артиста немає треків у поточному році. Грають найпопулярніші.';
        noRecentTracksMessage.style.display = 'none';
        imgContainer.appendChild(noRecentTracksMessage);

        const relatedArtistsButton = document.createElement('button');
        relatedArtistsButton.className = 'related-artists-button';
        relatedArtistsButton.textContent = 'Схожі артисти';
        relatedArtistsButton.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleRelatedArtists(artistElement, imgElement.getAttribute('data-spotify-id'));
        });

        imgContainer.appendChild(relatedArtistsButton);

        const relatedArtistsContainer = document.createElement('div');
        relatedArtistsContainer.className = 'related-artists-container';
        imgContainer.appendChild(relatedArtistsContainer);

        const iconContainer = document.createElement('div');
        iconContainer.className = 'icon-container';

        if (artist['YearRel'] !== '+') {
            const yearRelIcon = document.createElement('div');
            yearRelIcon.className = 'year-rel-icon';
            yearRelIcon.innerHTML = '<i class="fa fa-calendar-minus" data-tooltip="Немає релізів цього року"></i>';
            yearRelIcon.style.color = '#fb8484';
            yearRelIcon.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.3)';
            iconContainer.appendChild(yearRelIcon);
        }

        const multiRelIcon = document.createElement('div');
        multiRelIcon.className = 'multi-rel-icon';
        if (artist['MultiRel'] !== '+') {
            multiRelIcon.innerHTML = '<i class="fa fa-solid fa-leaf" data-tooltip="У артиста лише один реліз"></i>';
            multiRelIcon.style.color = '#fb8484';
            multiRelIcon.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.3)';
            iconContainer.appendChild(multiRelIcon);
        }

        if (artist['RuLang']) {
            const tagElement = document.createElement('div');
            tagElement.className = 'russian-tag';
            tagElement.innerHTML = '<i class="fa fa-thumbs-down" data-tooltip="Є пісні російською з 2024 року"></i>';
            tagElement.style.color = '#fb8484';
            tagElement.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.3)';
            iconContainer.appendChild(tagElement);
        }

        if (artist['Debut'] === '+') {
            const debutIcon = document.createElement('div');
            debutIcon.className = 'debut-icon';
            debutIcon.innerHTML = '<i class="fa fa-fire" data-tooltip="Артист дебютував у 2024 році"></i>';
            debutIcon.style.color = '#d5da8d';
            debutIcon.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.3)';
            iconContainer.appendChild(debutIcon);
        }

        if (iconContainer.children.length > 0) {
            imgContainer.appendChild(iconContainer);
        }

        if (artist['Дата додавання']) {
            const dateElement = document.createElement('div');
            dateElement.className = 'date-added';
            dateElement.innerHTML = `<i class="fa fa-database"></i> <span data-tooltip="Дата додавання артиста до бази" style="font-family: CustomFont, Arial, sans-serif;">${artist['Дата додавання']}</span>`;
            imgContainer.appendChild(dateElement);

            if (!artist['LastRelDate']) {
                dateElement.style.borderRadius = '0 7px 7px 0';
                dateElement.style.borderBottom = '1px solid #282626';
            }
        }

        if (artist['LastRelDate']) {
            const datereleaseElement = document.createElement('div');
            datereleaseElement.className = 'date-release';
            datereleaseElement.innerHTML = `<i class="fa fa-calendar-plus"></i> <span data-tooltip="Дата крайнього релізу" style="font-family: CustomFont, Arial, sans-serif;">${artist['LastRelDate']}</span>`;
            imgContainer.appendChild(datereleaseElement);

            if (!artist['Дата додавання']) {
                datereleaseElement.style.borderRadius = '0 7px 0 7px';
                datereleaseElement.style.borderTop = '1px solid #282626';
            }
        }

        if (!artist['Дата додавання'] && artist['LastRelDate']) {
            const dateReleaseElement = imgContainer.querySelector('.date-release');
            if (dateReleaseElement) {
                dateReleaseElement.style.borderRadius = '0 7px 0 7px';
            }
        }

        const infoContainer = document.createElement('div');
        infoContainer.className = 'info-container';

        const nameElement = document.createElement('a');
        nameElement.href = artist['URL1'] || '#';
        nameElement.textContent = artist['Артист'];
        nameElement.target = "_blank";
        nameElement.className = 'track-artist-name';
        infoContainer.appendChild(nameElement);

        const listenersElement = document.createElement('div');
        listenersElement.className = 'listeners-element';

        const listenersIcon = document.createElement('i');
        listenersIcon.className = 'fa fa-users';
        listenersElement.appendChild(listenersIcon);

        const currentListeners = parseInt(artist[Object.keys(artist)[listenerColumns.currentMonthIndex]]) || 0;
        const previousListeners = parseInt(artist[Object.keys(artist)[listenerColumns.previousMonthIndex]]);

        const currentListenersSpan = document.createElement('span');
        currentListenersSpan.textContent = formatNumber(currentListeners);
        currentListenersSpan.setAttribute('data-tooltip', 'Слухачів на місяць');
        listenersElement.appendChild(currentListenersSpan);

        if (previousListeners !== undefined && previousListeners !== null && previousListeners !== 0) {
            const difference = currentListeners - previousListeners;
            if (difference !== 0) {
                const differenceText = difference > 0 ? `↑${formatNumber(difference)}` : `↓${formatNumber(Math.abs(difference))}`;
                const differenceColor = difference > 0 ? '#84fb8f' : '#fb8484';
                const differenceSpan = document.createElement('span');
                differenceSpan.className = 'difference';
                differenceSpan.style.color = differenceColor;
                differenceSpan.textContent = `(${differenceText})`;
                differenceSpan.setAttribute('data-tooltip', 'Різниця порівняно з попереднім місяцем');
                listenersElement.appendChild(differenceSpan);
            }
        }

        if (artist['Instagram']) {
            listenersElement.innerHTML += ` <span class="separator">|</span> <a href="${artist['Instagram']}" target="_blank"><i class="fab fa-instagram"></i></a>`;
        }

        infoContainer.appendChild(listenersElement);

        const genresElement = document.createElement('div');
        genresElement.className = 'genres-container';
        if (artist['Жанр']) {
            artist['Жанр'].split(', ').forEach(genre => {
                const genreSpan = document.createElement('span');
                genreSpan.textContent = genre;
                genreSpan.className = 'genre-link';
                genreSpan.onclick = () => {
                    selectedGenres = [];
                    removedGenres = [];
                    document.getElementById('artist-search').value = '';
                  
                    updateFilterTags();
                    updateArtistsDisplay();
                    toggleGenreSelection(genre, artist['Артист']);
                    updateGenreCounts();
                    updateToggleButton();
                };
                genresElement.appendChild(genreSpan);
                genresElement.appendChild(document.createTextNode(' '));
            });
        }
        infoContainer.appendChild(genresElement);

        if (artist['Дата додавання']) {
            const dateElementMobile = document.createElement('div');
            dateElementMobile.className = 'date-added-mobile';
            dateElementMobile.textContent = `Додано до бази: ${artist['Дата додавання']}`;
            infoContainer.appendChild(dateElementMobile);
        }

        infoContainer.appendChild(relatedArtistsContainer);

        artistElement.appendChild(imgContainer);
        artistElement.appendChild(infoContainer);

        container.appendChild(artistElement);
    });
}

let flexSearchIndex;
let flexSearchUrlIndex;
const artists = [];

function initializeSearchIndex(artistsData) {
    flexSearchIndex = new FlexSearch.Document({
        document: {
            id: 'id',
            index: ['Артист'],
            store: ['Артист']
        },
        tokenize: 'forward',
        resolution: 3,
        threshold: 1,
        depth: 3
    });

    flexSearchUrlIndex = new FlexSearch.Document({
        document: {
            id: 'id',
            index: ['URL1', 'URL2', 'URL3', 'URL4', 'URL5', 'URL6'],
            store: ['Артист']
        },
        tokenize: 'forward',
        resolution: 3,
        threshold: 1,
        depth: 3
    });

    artistsData.forEach((artist, id) => {
        if (artist['Артист']) {
            flexSearchIndex.add({
                id: id,
                Артист: artist['Артист']
            });

            const urls = {};
            ['URL1', 'URL2', 'URL3', 'URL4', 'URL5', 'URL6'].forEach(urlKey => {
                if (artist[urlKey]) {
                    urls[urlKey] = normalizeUrl(artist[urlKey]);
                }
            });

            if (Object.keys(urls).length > 0) {
                flexSearchUrlIndex.add({
                    id: id,
                    ...urls
                });
            }
            artists[id] = artist;
        }
    });
}

function normalizeUrl(url) {
    const urlParts = url.match(/(?:https?:\/\/)?(?:open.spotify.com\/artist\/)?([^?]+)/);
    return urlParts ? urlParts[1] : url;
}

function filterArtistsByName(query) {
    requestAnimationFrame(() => {
        let searchResults = [];
        if (query.includes("spotify.com")) {
            searchResults.push(...flexSearchUrlIndex.search(normalizeUrl(query)));
        } else {
            const transliteratedQuery = transliterate(query);
            const fixedKeyboardQuery = fixKeyboardLayout(query);

            searchResults.push(...flexSearchIndex.search(query));
            if (transliteratedQuery !== query) {
                searchResults.push(...flexSearchIndex.search(transliteratedQuery));
            }
            if (fixedKeyboardQuery !== query) {
                searchResults.push(...flexSearchIndex.search(fixedKeyboardQuery));
            }
        }

        const uniqueResults = Array.from(new Set(searchResults.flat().map(result => result.result).flat()));

        const filteredArtists = uniqueResults.map(id => artists[id]);

        const noArtistsNameMessage = document.getElementById('no-artists-name-message');
        noArtistsNameMessage.style.display = 'none';

        if (filteredArtists.length === 0) {
            document.getElementById('no-artists-message').style.display = 'none';
            noArtistsNameMessage.style.display = 'block';
        } else {
            document.getElementById('no-artists-message').style.display = 'none';
            noArtistsNameMessage.style.display = 'none';
        }

        displayArtists(filteredArtists, true);
        updateArtistCounter(filteredArtists.length);
        updateFilterTags();
    });
}

function updateArtistCounter(count) {
    document.getElementById('artist-count').textContent = formatNumber(count);
}

function resetProgressBars() {
    document.querySelectorAll('.progress-bar').forEach(bar => {
        bar.style.width = '0%';
    });
}
  
document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.controls').addEventListener('click', event => {
        const target = event.target.closest('button');
        if (target.classList.contains('prev-track') || target.classList.contains('next-track')) {
            const change = target.classList.contains('next-track') ? 1 : -1;
            playTrackPreview(currentPlayingId, change);
        }
    });

    updateFilterTags();
});

let trackIndices = new Map();
let currentAudio = null;
let currentPlayingId = null;
let isPlaying = false;
let currentArtistName = '';

function updatePlayerArtistName(name, url) {
    const artistNameElement = document.getElementById('player-artist-name');
    if (artistNameElement) {
        artistNameElement.textContent = name;
        artistNameElement.href = url;
    }
}

function updateTrackButtons(trackIndex, trackLength) {
    const prevTrackButton = document.querySelector('.prev-track');
    const nextTrackButton = document.querySelector('.next-track');

    prevTrackButton.disabled = trackIndex === 0;
    nextTrackButton.disabled = trackIndex === trackLength - 1;

    prevTrackButton.style.opacity = trackIndex === 0 ? 0.5 : 1;
    nextTrackButton.style.opacity = trackIndex === trackLength - 1 ? 0.5 : 1;
}

function updatePlayIcon(artistId) {
    document.querySelectorAll('.play-icon i').forEach(icon => {
        const parent = icon.closest('.artist');
        const imgElement = parent.querySelector('img');
        if (imgElement.getAttribute('data-spotify-id') === artistId) {
            icon.classList.remove('fa-circle-play');
            icon.classList.add('fa-circle-stop');
            imgElement.classList.add('playing');
            currentPlayingId = artistId;
        } else {
            icon.classList.remove('fa-circle-stop');
            icon.classList.add('fa-circle-play');
            imgElement.classList.remove('playing');
        }
    });
}

function showPlayerContainer() {
    const playerWrapper = document.getElementById('player-wrapper');
    const playerContainer = document.getElementById('player-container');
    if (playerWrapper && playerContainer) {
        playerWrapper.classList.add('show');
        playerContainer.classList.add('show');
    }
}

function hidePlayerContainer() {
    const playerWrapper = document.getElementById('player-wrapper');
    const playerContainer = document.getElementById('player-container');
    if (playerWrapper && playerContainer) {
        playerWrapper.classList.remove('show');
        playerContainer.classList.remove('show');
    }
}

document.getElementById('close-player').addEventListener('click', () => {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.src = "";
        currentAudio.load();
        currentAudio = null;
    }
    currentPlayingId = null;
    trackIndices.clear();
    hidePlayerContainer();
    updatePlayIcon(null);
});

async function playTrackPreview(artistId, change = 0) {
    const volumeSlider = document.getElementById('volume-slider');
    volumeSlider.style.display = 'none';

    if (isPlaying) return;

    isPlaying = true;

    let trackIndex = trackIndices.get(artistId) || 0;
    trackIndex += change;

    if (currentAudio) {
        currentAudio.pause();
        currentAudio.src = "";
        currentAudio.load();
        currentAudio = null;
    }

    if (change === 0 && currentPlayingId === artistId) {
        resetPlayer();
        return;
    }

    currentPlayingId = artistId;
    trackIndices.set(artistId, trackIndex);

    clearMessages(artistId);

    let tracksToPlay = getTracksToPlay(artistId);

    if (tracksToPlay.length === 0 && document.getElementById('play-latest').checked) {
        showNoRecentTracksMessage(artistId);
        tracksToPlay = await fetchTopTracks(artistId);
    }

    if (tracksToPlay.length === 0) {
        if (!document.getElementById('play-latest').checked) {
            tracksToPlay = await fetchTopTracks(artistId);
        }
        if (tracksToPlay.length === 0) {
            showNoTracksMessage(artistId);
            isPlaying = false;
            return;
        }
    }

    trackIndex = (trackIndex % tracksToPlay.length + tracksToPlay.length) % tracksToPlay.length;

    let trackPlayed = false;
    const initialTrackIndex = trackIndex;

    while (!trackPlayed && tracksToPlay.length > 0) {
        const track = tracksToPlay[trackIndex];

        try {
            await playAudio(track);
            updateUIForNewTrack(trackIndex, tracksToPlay.length, artistId);
            trackPlayed = true;
        } catch (error) {
            trackIndex = (trackIndex + 1) % tracksToPlay.length;

            if (trackIndex === initialTrackIndex) {
                showNoTracksMessage(artistId);
                isPlaying = false;
                return;
            }
        }
    }

    isPlaying = false;
}

function resetPlayer() {
    currentPlayingId = null;
    hidePlayerContainer();
    updatePlayIcon(null);
    isPlaying = false;
}

function clearMessages(artistId) {
    const artistElement = document.querySelector(`[data-spotify-id="${artistId}"]`);
    const noTracksMessage = artistElement.closest('.artist').querySelector('.no-tracks-message');
    const noRecentTracksMessage = artistElement.closest('.artist').querySelector('.no-recent-tracks-message');

    if (noTracksMessage) noTracksMessage.style.display = 'none';
    if (noRecentTracksMessage) noRecentTracksMessage.style.display = 'none';
}

function getTracksToPlay(artistId) {
    if (document.getElementById('play-latest').checked) {
        const filteredTracks = tracksData.filter(track => {
            const artistUrls = [
                track.artist,
                track.artist2,
                track.artist3,
                track.artist4,
                track.artist5,
                track.artist6,
                track.artist7,
                track.artist8,
                track.artist9,
                track.artist10,
                track.artist11,
                track.artist12,
                track.artist13,
                track.artist14,
                track.artist15,
                track.artist16,
                track.artist17,
                track.artist18,
                track.artist19,
                track.artist20,
                track.artist21,
                track.artist22,
                track.artist23,
                track.artist24,
            ];
            return artistUrls.includes(artistId);
        }).sort((a, b) => parseDate(b.date) - parseDate(a.date));
        return filteredTracks;
    }
    return [];
}


async function fetchTopTracks(artistId) {
    const response = await fetch(`https://api.spotify.com/v1/artists/${artistId}/top-tracks?market=UA`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
    });

    if (!response.ok) return [];

    const data = await response.json();
    return data.tracks || [];
}

function showNoTracksMessage(artistId) {
    const artistElement = document.querySelector(`[data-spotify-id="${artistId}"]`);
    const noTracksMessage = artistElement.closest('.artist').querySelector('.no-tracks-message');
    if (noTracksMessage) noTracksMessage.style.display = 'block';
}

function showNoRecentTracksMessage(artistId) {
    const artistElement = document.querySelector(`[data-spotify-id="${artistId}"]`);
    const noRecentTracksMessage = artistElement.closest('.artist').querySelector('.no-recent-tracks-message');
    if (noRecentTracksMessage) noRecentTracksMessage.style.display = 'block';
}

function updateUIForNewTrack(trackIndex, trackLength, artistId) {
    const artistElement = document.querySelector(`[data-spotify-id="${artistId}"]`);
    const artistName = artistElement.closest('.artist').querySelector('a.track-artist-name').textContent;
    const artistUrl = artistElement.closest('.artist').querySelector('a.track-artist-name').href;
    updatePlayerArtistName(artistName, artistUrl);
    showPlayerContainer();
    updateTrackButtons(trackIndex, trackLength);
    updatePlayIcon(artistId);
}

async function playAudio(track) {
    const previewUrl = track.preview || track.preview_url;
    if (previewUrl && previewUrl !== "Preview not found") {
        currentAudio = new Audio(previewUrl);
        await currentAudio.play();

        currentAudio.addEventListener('timeupdate', () => {
            if (currentAudio) {
                updateProgress(currentPlayingId, currentAudio.currentTime / currentAudio.duration);
            }
        });

        currentAudio.addEventListener('ended', () => {
            isPlaying = false;
            updatePlayIcon(null);
            playTrackPreview(currentPlayingId, 1);
        });

        currentAudio.oncanplaythrough = () => {
            isPlaying = false;
        };
    } else {
        throw new Error('No preview URL');
    }
}

function updateUI(artistId, reset, trackIndex = 0, trackLength = 0) {
    const controls = document.querySelector('.controls');
    const progressBarContainer = controls.querySelector('.progress-bar-container');
    const prevTrackButton = controls.querySelector('.prev-track');
    const nextTrackButton = controls.querySelector('.next-track');

    if (reset) {
        progressBarContainer.style.display = 'none';
        prevTrackButton.style.display = 'none';
        nextTrackButton.style.display = 'none';
    } else {
        progressBarContainer.style.display = 'block';
        prevTrackButton.style.display = 'block';
        nextTrackButton.style.display = 'block';
        prevTrackButton.disabled = trackIndex === 0;
        nextTrackButton.disabled = trackIndex === trackLength - 1;
    }
}

function updateProgress(artistId, progress) {
    const progressBar = document.querySelector('.controls .progress-bar');
    if (progressBar) {
        progressBar.style.width = `${progress * 100}%`;
    }
}

let currentSortCriteria = null;
let currentSortOrder = 'asc';

function sortArtistsHandler(criteria, order) {
    currentSortCriteria = criteria;
    currentSortOrder = order;
    isSortActive = true;
    
    const searchQuery = document.getElementById('artist-search').value.trim();
    if (searchQuery) {
        document.getElementById('artist-search').value = '';
        document.getElementById('clear-search').style.display = 'none';
        updateFilterTags();
    }

    updateArtistsDisplay();
  updateGenreUIState();
    updateSortMenu(criteria, order);
    updateArtistCounter(currentDisplayList.length);
  updateGenreCounts();
}

function sortArtists(artists, criteria, order) {
    if (!Array.isArray(artists)) {
        return artists;
    }

    artists.sort((a, b) => {
        let valueA, valueB;
        switch (criteria) {
            case 'listeners':
                valueA = parseInt(a[Object.keys(a)[listenerColumns.currentMonthIndex]]) || 0;
                valueB = parseInt(b[Object.keys(b)[listenerColumns.currentMonthIndex]]) || 0;
                break;
            case 'growth':
                const diffA = (parseInt(a[Object.keys(a)[listenerColumns.currentMonthIndex]]) || 0) - (parseInt(a[Object.keys(a)[listenerColumns.previousMonthIndex]]) || 0);
                const diffB = (parseInt(b[Object.keys(b)[listenerColumns.currentMonthIndex]]) || 0) - (parseInt(b[Object.keys(b)[listenerColumns.previousMonthIndex]]) || 0);
                valueA = diffA;
                valueB = diffB;
                break;
            case 'date':
                valueA = a['Дата додавання'] ? parseDate(a['Дата додавання']) : new Date(0);
                valueB = b['Дата додавання'] ? parseDate(b['Дата додавання']) : new Date(0);
                break;
            case 'lastReleaseDate':
                valueA = a['LastRelDate'] ? parseDate(a['LastRelDate']) : new Date(0);
                valueB = b['LastRelDate'] ? parseDate(b['LastRelDate']) : new Date(0);
                break;
            case 'name':
                valueA = a['Артист'].toLowerCase();
                valueB = b['Артист'].toLowerCase();
                return valueA.localeCompare(valueB, 'uk', { sensitivity: 'base' }) * (order === 'asc' ? 1 : -1);
            default:
                return 0;
        }

        if (order === 'asc') {
            return valueA < valueB ? 1 : -1;
        } else {
            return valueA > valueB ? 1 : -1;
        }
    });

    if (criteria === 'date' || criteria === 'lastReleaseDate') {
        artists = artists.filter(artist => artist['Дата додавання'] || artist['LastRelDate']).concat(artists.filter(artist => !artist['Дата додавання'] && !artist['LastRelDate']));
    }

    return artists;
}

function parseDate(dateString) {
    const [day, month, year] = dateString.split('.').map(Number);
    return new Date(year, month - 1, day);
}

function updateSortMenu(selectedCriteria, selectedOrder) {
    const sortMenu = document.getElementById('sort-menu');
    const sortOptions = sortMenu.querySelectorAll('.sort-option');

    sortOptions.forEach(option => {
        const span = option.querySelector('span');
        const upButton = option.querySelector('button:nth-of-type(2)');
        const downButton = option.querySelector('button:nth-of-type(3)');
        const clearButton = option.querySelector('.clear-sort');

        upButton.classList.remove('active');
        downButton.classList.remove('active');

        if ((span.textContent.includes('За кількістю слухачів на місяць') && selectedCriteria === 'listeners') ||
            (span.textContent.includes('За приростом слухачів') && selectedCriteria === 'growth') ||
            (span.textContent.includes('За датою додавання до бази') && selectedCriteria === 'date') ||
            (span.textContent.includes('За датою крайнього релізу') && selectedCriteria === 'lastReleaseDate') ||
            (span.textContent.includes('За іменем артиста') && selectedCriteria === 'name')) {
            option.classList.add('active-sort');
            if (selectedOrder === 'asc') {
                upButton.classList.add('active');
            } else {
                downButton.classList.add('active');
            }
        } else {
            option.classList.remove('active-sort');
        }
    });
}

function clearSort() {
    currentSortCriteria = null;
    currentSortOrder = 'asc';
    isSortActive = false;
    updateArtistsDisplay();
    currentDisplayList = applyFilters(originalArtistsOrder, minListeners, maxListeners);
    displayArtists(currentDisplayList, true);
    updateArtistCounter(currentDisplayList.length);
    updateFilterTags();

    const sortMenu = document.getElementById('sort-menu');
    const sortOptions = sortMenu.querySelectorAll('.sort-option');
    sortOptions.forEach(option => {
        option.classList.remove('active-sort');
        const upButton = option.querySelector('button:nth-of-type(2)');
        const downButton = option.querySelector('button:nth-of-type(3)');
        upButton.classList.remove('active');
        downButton.classList.remove('active');
    });
}

  document.addEventListener('DOMContentLoaded', function() {
    const genresContainer = document.getElementById('genres-container');

    genresContainer.addEventListener('mouseenter', function(event) {
        if (event.target.classList.contains('remove-genre')) {
            event.target.closest('.genre-button').classList.add('red-shadow');
        }
    }, true);

    genresContainer.addEventListener('mouseleave', function(event) {
        if (event.target.classList.contains('remove-genre')) {
            event.target.closest('.genre-button').classList.remove('red-shadow');
        }
    }, true);
});

let minListeners = 0;
let maxListeners = Infinity;

function setupRangeSlider(maxListenersValue) {
    const rangeSlider = document.getElementById('listeners-range');
    const rangeLabel = document.getElementById('range-value');

    if (rangeSlider.noUiSlider) {
        rangeSlider.noUiSlider.destroy();
    }

    function linearToLog(value) {
        const minLog = 0;
        const maxLog = Math.log10(maxListenersValue + 1);
        const scaleFactor = 0.7;
        return Math.pow(10, minLog + (maxLog - minLog) * Math.pow(value / 100, scaleFactor)) - 1;
    }

    function logToLinear(value) {
        const minLog = 0;
        const maxLog = Math.log10(maxListenersValue + 1);
        const scaleFactor = 0.7;
        return Math.pow((Math.log10(value + 1) - minLog) / (maxLog - minLog), 1 / scaleFactor) * 100;
    }

    noUiSlider.create(rangeSlider, {
        start: [0, 100],
        connect: true,
        range: {
            'min': 0,
            'max': 100
        },
        step: 0.1
    });

    rangeSlider.noUiSlider.on('update', function(values, handle) {
        let newMinListeners = Math.round(linearToLog(values[0]));
        let newMaxListeners = Math.round(linearToLog(values[1]));

        if (newMinListeners < 0) {
            newMinListeners = 0;
        }

        if (newMinListeners > newMaxListeners) {
            if (handle === 0) {
                rangeSlider.noUiSlider.set([values[0], values[0]]);
                newMaxListeners = newMinListeners;
            } else {
                rangeSlider.noUiSlider.set([values[1], values[1]]);
                newMinListeners = newMaxListeners;
            }
        }

        minListeners = newMinListeners;
        maxListeners = newMaxListeners;

        rangeLabel.innerHTML = `${formatNumber(minListeners)} - ${formatNumber(maxListeners)}`;

        const searchQuery = document.getElementById('artist-search').value.trim();
        if (searchQuery) {
            document.getElementById('artist-search').value = '';
            document.getElementById('clear-search').style.display = 'none';
            updateFilterTags();
        }

        updateArtistsDisplay(minListeners, maxListeners);
    });

    rangeSlider.noUiSlider.set([0, 100]);
}

  function scrollHandler() {
    const container = document.getElementById('artist-scroll-container');
    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 10) {
        displayArtists(currentDisplayList);
    }
}

function allImagesLoaded() {
    const images = document.querySelectorAll('.artist img');
    const totalImages = images.length;
    let loadedImages = 0;

    return new Promise((resolve) => {
        if (totalImages === 0) {
            resolve();
        }
        images.forEach((img) => {
            if (img.complete && img.naturalHeight !== 0) {
                loadedImages++;
                if (loadedImages === totalImages) {
                    resolve();
                }
            } else {
                img.onload = () => {
                    loadedImages++;
                    if (loadedImages === totalImages) {
                        resolve();
                    }
                };
                img.onerror = () => {
                    loadedImages++;
                    if (loadedImages === totalImages) {
                        resolve();
                    }
                };
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const loadingScreen = document.getElementById('loading-screen');

    getAccessToken().then(() => {
        fetchArtists().then(() => {
            const maxListeners = Math.max(...artistsData.map(artist => parseInt(artist[Object.keys(artist)[listenerColumns.currentMonthIndex]]) || 0));
            setupRangeSlider(maxListeners);
            collectAllArtistURLs(artistsData);
            updateArtistsDisplay();

            const observer = new MutationObserver(() => {
                allImagesLoaded().then(() => {
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        loadingScreen.style.visibility = 'hidden';
                    }, 100);
                });
            });

            const artistContainer = document.querySelector('.artist-container');
            if (artistContainer) {
                observer.observe(artistContainer, { childList: true, subtree: true });
            }

            const hideRussianCheckbox = document.getElementById('hide-russian');

            if (hideRussianCheckbox) {
                hideRussian = hideRussianCheckbox.checked;
            }

            updateArtistsDisplay();
            updateFilterTags();
            sortArtistsHandler('lastReleaseDate', 'asc');
        });
    });

    loadingScreen.addEventListener('transitionend', (event) => {
        if (event.propertyName === 'opacity') {
            setTimeout(() => {
                loadingScreen.remove();
            }, 500);
        }
    });

    const searchInput = document.getElementById('artist-search');
    const clearSearchBtn = document.getElementById('clear-search');
    const hideRussianCheckbox = document.getElementById('hide-russian');

    if (hideRussianCheckbox) {
        hideRussianCheckbox.addEventListener('change', function() {
            hideRussian = this.checked;
            updateArtistsDisplay();
            updateFilterTags();
        });
    }

    let searchTimeout;

    if (searchInput && clearSearchBtn && hideRussianCheckbox) {
        searchInput.addEventListener('input', function() {
            const searchQuery = this.value.trim();

            if (searchQuery.length >= 3) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    requestAnimationFrame(() => {
                        filterArtistsByName(searchQuery);
                        clearSearchBtn.style.display = 'block';
                        selectedGenres = [];
                        removedGenres = [];
                   
                        updateFilterTags();
                    });
                }, 300);
            } else if (searchQuery.length === 0) {
                clearTimeout(searchTimeout);
                clearSearchBtn.style.display = 'none';
                selectedGenres = [];
                removedGenres = [];
              
                requestAnimationFrame(() => {
                    currentDisplayList = applyFilters(originalArtistsOrder);
                    displayArtists(currentDisplayList, true);
                    updateArtistCounter(currentDisplayList.length);
                    updateFilterTags();
                });
            } else {
                clearTimeout(searchTimeout);
                clearSearchBtn.style.display = 'none';
            }
        });

        clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    clearSearchBtn.style.display = 'none';
    selectedGenres = [];
    removedGenres = [];
    hideRussian = document.getElementById('hide-russian').checked;

    requestAnimationFrame(() => {
        currentDisplayList = applyFilters(originalArtistsOrder);
        displayArtists(currentDisplayList, true);
        updateArtistCounter(currentDisplayList.length);
        updateFilterTags();
        sortArtistsHandler('lastReleaseDate', 'asc');
    });
        });

        hideRussianCheckbox.addEventListener('change', function() {
            hideRussian = this.checked;
            searchInput.value = '';
            clearSearchBtn.style.display = 'none';
        });
    }

    document.querySelector('.controls').addEventListener('click', event => {
        const target = event.target.closest('button');
        if (target.classList.contains('prev-track') || target.classList.contains('next-track')) {
            const change = target.classList.contains('next-track') ? 1 : -1;
            playTrackPreview(currentPlayingId, change);
        }
    });

    updateFilterTags();
    const trackButtons = document.querySelector('.track-buttons');
    const artistNameElement = document.createElement('a');
    artistNameElement.id = 'player-artist-name';
    artistNameElement.href = '#';
    artistNameElement.target = '_blank';
    artistNameElement.className = 'track-artist-name';
    trackButtons.parentNode.insertBefore(artistNameElement, trackButtons.nextSibling);
    hidePlayerContainer();

    const artistScrollContainer = document.getElementById('artist-scroll-container');
    const genresSection = document.getElementById('genres-section');
    const sortSection = document.getElementById('sort-section');
    const filtersSection = document.getElementById('filters-section');
    const genreButton = document.getElementById('genre-button');
    const sortButton = document.getElementById('sort-button');
    const filtersButton = document.getElementById('filters-button');

    function collapseSections(exceptSection) {
        if (exceptSection !== genresSection && genresSection.classList.contains('expanded')) {
            genresSection.style.maxHeight = '0px';
            genresSection.classList.remove('expanded');
            genreButton.setAttribute('aria-expanded', 'false');
            genreButton.classList.remove('active');
        }
        if (exceptSection !== sortSection && sortSection.classList.contains('expanded')) {
            sortSection.style.maxHeight = '0px';
            sortSection.classList.remove('expanded');
            sortButton.setAttribute('aria-expanded', 'false');
            sortButton.classList.remove('active');
        }
        if (exceptSection !== filtersSection && filtersSection.classList.contains('expanded')) {
            filtersSection.style.maxHeight = '0px';
            filtersSection.classList.remove('expanded');
            filtersButton.setAttribute('aria-expanded', 'false');
            filtersButton.classList.remove('active');
        }
    }

    artistScrollContainer.addEventListener('scroll', () => {
        collapseSections();
    });

    function toggleSection(button, section) {
        const isExpanded = section.classList.contains('expanded');

        button.setAttribute('aria-expanded', !isExpanded);
        section.setAttribute('aria-hidden', isExpanded);

        if (isExpanded) {
            section.style.maxHeight = '0';
            section.classList.remove('expanded');
        } else {
            section.style.maxHeight = section.scrollHeight + 'px';
            section.classList.add('expanded');
        }

        if (!isExpanded) {
            button.classList.add('active');
            collapseSections(section);
        } else {
            button.classList.remove('active');
        }
    }

    if (genreButton) {
        genreButton.addEventListener('click', () => {
            toggleSection(genreButton, genresSection);
        });
    }

    if (sortButton) {
        sortButton.addEventListener('click', () => {
            toggleSection(sortButton, sortSection);
        });
    }

    if (filtersButton) {
        filtersButton.addEventListener('click', () => {
            toggleSection(filtersButton, filtersSection);
        });
    }

    genresSection.style.maxHeight = '0';
    sortSection.style.maxHeight = '0';
    filtersSection.style.maxHeight = '0';
});
 
document.addEventListener('DOMContentLoaded', () => {
    const volumeControl = document.getElementById('volume-control');

    noUiSlider.create(volumeControl, {
        start: 65,
        orientation: 'vertical',
        direction: 'rtl',
        range: {
            'min': 0,
            'max': 100
        }
    });

    const setVolume = (value) => {
        const volume = value / 100;
        if (currentAudio) {
            currentAudio.volume = volume;
        }
    };

    volumeControl.noUiSlider.on('update', (values, handle) => {
        setVolume(values[handle]);
    });

    const volumeIcon = document.getElementById('volume-icon');
    const volumeSlider = document.getElementById('volume-slider');

    volumeIcon.addEventListener('click', (event) => {
        event.stopPropagation();
        if (volumeSlider.style.display === 'none' || volumeSlider.style.display === '') {
            volumeSlider.style.display = 'block';
        } else {
            volumeSlider.style.display = 'none';
        }
    });

    document.addEventListener('click', (event) => {
        if (!volumeIcon.contains(event.target) && !volumeSlider.contains(event.target)) {
            volumeSlider.style.display = 'none';
        }
    });

    volumeSlider.addEventListener('click', (event) => {
        event.stopPropagation();
    });

    const originalPlayTrackPreview = playTrackPreview;
    playTrackPreview = async function(artistId, change = 0) {
        await originalPlayTrackPreview(artistId, change);
        if (currentAudio) {
            currentAudio.volume = volumeControl.noUiSlider.get() / 100;
        }
    };

    const playerWrapper = document.getElementById('player-wrapper');

    volumeIcon.style.display = 'none';
    volumeSlider.style.display = 'none';

    const observer = new MutationObserver(() => {
        if (playerWrapper.classList.contains('show')) {
            volumeIcon.style.display = 'block';
        } else {
            volumeIcon.style.display = 'none';
            volumeSlider.style.display = 'none';
        }
    });

    observer.observe(playerWrapper, { attributes: true, attributeFilter: ['class'] });
});

  document.addEventListener('DOMContentLoaded', function() {
    function disableScroll() {
        const artistScrollContainer = document.getElementById('artist-scroll-container');
        if (artistScrollContainer) {
            artistScrollContainer.style.overflow = 'hidden';
        }
    }

    function enableScroll() {
        const artistScrollContainer = document.getElementById('artist-scroll-container');
        if (artistScrollContainer) {
            artistScrollContainer.style.overflow = '';
        }
    }

    function startIntro(showDontShowAgain) {
    if (window.innerWidth <= 768) {
        return;
    }

    const intro = introJs.tour();

    const options = {
        steps: [
            {
                intro: '<h2>Вітаємо в NUAM Base!</h2><p>Це найбільша і постійно зростаюча база українських артистів, що містить понад 10 000 імен. Досліджуйте музичну сцену України, використовуючи широкі можливості для пошуку. </p>',
                disableInteraction: true
            },
            {
                element: document.querySelector('#buttons-wrapper'),
                intro: 'Це основні вкладки для детального пошуку. Використовуйте їх, щоб не загубитися серед тисяч артистів.',
                disableInteraction: true
            },
            {
                element: document.querySelector('#genres-section'),
                intro: 'Виберіть один або кілька жанрів, щоб відобразити артистів, які відповідають усім обраним категоріям. Число поруч із кожною категорією показує кількість артистів у ній.<br/><br/>При виборі жанру інші категорії будуть оновлені, показуючи тільки доступні комбінації. Ви також можете виключати жанри, щоб прибрати артистів з небажаними стилями.<br/><br/>Зніміть галочку з «Відповідність усім обраним жанрам», щоб побачити всіх артистів, які мають хоча б один з обраних стилів.',
                position: 'bottom',
                tooltipClass: 'customTooltip rangeTooltip',
                disableInteraction: true
            },
            {
                element: document.querySelector('#sort-section'),
                intro: 'Тут можна вибрати режим сортування списку артистів. Ви можете підняти вгору тих, кого найчастіше слухають, або впорядкувати їх за темпом зростання кількості нових слухачів.<br/><br/>За замовчуванням активне сортування за датою останнього релізу — вгорі ви побачите артистів, у яких сьогодні або вчора вийшли нові треки.<br/><br/>Також тут можна легко відстежувати нових доданих артистів до бази — просто застосуйте сортування «За датою додавання до бази».',
                position: 'bottom',
                tooltipClass: 'customTooltip rangeTooltip',
                disableInteraction: true
            },
            {
                element: document.querySelector('#filters-section'),
                intro: 'Тут ви можете виключити зі списку неактивних артистів, які не мали релізів у поточному році, або тих, хто має лише один реліз за весь час. Ви також можете залишити у списку лише дебютантів поточного року. Артисти з російськомовними піснями, реліз яких відбувся з початку 2024 року, виключені зі списку за замовчуванням.',
                position: 'bottom',
                tooltipClass: 'customTooltip rangeTooltip',
                disableInteraction: true
            },
            {
                element: document.querySelector('#range-container'),
                intro: 'Ще один важливий параметр для дослідження — можливість відфільтрувати артистів за діапазоном слухачів на місяць. Станьте одним із перших, хто послухає трек артиста, встановивши повзунок на 0-10 слухачів. Цікавить середня сцена? Оберіть, наприклад, від 5000 до 20 000 слухачів. Або ж виведіть у список найпопулярніших артистів, вибравши високі значення.<br/><br/>Цей повзунок працює спільно з обраними жанрами і фільтрами.',
                position: 'bottom',
                tooltipClass: 'customTooltip rangeTooltip',
                disableInteraction: true
            },
            {
                element: document.querySelector('.artist-container .artist:first-child'),
                intro: 'Це картка артиста. Ви можете слухати уривки треків для швидкого ознайомлення. За замовчуванням грають найновіші треки артиста — ви можете зняти в налаштуваннях відповідну галочку, щоб слухати найпопулярніші треки.<br/><br/>Наведіть на картку і натисніть «Схожі артисти», щоб побачити тих, кого часто слухають разом із цим виконавцем. У цьому списку будуть виключно українські музиканти.<br/><br/>Під іменем артиста ви можете бачити кількість слухачів на місяць і порівняння цих даних з попереднім місяцем. Ці дані беруться зі Spotify і оновлюються кожного першого числа місяця.<br/><br/>Для артистів, доданих до бази з кінця 2023 року, вказується дата їх додавання. Якщо артист був доданий після першого числа місяця, вказуються дані про кількість слухачів, актуальні на момент додавання.',
                position: 'right',
                disableInteraction: true
            },
            {
                element: document.querySelector('#help-icon'),
                intro: 'Ви в будь-який момент можете повернутися до цієї довідки, натиснувши на цю кнопку.',
                disableInteraction: true
            }
        ],
        showBullets: true,
        showButtons: true,
        exitOnOverlayClick: false,
        exitOnEsc: true,
        tooltipClass: 'customTooltip',
        dontShowAgainCookie: 'nuam-base-dontShowAgain',
        nextLabel: 'Далі',
        prevLabel: 'Назад',
        doneLabel: 'Готово'
    };

    if (showDontShowAgain) {
        options.dontShowAgain = true;
        options.dontShowAgainLabel = 'Більше не показувати цей тур';
    }

    intro.setOptions(options);

    intro.onbeforechange(function(targetElement) {
        const stepIndex = intro._currentStep;
        if (stepIndex === 5) {
            const sortButton = document.querySelector('#sort-button');
            const sortSection = document.querySelector('#sort-section');
            if (sortButton && sortSection && sortSection.getAttribute('aria-hidden') === 'false') {
                sortButton.click();
            }
        }
        if (stepIndex === 6) {
            const filtersButton = document.querySelector('#filters-button');
            const filtersSection = document.querySelector('#filters-section');
            if (filtersButton && filtersSection && filtersSection.getAttribute('aria-hidden') === 'false') {
                filtersButton.click();
            }
        }
    });

    intro.onchange(function(targetElement) {
        const stepIndex = intro._currentStep;
        if (stepIndex === 6) {
            setTimeout(() => {
                const firstArtist = document.querySelector('.artist-container .artist:first-child');
                if (firstArtist) {
                    intro._options.steps[stepIndex].element = firstArtist;
                    intro.refresh();
                }
            }, 100);
        } else if (stepIndex === 2) {
            const genreButton = document.querySelector('#genre-button');
            if (genreButton && genreButton.getAttribute('aria-expanded') === 'false') {
                genreButton.click();
                const checkGenresLoaded = setInterval(() => {
                    const genresSection = document.querySelector('#genres-section');
                    if (genresSection && genresSection.children.length > 0) {
                        clearInterval(checkGenresLoaded);
                        intro.refresh();
                    }
                }, 600);
            }
        } else if (stepIndex === 3) {
            const sortButton = document.querySelector('#sort-button');
            if (sortButton && sortButton.getAttribute('aria-expanded') === 'false') {
                sortButton.click();
                const checkSortSectionLoaded = setInterval(() => {
                    const sortSection = document.querySelector('#sort-section');
                    if (sortSection && sortSection.children.length > 0) {
                        clearInterval(checkSortSectionLoaded);
                        intro.refresh();
                    }
                }, 600);
            }
        } else if (stepIndex === 4) {
            const filtersButton = document.querySelector('#filters-button');
            if (filtersButton && filtersButton.getAttribute('aria-expanded') === 'false') {
                filtersButton.click();
                const checkFiltersSectionLoaded = setInterval(() => {
                    const filtersSection = document.querySelector('#filters-section');
                    if (filtersSection && filtersSection.children.length > 0) {
                        clearInterval(checkFiltersSectionLoaded);
                        intro.refresh();
                    }
                }, 600);
            }
        } else if (stepIndex === 5) {
            const sortButton = document.querySelector('#sort-button');
            const sortSection = document.querySelector('#sort-section');
            if (sortButton && sortSection && sortSection.getAttribute('aria-hidden') === 'false') {
                sortButton.click();
            }
            setTimeout(() => {
                intro.refresh();
            }, 600);
        }
    });

    intro.onexit(function() {
        enableScroll();
    });

    intro.start();
}

    const loadingScreen = document.getElementById('loading-screen');
    loadingScreen.addEventListener('transitionend', (event) => {
        if (event.propertyName === 'opacity' && loadingScreen.style.opacity === '0') {
            startIntro(true);
        }
    });

    const helpIcon = document.getElementById('help-icon');
    helpIcon.addEventListener('click', function() {
        startIntro(false);
    });
});
  
  document.addEventListener('DOMContentLoaded', () => {
    const gearIcon = document.getElementById('gear-icon');
    const settingsPopup = document.getElementById('settings-popup');
    const openInSpotifyCheckbox = document.getElementById('open-in-spotify');
    const playLatestCheckbox = document.getElementById('play-latest');
    const aboutProjectLink = document.getElementById('about-project');
    const projectPopup = document.getElementById('project-popup');
    const closeBtn = document.querySelector('.close-btn');

    const showPopup = () => {
        if (window.innerWidth > 768) {
            settingsPopup.classList.add('show');
        }
    };

    const hidePopup = () => {
        if (window.innerWidth > 768) {
            if (!gearIcon.matches(':hover') && !settingsPopup.matches(':hover')) {
                settingsPopup.classList.remove('show');
            }
        }
    };

    const togglePopup = () => {
        settingsPopup.classList.toggle('show');
    };

    gearIcon.addEventListener('mouseenter', showPopup);
    gearIcon.addEventListener('mouseleave', () => {
        if (window.innerWidth > 768) {
            setTimeout(hidePopup, 200);
        }
    });

    gearIcon.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            togglePopup();
        }
    });

    document.addEventListener('click', (event) => {
        if (window.innerWidth <= 768) {
            if (!settingsPopup.contains(event.target) && !gearIcon.contains(event.target)) {
                settingsPopup.classList.remove('show');
            }
        }
    });

    settingsPopup.addEventListener('mouseenter', showPopup);
    settingsPopup.addEventListener('mouseleave', () => {
        if (window.innerWidth > 768) {
            setTimeout(hidePopup, 200);
        }
    });

    const updateLinks = () => {
        const links = document.querySelectorAll('.artist a');
        links.forEach(link => {
            if (openInSpotifyCheckbox.checked) {
                if (!link.href.includes('si=nuam')) {
                    link.href += (link.href.includes('?') ? '&' : '?') + 'si=nuam';
                }
            } else {
                link.href = link.href.replace(/(\?|&)si=nuam/, '');
            }
        });
    };

    const savedOpenInSpotify = localStorage.getItem('openInSpotify');
    if (savedOpenInSpotify !== null) {
        openInSpotifyCheckbox.checked = JSON.parse(savedOpenInSpotify);
    }

    const savedPlayLatest = localStorage.getItem('playLatest');
if (savedPlayLatest !== null) {
    playLatestCheckbox.checked = JSON.parse(savedPlayLatest);
} else {
    playLatestCheckbox.checked = true;
    localStorage.setItem('playLatest', true);
}

    updateLinks();

    openInSpotifyCheckbox.addEventListener('change', () => {
        localStorage.setItem('openInSpotify', openInSpotifyCheckbox.checked);
        updateLinks();
    });

    playLatestCheckbox.addEventListener('change', () => {
        localStorage.setItem('playLatest', playLatestCheckbox.checked);
    });

    aboutProjectLink.addEventListener('click', (event) => {
        event.preventDefault();
        projectPopup.style.display = 'block';
    });

    closeBtn.addEventListener('click', () => {
        projectPopup.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target === projectPopup) {
            projectPopup.style.display = 'none';
        }
    });
});

  function isMobile() {
    return window.innerWidth <= 768;
}

  document.addEventListener('DOMContentLoaded', function() {
    const searchIcon = document.getElementById('search-icon');
    const searchContainer = document.getElementById('search-container');
    const artistSearch = document.getElementById('artist-search');
    const clearSearch = document.getElementById('clear-search');

    searchIcon.addEventListener('click', function() {
        searchContainer.classList.toggle('active');
        if (searchContainer.classList.contains('active')) {
            artistSearch.style.display = 'block';
            setTimeout(() => {
                artistSearch.style.opacity = '1';
            }, 10);
            artistSearch.focus();
            clearSearch.style.display = 'inline';
        } else {
            artistSearch.style.opacity = '0';
            setTimeout(() => {
                artistSearch.style.display = 'none';
                searchContainer.classList.remove('active');
                clearSearch.style.display = 'none';
            }, 300);
        }
    });

    artistSearch.addEventListener('input', function() {
        if (artistSearch.value.length > 0) {
            clearSearch.style.display = 'inline';
        } else {
            clearSearch.style.display = 'none';
        }
    });

    clearSearch.addEventListener('click', function() {
        artistSearch.value = '';
        clearSearch.style.display = 'none';

        if (isMobile()) {
            artistSearch.style.opacity = '0';
            setTimeout(() => {
                artistSearch.style.display = 'none';
                searchContainer.classList.remove('active');
            }, 300);
        }
    });
});

function updateGenreUIState() {
    const genreButtons = document.querySelectorAll('.genre-button');

    genreButtons.forEach(button => {
        const genre = button.dataset.genre;
        if (!genre) return;

        const genreCountElement = button.querySelector('.genre-count');

        if (selectedGenres.length === 0 && removedGenres.length === 0) {
            button.classList.remove('gray-out', 'removed', 'selected');
            button.style.pointerEvents = 'auto';

            if (genreCountElement) {
                const originalCount = genreCombinations[genre]?.count || 0;
                genreCountElement.textContent = `(${originalCount})`;
            }
        } else {
            if (selectedGenres.includes(genre)) {
                button.classList.add('selected');
            } else {
                button.classList.remove('selected');
            }

            if (removedGenres.includes(genre)) {
                button.classList.add('removed');
                button.classList.remove('gray-out');
                button.style.pointerEvents = 'auto';
            } else {
                button.classList.remove('removed');
                const count = genreCombinations[genre]?.filterCount || 0;
                if (count === 0 && genre !== 'всі жанри') {
                    button.classList.add('gray-out');
                    button.style.pointerEvents = 'none';
                } else {
                    button.classList.remove('gray-out');
                    button.style.pointerEvents = 'auto';
                }
            }

            if (genreCountElement) {
                genreCountElement.textContent = `(${genreCombinations[genre]?.filterCount || 0})`;
            }
        }
    });

    const allGenresButton = document.querySelector('.genre-button[data-genre="всі жанри"]');
    if (allGenresButton) {
        if (selectedGenres.length === 0 && removedGenres.length === 0) {
            allGenresButton.classList.add('selected');
            allGenresButton.classList.remove('gray-out');
            allGenresButton.style.pointerEvents = 'auto';
        } else {
            allGenresButton.classList.remove('selected');
        }
    }

    updateFilterTags();
}

function toggleGenreSelection(genre) {
    const genreIndex = selectedGenres.indexOf(genre);

    if (genreIndex > -1) {
        selectedGenres.splice(genreIndex, 1);
    } else {
        selectedGenres.push(genre);
    }

    updateArtistsDisplay();
    updateGenreCounts();
    updateGenreUIState();
}

function updateGenreCounts() {
    const genreButtons = document.querySelectorAll('.genre-button');

    genreButtons.forEach(button => {
        const genre = button.dataset.genre;
        if (!genre) return;

        const genreCountElement = button.querySelector('.genre-count');
        if (!genreCountElement) return;

        if (removedGenres.includes(genre)) {
            genreCountElement.textContent = `(0)`;
            button.classList.add('removed');
            return;
        }

        if (!matchAllGenres) {
            return;
        }

        const activeGenres = selectedGenres.filter(g => g !== genre && !removedGenres.includes(g));
        if (activeGenres.length > 0) {
            const combinationKey = [...activeGenres, genre].sort().join(',');
            const count = genreCombinations[combinationKey]?.filterCount || 0;
            genreCountElement.textContent = `(${count})`;
        } else {
            const originalCount = genreCombinations[genre]?.filterCount || 0;
            genreCountElement.textContent = `(${originalCount})`;
        }

        if (genreCountElement.textContent === `(0)`) {
            button.classList.add('gray-out');
            button.style.pointerEvents = 'none';
        } else {
            button.classList.remove('gray-out');
            button.style.pointerEvents = 'auto';
        }
    });
}

function restoreGenre(genre) {
    const index = removedGenres.indexOf(genre);
    if (index > -1) {
        removedGenres.splice(index, 1);

        initializeGenreCombinations(artistsData);
        updateArtistsDisplay();
        updateGenreCounts();
        updateGenreUIState();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('match-all-genres-checkbox').addEventListener('change', function() {
        matchAllGenres = this.checked;
        updateArtistsDisplay();
        updateGenreCounts();
        updateGenreUIState();
    });

    document.querySelectorAll('.genre-button').forEach(button => {
        button.addEventListener('click', function() {
            const genre = button.dataset.genre;
            if (removedGenres.includes(genre)) {
                restoreGenre(genre);
            } else {
                toggleGenreSelection(genre);
            }
        });
    });

    document.querySelectorAll('.remove-genre').forEach(removeButton => {
        removeButton.addEventListener('click', function(event) {
            event.stopPropagation();

            const genreButton = removeButton.closest('.genre-button');
            const genre = genreButton.dataset.genre;

            if (genre === 'pop' && !removedGenres.includes(genre)) {
                removeGenreAndLog(genre);
            } else if (!removedGenres.includes(genre)) {
                removedGenres.push(genre);
                selectedGenres = selectedGenres.filter(g => g !== genre);

                initializeGenreCombinations(artistsData);

                updateArtistsDisplay();
                updateGenreCounts();
                updateGenreUIState();
            }
        });
    });

    initializeGenreCombinations(artistsData);
    updateGenreUIState();
    updateGenreCounts();
});

document.addEventListener('DOMContentLoaded', () => {
    function enforceGrayOutForZeroArtists() {
        const genreButtons = document.querySelectorAll('.genre-button');
        genreButtons.forEach(button => {
            if (button.classList.contains('removed')) return;

            const genreCountElement = button.querySelector('.genre-count');
            if (!genreCountElement) return;
            
            const count = parseInt(genreCountElement.textContent.replace(/[()]/g, ''), 10);
            if (count === 0 && !button.classList.contains('gray-out')) {
                button.classList.add('gray-out');
                button.style.pointerEvents = 'none';
            }
        });
    }

    const genresContainer = document.getElementById('genres-container');
    if (genresContainer) {
        const observer = new MutationObserver(enforceGrayOutForZeroArtists);

        observer.observe(genresContainer, { childList: true, subtree: true, attributes: true, characterData: true });

        enforceGrayOutForZeroArtists();
    }
});
  
  function updateGenreCountsForFiltersOnly() {
    const genreButtons = document.querySelectorAll('.genre-button');

    genreButtons.forEach(button => {
        const genre = button.dataset.genre;
        if (!genre) return;

        const genreCountElement = button.querySelector('.genre-count');
        if (!genreCountElement) return;

        if (removedGenres.includes(genre)) {
            genreCountElement.textContent = `(0)`;
            button.classList.add('removed');
            return;
        }

        const filteredArtists = artistsData.filter(artist => {
            const artistGenres = artist['Жанр'].split(', ');
            const matchesGenre = artistGenres.includes(genre);

            const matchesFilters = (!filterYearRel || artist['YearRel'] === '+') &&
                                   (!filterMultiRel || artist['MultiRel'] === '+') &&
                                   (!filterDebut || artist['Debut'] === '+') &&
                                   (!hideRussian || !artist['RuLang']);

            return matchesGenre && matchesFilters;
        });

        const genreCount = filteredArtists.length;
        genreCountElement.textContent = `(${genreCount})`;

        if (genreCount === 0) {
            button.classList.add('gray-out');
            button.style.pointerEvents = 'none';
        } else {
            button.classList.remove('gray-out');
            button.style.pointerEvents = 'auto';
        }
    });

    const artistCountElement = document.getElementById('artist-count');
    if (artistCountElement) {
        const artistCount = currentDisplayList.length;
        artistCountElement.textContent = formatNumber(artistCount);
    }
}

function handleCheckboxChange() {
    updateArtistsDisplay();
    updateGenreCounts();
}

document.addEventListener('DOMContentLoaded', () => {
    const matchAllGenresCheckbox = document.getElementById('match-all-genres-checkbox');
    if (matchAllGenresCheckbox) {
        matchAllGenresCheckbox.addEventListener('change', handleCheckboxChange);
    }
});

const observer = new MutationObserver(() => {
    updateGenreCounts();
});

const genreContainer = document.getElementById('genres-container');
if (genreContainer) {
    observer.observe(genreContainer, { childList: true, subtree: true });
}
 
  document.addEventListener('DOMContentLoaded', function() {
    async function waitForArtistsData() {
        while (!artistsData || artistsData.length === 0) {
            console.log("Ожидание загрузки данных артистов...");
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        console.log("Данные артистов загружены.");
    }

    function getGenreFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const genre = urlParams.get('genre');
        if (genre) {
            console.log(`Найден жанр в URL: ${genre}`);
        } else {
            console.log("Параметр 'genre' в URL не найден.");
        }
        return genre;
    }

    function selectGenre(genre) {
        const genreButtons = document.querySelectorAll('.genre-button');
        let genreFound = false;

        genreButtons.forEach(button => {
            if (button.dataset.genre.toLowerCase() === genre.toLowerCase()) {
                console.log(`Жанр "${genre}" найден, имитация нажатия кнопки.`);
                genreFound = true;

                selectedGenres = [genre];
                removedGenres = [];
                initializeGenreCombinations(artistsData);
                updateArtistsDisplay();
                updateGenreCounts();
                updateGenreUIState();
            }
        });

        if (!genreFound) {
            console.log(`Кнопка с жанром "${genre}" не найдена.`);
        }
    }

    async function initializeAppWithGenre() {
        await waitForArtistsData();
        const genreFromURL = getGenreFromURL();
        if (genreFromURL) {
            selectGenre(genreFromURL);
        }
    }

    initializeAppWithGenre();
});


  
</script>
</body>
</html>
